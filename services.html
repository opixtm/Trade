<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOSHAX</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --main-bg: #010f1c;
            --card-bg: rgba(3, 24, 47, 0.7);
            --accent-color: #ab7d00;
            --accent-hover-color: #a79f00;
            --positive-color: #4CAF50;
            --negative-color: #F44336;
            --warning-color: #ffc107;
            --text-color: #e0e0e0;
            --secondary-text-color: #a0a0a0;
            --border-color: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: normal; /* <-- UBAH SELURUH FONT KE NORMAL */
        }

        body {
            background: linear-gradient(135deg, var(--main-bg) 0%, #000000 100%);
            color: var(--text-color);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            width: 100%;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: var(--card-bg);
            border-radius: 12px;
            backdrop-filter: blur(8px);
            box-shadow: 0 8px 32px 0 rgba(32, 105, 132, 0.476);
        }

        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            color: #d4cb88;
            text-shadow: 0 0 15px rgba(7, 140, 62, 0.6);
        }

        .subtitle {
            font-size: 1.1rem;
            color: var(--secondary-text-color);
        }

        .card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
        }

        .card h2 {
            font-size: 1.6rem;
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .grid-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 768px) {
            .grid-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        input[type="text"] {
            border: 1px solid var(--border-color);
        }

        input[type="text"],
        button {
            padding: 12px 18px;
            border-radius: 8px;
            background: rgba(84, 109, 184, 0.1);
            color: var(--text-color);
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        input[type="text"]:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--accent-color);
            background: rgba(43, 56, 177, 0.2);
        }

        button {
            background: var(--accent-color);
            cursor: pointer;
            font-weight: normal; /* <-- UBAH FONT-WEIGHT BUTTON KE NORMAL */
            border: none;
        }

        button:hover {
            background: var(--accent-hover-color);
        }

        button.btn-stop {
            background: var(--negative-color);
        }

        button.btn-stop:hover {
            background: #5b1919;
        }

        button:disabled {
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
        }

        .asset-tag-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            min-height: 40px;
        }

        .asset-tag {
            display: inline-flex;
            align-items: center;
            background: #011211;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .asset-tag:hover {
            background: #102e4c;
        }

        .asset-tag i {
            margin-left: 10px;
            font-size: 0.8rem;
            color: var(--secondary-text-color);
        }

        .tf-checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .tf-checkbox-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
            color: var(--text-color);
        }

        .tf-checkbox-group input[type="checkbox"] {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--accent-color);
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
            margin-right: 8px;
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
        }

        .tf-checkbox-group input[type="checkbox"]:checked {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }

        .tf-checkbox-group input[type="checkbox"]:checked::after {
            content: '\f00c';
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            color: var(--main-bg);
            font-size: 14px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .progress-bar-wrapper {
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 50%;
            width: 0%;
            background: linear-gradient(90deg, #07ff07, var(--accent-color));
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .progress-text {
            font-size: 0.9rem;
            color: var(--secondary-text-color);
            text-align: center;
            margin-bottom: 5px;
        }

        .dashboard {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: 12px;
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            font-size: 0.9rem; 
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            font-size: 0.9rem; 
        }

        th {
            background: rgba(53, 50, 50, 0.5);
            position: sticky;
            top: 0;
            cursor: pointer;
            font-weight: normal; /* <-- UBAH FONT-WEIGHT HEADER KE NORMAL */
            color: white;
            font-size: 0.8rem; 

        }

        tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .symbol {
            font-weight: normal;
            font-size: 0.9rem; 
        }

        .symbol a {
            color: var(--text-color);
            text-decoration: none; /* <-- TAMBAHKAN STYLING UNTUK LINK */
        }

        .live-price {
            font-weight: normal;
            font-size: 0.9rem; 
        }

        .price-up {
            color: var(--positive-color);
            animation: price-flash-green 0.5s;
        }

        .price-down {
            color: var(--negative-color);
            animation: price-flash-red 0.5s;
        }

        @keyframes price-flash-green {
            0% { background-color: rgba(76, 175, 80, 0.2); }
            100% { background-color: transparent; }
        }

        @keyframes price-flash-red {
            0% { background-color: rgba(244, 67, 54, 0.2); }
            100% { background-color: transparent; }
        }

        .positive-text {
            color: var(--positive-color);
        }

        .negative-text {
            color: var(--negative-color);
        }

        .action-tag {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 5px;
            font-size: 0.9rem;
            font-weight: normal;
            text-align: center;
        }

        .action-tag.buy {
            background: rgba(76, 175, 80, 0.15);
            color: var(--positive-color);
        }

        .action-tag.sell {
            background: rgba(244, 67, 54, 0.15);
            color: var(--negative-color);
        }

        .action-tag.wait {
            background: rgba(255, 193, 7, 0.15);
            color: var(--warning-color);
        }

        .phase-1 {
            color: var(--positive-color);
            font-weight: normal;
        }

        .phase-2 {
            color: #8eb803;
            font-weight: normal;
        }

        .phase-3 {
            color: #00ffcc;
            font-weight: normal;
        }

        .log-panel {
            background-color: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-item {
            margin-bottom: 0.5rem;
            color: var(--secondary-text-color);
        }

        .log-item.info {
            color: #64b5f6;
        }

        .log-item.success {
            color: var(--positive-color);
        }

        .log-item.error {
            color: var(--negative-color);
        }

        .log-item.result {
            color: var(--warning-color);
            font-weight: normal;
            border-top: 1px dashed var(--border-color);
            padding-top: 0.5rem;
            margin-top: 0.5rem;
        }

        footer {
            text-align: center;
            margin-top: auto;
            padding: 20px;
            color: var(--secondary-text-color);
            font-size: 0.9rem;
        }

        th.numeric-sort {
            text-align: right;
        }

        th.asc::after, th.desc::after {
            content: ' ';
            display: inline-block;
            width: 0;
            height: 0;
            margin-left: 8px;
            vertical-align: middle;
        }

        th.asc::after {
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-bottom: 4px solid var(--accent-color);
        }

        th.desc::after {
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid var(--accent-color);
        }
        #runScannerBtn {
            margin-top: 20px; /* Sesuaikan nilai ini sesuai kebutuhan Anda */
            width: 100%; /* Agar tombol selebar container-nya */
        }
        .asset-tag-wrapper {
            display: flex;
            flex-wrap: nowrap; /* <-- Mencegah tag turun ke baris baru */
            gap: 8px;
            margin-top: 10px;
            min-height: 40px;
            overflow-x: auto; /* <-- Mengaktifkan gulir horizontal */
            padding-bottom: 15px; /* Tambahan padding untuk visibilitas scrollbar */
        }
        .asset-box {
            background: rgba(3, 24, 47, 0.7); /* Menggunakan warna yang sama dengan card */
            padding: 15px; /* Memberikan jarak di dalam kotak */
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="card">
            <div class="flex items-center mb-4">
                <input type="text" id="assetInput" placeholder="Contoh: BTCUSDT" class="flex-grow">
                <button id="addAssetBtn" class="ml-2">âž•</button>
            </div>
            <div id="assetList" class="asset-tag-wrapper"></div>
        </div>
        </header>
        <div class="card">
            <div class="grid-container">
                <div>
                    <label class="block mb-2 text-sm font-normal"></label>
                    <div id="timeframeCheckboxes" class="tf-checkbox-group"></div>
                </div>
            </div>
            
            <div class="mt-8 text-center">
                <button id="runScannerBtn" class="w-full md:w-auto"><i class="fas fa-play"></i> Mulai Scan</button>
                <div id="progressBarWrapper" class="progress-bar-wrapper hidden">
                    <p id="progressText" class="progress-text"></p>
                    <div class="progress-bar"><div id="progressBarFill" class="progress-bar-fill"></div></div>
                </div>
            </div>
        </div>

        <div class="dashboard">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Simbol</th>
                        <th>Aksi</th>
                        <th>Harga</th>
                        <th>HTF Story</th>
                        <th>Siklus Aktif</th>
                        <th>Fase</th>
                        <th>VR</th>
                        <th>CF</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <section id="analysisLogCard" class="card hidden">
            <h2 class="text-lg font-normal text-center mb-4"></h2>
            <div class="log-panel" id="logPanel"></div>
        </section>
    </div>

    <script>
        // ===================================================================================
// BAGIAN 1: DEKLARASI ELEMEN & VARIABEL GLOBAL
// ===================================================================================
const assetInput = document.getElementById('assetInput');
const addAssetBtn = document.getElementById('addAssetBtn');
const assetList = document.getElementById('assetList');
const timeframeCheckboxes = document.getElementById('timeframeCheckboxes');
const runScannerBtn = document.getElementById('runScannerBtn');
const tbody = document.querySelector('#dataTable tbody');
const progressBarWrapper = document.getElementById('progressBarWrapper');
const progressText = document.getElementById('progressText');
const progressBarFill = document.getElementById('progressBarFill');
const analysisLogCard = document.getElementById('analysisLogCard');
const logPanel = document.getElementById('logPanel');
const alertSound = document.getElementById('alertSound');

let SYMBOLS_TO_ANALYZE = [
    "BTCUSDT",
    "ETHUSDT",
    "PAXGUSDT"
];
let TIMEFRAMES_TO_SCAN = ['15m', '1m'];
let websocket = null;
let klineDataCache = {}; 
const TIMEFRAME_ORDER = ['1d', '4h', '1h', '30m', '15m', '5m', '1m'];
let isScanning = false;
let analysisInterval = null;
const ANALYSIS_PERIOD_SECONDS = 15; 

// ===================================================================================
// BAGIAN 2: LOGIKA INTI (ANALISIS & FETCH)
// ===================================================================================
function logToPage(message, type = '', source = 'system') {
    if (source === 'system') {
        console.log(`[${type.toUpperCase()}] ${message}`);
        return;
    }
    const logItem = document.createElement('div');
    logItem.className = `log-item ${type}`;
    const time = new Date().toLocaleTimeString();
    logItem.textContent = `[${time}] ${message}`;
    logPanel.appendChild(logItem);
    logPanel.scrollTop = logPanel.scrollHeight;
}

async function fetchInitialKlines(symbol, interval, limit = 200) {
    // URL API untuk pasar Futures
    const url = `https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`; 
    try {
        await new Promise(resolve => setTimeout(resolve, 250)); 
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.json();
    } catch (error) {
        logToPage(`[${symbol}] Gagal fetch data ${interval}: ${error.message}`, 'error', 'analysis');
        return [];
    }
}

function findBreakout(klines, timeframe, typeToFind = 'any') {
    if (klines.length < 20) return { status: 'NO_BREAKOUT' };
    const parsedKlines = klines.map(k => ({ close: parseFloat(k[4]), high: parseFloat(k[2]), low: parseFloat(k[3]) }));
    const recentKlines = parsedKlines.slice(-20, -1);
    if(recentKlines.length === 0) return { status: 'NO_BREAKOUT' };
    const peakHigh = Math.max(...recentKlines.map(k => k.high));
    const valleyLow = Math.min(...recentKlines.map(k => k.low));
    const lastCandleClose = parsedKlines[parsedKlines.length - 1].close;
    if (lastCandleClose > peakHigh && (typeToFind === 'BULLISH' || typeToFind === 'any')) return { status: 'BREAKOUT', type: 'BULLISH', timeframe };
    if (lastCandleClose < valleyLow && (typeToFind === 'BEARISH' || typeToFind === 'any')) return { status: 'BREAKOUT', type: 'BEARISH', timeframe };
    return { status: 'NO_BREAKOUT' };
}

function getNextTimeframe(currentTF) {
    const index = TIMEFRAME_ORDER.indexOf(currentTF);
    return index > -1 && index < TIMEFRAME_ORDER.length - 1 ? TIMEFRAME_ORDER[index + 1] : null;
}

function getRequiredTimeframesForScan(scanTimeframes) {
    const required = new Set();
    scanTimeframes.forEach(tf => {
        required.add(tf);
        const htfIndex = TIMEFRAME_ORDER.indexOf(tf) - 2;
        if(htfIndex >= 0) required.add(TIMEFRAME_ORDER[htfIndex]);
        const vrTimeframe = getNextTimeframe(tf);
        if(vrTimeframe) required.add(vrTimeframe);
    });
    return Array.from(required);
}

function analyzeSingleSetup(symbol, mainTimeframe) {
    const htfIndex = TIMEFRAME_ORDER.indexOf(mainTimeframe) - 2;
    const htf = htfIndex >= 0 ? TIMEFRAME_ORDER[htfIndex] : TIMEFRAME_ORDER[0];
    const htfKlines = klineDataCache[symbol]?.[htf];
    if (!htfKlines) return { phase: 0, htfStory: 'WAITING DATA' };
    const htfBO = findBreakout(htfKlines, htf);
    const htfStory = htfBO.type === 'BULLISH' ? `${htf.toUpperCase()}-BUY` : htfBO.type === 'BEARISH' ? `${htf.toUpperCase()}-SELL` : 'SIDEWAYS';
    const boKlines = klineDataCache[symbol]?.[mainTimeframe];
    if (!boKlines) return { phase: 0, htfStory };
    const boResult = findBreakout(boKlines, mainTimeframe, htfBO.type);
    if (boResult.status !== 'BREAKOUT') return { phase: 0, htfStory };
    const vrTimeframe = getNextTimeframe(mainTimeframe);
    if (!vrTimeframe) return { phase: 1, htfStory, activeCycle: mainTimeframe.toUpperCase(), boType: boResult.type };
    const vrKlines = klineDataCache[symbol]?.[vrTimeframe];
    if (!vrKlines) return { phase: 1, htfStory, activeCycle: mainTimeframe.toUpperCase(), boType: boResult.type };
    const vrResult = findBreakout(vrKlines, vrTimeframe, boResult.type === 'BULLISH' ? 'BEARISH' : 'BULLISH');
    if (vrResult.status !== 'BREAKOUT') return { phase: 1, htfStory, activeCycle: mainTimeframe.toUpperCase(), boType: boResult.type, vrAlert: `${vrTimeframe.toUpperCase()}-NO_VR` };
    const cfResult = findBreakout(vrKlines, vrTimeframe, boResult.type);
    if (cfResult.status !== 'BREAKOUT') return { phase: 2, htfStory, activeCycle: mainTimeframe.toUpperCase(), boType: boResult.type, vrAlert: `${vrTimeframe.toUpperCase()}-${vrResult.type}` };
    return { phase: 3, htfStory, activeCycle: mainTimeframe.toUpperCase(), boType: boResult.type, vrAlert: `${vrTimeframe.toUpperCase()}-${vrResult.type}`, cfAlert: `${vrTimeframe.toUpperCase()}-${cfResult.type}` };
}

function runAnalysisForSymbol(symbol) {
    logToPage(`Menganalisis ${symbol}...`, 'info', 'analysis');
    let bestResult = { phase: -1, htfStory: "N/A" };
    if (TIMEFRAMES_TO_SCAN.length === 0) { updateTableRow(symbol, bestResult); return; }
    for (const tf of TIMEFRAMES_TO_SCAN) {
        const result = analyzeSingleSetup(symbol, tf);
        if (result.phase > bestResult.phase) bestResult = result;
    }
    updateTableRow(symbol, bestResult);
    logToPage(`[${symbol}] Update: Fase ${bestResult.phase > -1 ? bestResult.phase : 'N/A'}`, 'result', 'analysis');
}

// --- BAGIAN 3: PENGELOLA TAMPILAN (UI) ---
// ===================================================================================
// BAGIAN 6: FUNGSI PENGURUTAN TABEL (SORTING)
// ===================================================================================
function addSortingToTable() {
    const headers = document.querySelectorAll('#dataTable th');
    
    headers.forEach(header => {
        header.addEventListener('click', () => {
            const table = header.closest('table');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const headerIndex = Array.from(header.parentNode.children).indexOf(header);
            const isAsc = header.classList.contains('asc');

            // Hapus kelas pengurutan dari semua header
            headers.forEach(h => h.classList.remove('asc', 'desc'));
            
            // Tentukan arah pengurutan berikutnya
            if (!isAsc) {
                header.classList.add('asc');
            } else {
                header.classList.add('desc');
            }

            // Dapatkan nilai sel yang akan diurutkan
            const getCellValue = (row) => {
                const cell = row.children[headerIndex];
                const text = cell.textContent || cell.innerText;
                if (header.classList.contains('numeric-sort')) {
                    // Untuk nilai numerik
                    return parseFloat(text.replace('$', '')) || 0;
                }
                // Untuk nilai string
                return text.trim().toLowerCase();
            };

            // Urutkan baris
            rows.sort((a, b) => {
                const valA = getCellValue(a);
                const valB = getCellValue(b);

                if (typeof valA === 'string') {
                    return isAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
                } else {
                    return isAsc ? valA - valB : valB - valA;
                }
            });

            // Tambahkan kembali baris yang sudah diurutkan ke tabel
            rows.forEach(row => tbody.appendChild(row));
        });
    });
}



function renderAssetList() {
    assetList.innerHTML = '';
    if (SYMBOLS_TO_ANALYZE.length === 0) assetList.innerHTML = `<span class="asset-tag" style="background:transparent; color:var(--secondary-text-color);">Tambahkan aset untuk memulai.</span>`;
    else SYMBOLS_TO_ANALYZE.forEach(symbol => {
        const tag = document.createElement('span');
        tag.className = 'asset-tag';
        tag.innerHTML = `${symbol} <i class="fas fa-times-circle"></i>`;
        tag.onclick = () => removeSymbol(symbol);
        assetList.appendChild(tag);
    });
}

function createTimeframeCheckboxes() {
    timeframeCheckboxes.innerHTML = '';
    TIMEFRAME_ORDER.forEach(tf => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = tf;
        checkbox.checked = TIMEFRAMES_TO_SCAN.includes(tf);
        checkbox.onchange = updateScanTimeframes;
        label.appendChild(checkbox);
        label.append(` ${tf.toUpperCase()}`);
        timeframeCheckboxes.appendChild(label);
    });
}

function populateTable(symbols) {
    tbody.innerHTML = '';
    if (symbols.length === 0) { 
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding: 40px; color:var(--secondary-text-color);">Tidak ada aset.</td></tr>`; 
        return; 
    }
    symbols.forEach(symbol => {
        const tr = document.createElement('tr');
        tr.id = `row-${symbol}`;
        tr.innerHTML = `
            <td class="symbol">
                <a href="https://www.binance.com/en/futures/${symbol}" target="_blank" rel="noopener noreferrer">
                    ${symbol}
                </a>
            </td>
            <td id="action-${symbol}"><span class="action-tag wait">WAIT</span></td>
            <td id="price-${symbol}" class="live-price">-</td>
            <td id="htf-${symbol}">-</td>
            <td id="cycle-${symbol}">-</td>
            <td id="phase-${symbol}">-</td>
            <td id="vr-${symbol}">-</td>
            <td id="cf-${symbol}">-</td>
        `;
        tbody.appendChild(tr);
    });
}

function updateTableRow(symbol, result) {
    const row = document.getElementById(`row-${symbol}`);
    if (!row) return;

    const finalHtfStory = result.htfStory || "N/A";
    let action, actionClass, phase, phaseClass, activeCycle, vrAlert, cfAlert;

    switch (result.phase) {
        case 1:
            action = `LOOK ${result.boType}`;
            actionClass = result.boType === 'BULLISH' ? 'buy' : 'sell';
            phase = "1";
            phaseClass = 'phase-1';
            activeCycle = result.activeCycle;
            vrAlert = "N/A";
            cfAlert = "N/A";
            break;
        case 2:
            action = "WAIT CF";
            actionClass = 'wait';
            phase = "2";
            phaseClass = 'phase-2';
            activeCycle = result.activeCycle;
            vrAlert = result.vrAlert;
            cfAlert = "N/A";
            break;
        case 3:
            action = result.boType;
            actionClass = result.boType === 'BULLISH' ? 'buy' : 'sell';
            phase = "3";
            phaseClass = 'phase-3';
            activeCycle = result.activeCycle;
            vrAlert = result.vrAlert;
            cfAlert = result.cfAlert;

            // Play the alert sound for BUY/SELL signals
            if (alertSound) {
                alertSound.play().catch(e => console.error("Gagal memutar suara:", e));
            }
            break;
        default:
            action = "WAIT";
            actionClass = 'wait';
            phase = "N/A";
            phaseClass = '';
            activeCycle = "N/A";
            vrAlert = "N/A";
            cfAlert = "N/A";
            break;
    }

    document.getElementById(`htf-${symbol}`).textContent = finalHtfStory;
    document.getElementById(`htf-${symbol}`).className = finalHtfStory.includes('BUY') ? 'positive-text' : finalHtfStory.includes('SELL') ? 'negative-text' : '';
    document.getElementById(`cycle-${symbol}`).textContent = activeCycle;
    document.getElementById(`phase-${symbol}`).textContent = phase;
    document.getElementById(`phase-${symbol}`).className = phaseClass;
    document.getElementById(`vr-${symbol}`).textContent = vrAlert;
    document.getElementById(`cf-${symbol}`).textContent = cfAlert;
    document.getElementById(`action-${symbol}`).innerHTML = `<span class="action-tag ${actionClass}">${action}</span>`;
}

function connectWebSocket() {
    if (websocket) websocket.close();
    const timeframesToWatch = getRequiredTimeframesForScan(TIMEFRAMES_TO_SCAN);
    const klineStreams = SYMBOLS_TO_ANALYZE.flatMap(s => timeframesToWatch.map(tf => `${s.toLowerCase()}@kline_${tf}`));
    const miniTickerStreams = SYMBOLS_TO_ANALYZE.map(s => `${s.toLowerCase()}@miniTicker`);
    const streams = [...klineStreams, ...miniTickerStreams].join('/');
    if (streams.length === 0) return;
    
    // URL WebSocket untuk pasar Futures
    websocket = new WebSocket(`wss://fstream.binance.com/ws/${streams}`); 
    websocket.onmessage = (event) => {
        const message = JSON.parse(event.data);
        const symbol = message.s;
        if (message.e === 'kline') {
            const timeframe = message.k.i;
            const cache = klineDataCache[symbol]?.[timeframe];
            if (cache) {
                const newCandle = [message.k.t, message.k.o, message.k.h, message.k.l, message.k.c, message.k.v, message.k.T, message.k.q, message.k.n, message.k.V, message.k.Q, message.k.B];
                if (message.k.x) {
                    cache.shift();
                    cache.push(newCandle);
                    if(isScanning) runAnalysisForSymbol(symbol);
                } else { cache[cache.length - 1] = newCandle; }
            }
        } else if (message.e === '24hrMiniTicker') {
            const priceCell = document.getElementById(`price-${symbol}`);
            if (priceCell) {
                const newPrice = parseFloat(message.c);
                const oldPrice = parseFloat(priceCell.textContent.replace('$', '')) || 0;
                
                let formattedPrice;
                if (newPrice >= 1) {
                    formattedPrice = newPrice.toFixed(2);
                } else {
                    formattedPrice = newPrice.toFixed(8);
                }
                
                priceCell.textContent = '$' + formattedPrice;
                priceCell.classList.remove('price-up', 'price-down');
                if (newPrice > oldPrice && oldPrice !== 0) priceCell.classList.add('price-up');
                else if (newPrice < oldPrice && oldPrice !== 0) priceCell.classList.add('price-down');
            }
        }
    };
    websocket.onopen = () => logToPage("Koneksi WebSocket berhasil.", 'success', 'system');
    websocket.onerror = (error) => logToPage("Koneksi WebSocket error.", 'error', 'system');
}
function populateTable(symbols) {
    tbody.innerHTML = '';
    if (symbols.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding: 40px; color:var(--secondary-text-color);">Tidak ada aset.</td></tr>`;
        return;
    }
    symbols.forEach(symbol => {
        const tr = document.createElement('tr');
        tr.id = `row-${symbol}`;
        tr.innerHTML = `
            <td class="symbol">
                <a href="https://www.binance.com/en/futures/${symbol}" target="_blank" rel="noopener noreferrer">
                    ${symbol}
                </a>
            </td>
            <td id="action-${symbol}"><span class="action-tag wait">WAIT</span></td>
            <td id="price-${symbol}" class="live-price">-</td>
            <td id="htf-${symbol}">-</td>
            <td id="cycle-${symbol}">-</td>
            <td id="phase-${symbol}">-</td>
            <td id="vr-${symbol}">-</td>
            <td id="cf-${symbol}">-</td>
        `;
        tbody.appendChild(tr);
    });
}
async function addSymbol() {
    const newSymbol = assetInput.value.toUpperCase().trim();
    if (newSymbol && !SYMBOLS_TO_ANALYZE.includes(newSymbol)) {
        SYMBOLS_TO_ANALYZE.push(newSymbol);
        renderAssetList();
        assetInput.value = '';
        if (isScanning) {
            logToPage(`Menambahkan aset baru: ${newSymbol}...`, 'info', 'analysis');
            populateTable(SYMBOLS_TO_ANALYZE);
            await fetchDataForSingleSymbol(newSymbol);
            connectWebSocket(); 
            runAnalysisForSymbol(newSymbol);
        }
    }
}
function removeSymbol(symbolToRemove) {
    SYMBOLS_TO_ANALYZE = SYMBOLS_TO_ANALYZE.filter(s => s !== symbolToRemove);
    renderAssetList();
    if (isScanning) {
        logToPage(`Menghapus ${symbolToRemove} dari pantauan.`, 'info', 'analysis');
        connectWebSocket();
        const rowToRemove = document.getElementById(`row-${symbolToRemove}`);
        if (rowToRemove) rowToRemove.remove();
        if (SYMBOLS_TO_ANALYZE.length === 0) populateTable([]);
    }
}
function updateScanTimeframes() {
    TIMEFRAMES_TO_SCAN = Array.from(document.querySelectorAll('#timeframeCheckboxes input:checked')).map(cb => cb.value);
    TIMEFRAMES_TO_SCAN.sort((a, b) => TIMEFRAME_ORDER.indexOf(a) - TIMEFRAME_ORDER.indexOf(b));
    if(isScanning) {
        alert("Perubahan timeframe akan diterapkan setelah scan dihentikan dan dimulai ulang.");
    }
}
async function fetchDataForSingleSymbol(symbol) {
    const timeframesToFetch = getRequiredTimeframesForScan(TIMEFRAMES_TO_SCAN);
    klineDataCache[symbol] = klineDataCache[symbol] || {};
    for (const tf of timeframesToFetch) {
        logToPage(`[${symbol}] Mengambil data awal untuk ${tf}...`, 'info', 'analysis');
        klineDataCache[symbol][tf] = await fetchInitialKlines(symbol, tf);
    }
    logToPage(`[${symbol}] Data awal berhasil diambil.`, 'success', 'analysis');
}

// --- BAGIAN 4: KONTROL SCANNER ---
async function startScanner() {
    if (SYMBOLS_TO_ANALYZE.length === 0 || TIMEFRAMES_TO_SCAN.length === 0) {
        alert('Harap tambahkan aset dan pilih setidaknya satu timeframe untuk di-scan.');
        return;
    }
    isScanning = true;
    runScannerBtn.disabled = true;
    runScannerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Inisialisasi...';
    logPanel.innerHTML = '';
    analysisLogCard.classList.remove('hidden');
    populateTable(SYMBOLS_TO_ANALYZE);
    progressBarWrapper.classList.remove('hidden');

    const timeframesToFetch = getRequiredTimeframesForScan(TIMEFRAMES_TO_SCAN);
    const totalFetches = SYMBOLS_TO_ANALYZE.length * timeframesToFetch.length;
    let fetchesDone = 0;

    for (const symbol of SYMBOLS_TO_ANALYZE) {
        klineDataCache[symbol] = {};
        for (const tf of timeframesToFetch) {
            fetchesDone++;
            const progress = (fetchesDone / totalFetches) * 100;
            progressText.textContent = `[${fetchesDone}/${totalFetches}] Mengambil data ${symbol} @ ${tf}...`;
            progressBarFill.style.width = `${progress}%`;
            klineDataCache[symbol][tf] = await fetchInitialKlines(symbol, tf);
        }
    }
    
    // Sembunyikan progress bar inisialisasi
    progressBarWrapper.classList.add('hidden');
    
    // Jalankan analisis pertama kali
    runFullAnalysis();
    
    // Mulai timer untuk analisis berkala
    startAnalysisTimer();

    connectWebSocket();

    document.querySelectorAll('#timeframeCheckboxes input').forEach(el => el.disabled = true);
    runScannerBtn.innerHTML = '<i class="fas fa-stop"></i> STOP';
    runScannerBtn.classList.add('btn-stop');
    runScannerBtn.disabled = false;
}
function runFullAnalysis() {
    logToPage("Memulai analisis baru untuk semua aset...", 'info', 'analysis');
    for (const symbol of SYMBOLS_TO_ANALYZE) {
        runAnalysisForSymbol(symbol);
    }
    logToPage("Analisis selesai.", 'success', 'analysis');
}
function startAnalysisTimer() {
    let timeLeftMs = ANALYSIS_PERIOD_SECONDS * 1000;
    progressBarWrapper.classList.remove('hidden');

    analysisInterval = setInterval(() => {
        timeLeftMs -= 100; // Kurangi 100ms setiap 100ms
        
        // Pastikan waktu tidak negatif
        if (timeLeftMs < 0) timeLeftMs = 0;

        // Hitung jam, menit, detik, dan milidetik
        const hours = Math.floor(timeLeftMs / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeftMs % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeLeftMs % (1000 * 60)) / 1000);
        const milliseconds = timeLeftMs % 1000;

        // Tambahkan nol di depan jika angkanya kurang dari 10
        const formatNumber = (num) => num.toString().padStart(2, '0');

        const formattedTime = `${formatNumber(hours)}:${formatNumber(minutes)}:${formatNumber(seconds)}:${milliseconds.toString().padStart(3, '0')}`;
        
        // Hitung progres bilah kemajuan
        const progress = (1 - (timeLeftMs / (ANALYSIS_PERIOD_SECONDS * 1000))) * 100;

        progressText.textContent = `Analisis ulang dalam ${formattedTime}`;
        progressBarFill.style.width = `${progress}%`;
        
        if (timeLeftMs <= 0) {
            clearInterval(analysisInterval);
            runFullAnalysis();
            startAnalysisTimer();
        }
    }, 100); // Perbarui setiap 100 milidetik
}
function stopScanner() {
    isScanning = false;
    if (websocket) websocket.close();
    if (analysisInterval) clearInterval(analysisInterval); // Hentikan timer
    analysisInterval = null;
    analysisLogCard.classList.add('hidden');
    progressBarWrapper.classList.add('hidden');
    document.querySelectorAll('#timeframeCheckboxes input').forEach(el => el.disabled = false);
    runScannerBtn.innerHTML = '<i class="fas fa-play"></i> Mulai Scan';
    runScannerBtn.classList.remove('btn-stop');
}

// --- BAGIAN 5: INISIALISASI APLIKASI ---
document.addEventListener('DOMContentLoaded', () => {
    runScannerBtn.addEventListener('click', () => {
        if (isScanning) stopScanner();
        else startScanner();
    });

    addAssetBtn.onclick = addSymbol;
    assetInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addSymbol(); });
    
    renderAssetList();
    createTimeframeCheckboxes();
    populateTable([]);
    addSortingToTable(); // <-- Panggil fungsi pengurutan di sini
});
    </script>
    <audio id="alertSound" src="alarm.wav" preload="auto"></audio>
</body>
</html>