<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mosha Trading Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <style>
        /* Gaya dasar untuk dark mode dan card */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            color: #E0E0E0;
        }
        .card {
            background-color: #151414;
            border: 1px solid #333;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
        .btn-primary {
            background-color: #f59e0b;
            color: #1f2937;
            font-weight: 600;
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s;
        }
        .btn-primary:hover { background-color: #d97706; }
        .btn-primary:disabled { background-color: #333; cursor: not-allowed; }
        .input-primary {
            background-color: #1c1b1b;
            border: 1px solid #444;
            color: #E0E0E0;
            padding: 0.625rem 1rem;
            width: 100%;
            border-radius: 0.5rem;
        }
        .positive { color: #4ade80; }
        .negative { color: #f87171; }
        .tag { padding: 0.25rem 0.625rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .tag-green { background-color: rgba(74, 124, 89, 0.2); color: #69b37f; }
        .tag-red { background-color: rgba(168, 58, 58, 0.2); color: #d17474; }
        .tag-yellow { background-color: rgba(181, 132, 15, 0.2); color: #e0c273; }
        .tag-gray { background-color: rgba(95, 99, 104, 0.2); color: #9aa0a6; }
        
        /* Gaya loader dan animasi */
        .loader { display: flex; justify-content: center; align-items: center; gap: 8px; }
        .dot { width: 14px; height: 14px; background-color: #e1e1e1; border-radius: 50%; animation: bounce 1.0s infinite ease-in-out both; }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.5); } }
        .blinking-text-animation { animation: blinking-text 1.0s infinite; }
        @keyframes blinking-text { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        /* Gaya Khusus untuk dashboard */
        .collapsible-content { grid-template-rows: 0fr; transition: grid-template-rows 0.4s ease-in-out; }
        .collapsible-content.expanded { grid-template-rows: 1fr; }
        .collapsible-content > div { overflow: hidden; }
        .confluence-bar-container { background-color: #374151; border-radius: 0.5rem; overflow: hidden; height: 30px; display: flex; }
        .confluence-bar-bullish { background: linear-gradient(to right, #22c55e, #86efac); }
        .confluence-bar-bearish { background: linear-gradient(to right, #ef4444, #fca5a5); }
        .confluence-bar { height: 100%; transition: width 0.5s ease-out; }
        .status-uptrend { color: #34d399; }
        .status-downtrend { color: #ef4444; }
        .status-chop { color: #fbbf24; }
        .btn-secondary { background-color: #4b5563; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-yellow-500">Mosha Playbook Dashboard</h1>
            <p class="text-sm text-gray-400 mt-2">Analisis teknikal real-time untuk keputusan trading yang lebih presisi.</p>
        </header>

        <section class="card p-4 md:p-6 mb-6">
            <div class="flex flex-col md:flex-row gap-4">
                <input type="text" id="asset-input" class="input-primary uppercase flex-grow" placeholder="Contoh: BTCUSDT" value="BTCUSDT">
                <select id="timeframe-select" class="input-primary !w-auto">
                    <option value="5m">5m</option>
                    <option value="15m" selected>15m</option>
                    <option value="1h">1h</option>
                    <option value="4h">4h</option>
                    <option value="1d">1d</option>
                </select>
                <button id="analyze-btn" class="btn-primary">
                    <span id="btn-text">MULAI ANALISIS</span>
                    <div id="btn-loader" class="loader hidden">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                </button>
            </div>
            <p id="asset-error" class="text-red-500 text-sm mt-2 hidden"></p>
        </section>

        <section id="quick-confluence-card" class="card p-4 md:p-6 mb-6 hidden">
            <h2 class="text-lg font-bold text-center mb-4">Konfluensi Pasar: <span id="symbol-display">BTCUSDT</span></h2>
            <div class="flex items-center gap-4 my-4">
                <div id="bearish-score" class="text-2xl font-bold negative w-1/5 text-right">0% üêª</div>
                <div class="confluence-bar-container w-3/5">
                    <div id="bearish-bar" class="confluence-bar confluence-bar-bearish" style="width: 50%;"></div>
                    <div id="bullish-bar" class="confluence-bar confluence-bar-bullish" style="width: 50%;"></div>
                </div>
                <div id="bullish-score" class="text-2xl font-bold positive w-1/5 text-left">0% üêÇ</div>
            </div>
            <p id="final-verdict" class="text-center font-semibold text-xl">Menunggu data...</p>
        </section>
        
        <section id="mosha-sop-card" class="card p-4 md:p-6 mb-6 hidden">
            <h2 class="text-lg font-bold text-center mb-4">Langkah-langkah SOP Mosha</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                <div class="p-4 bg-gray-800 rounded-lg">
                    <h3 class="font-semibold text-yellow-400">1. Breakout (BO)</h3>
                    <p class="text-sm mt-2" id="bo-status">Menganalisis pergerakan harga.</p>
                </div>
                <div class="p-4 bg-gray-800 rounded-lg">
                    <h3 class="font-semibold text-blue-400">2. Valid Retracement (VR)</h3>
                    <p class="text-sm mt-2" id="vr-status">Mencari koreksi yang valid.</p>
                </div>
                <div class="p-4 bg-gray-800 rounded-lg">
                    <h3 class="font-semibold text-green-400">3. Confirmation (CF)</h3>
                    <p class="text-sm mt-2" id="cf-status">Menunggu sinyal konfirmasi entri.</p>
                </div>
            </div>
        </section>

        <section id="setup-summary-card" class="card p-4 md:p-6 mb-6 hidden">
            <h2 class="text-lg font-bold text-center mb-4">Setup Trading Terkini</h2>
            <div class="grid grid-cols-2 gap-4 text-center">
                <div>
                    <p class="text-sm text-gray-400">Saran Posisi</p>
                    <p class="text-xl font-bold mt-1" id="trading-bias">Netral</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Alasan Utama</p>
                    <p class="text-sm mt-1" id="trading-reason">Menunggu konfluensi.</p>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-700">
                <p class="text-sm text-gray-400 text-center">Area Kunci:</p>
                <div class="grid grid-cols-2 gap-2 mt-2">
                    <div class="text-center">
                        <p class="text-xs text-gray-500">Harga Entri</p>
                        <p class="font-mono" id="entry-price">--</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-500">Stop Loss</p>
                        <p class="font-mono" id="stop-loss">--</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="trading-tools-card" class="card p-4 md:p-6 mb-6 hidden">
            <h2 class="text-lg font-bold text-center mb-4">Kalkulator & Simulasi</h2>
            <div class="space-y-4">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-grow">
                        <label class="text-sm text-gray-400">Modal ($)</label>
                        <input type="number" id="capital-input" class="input-primary mt-1" value="1000">
                    </div>
                    <div class="flex-grow">
                        <label class="text-sm text-gray-400">Harga Entry ($)</label>
                        <input type="number" id="entry-input" class="input-primary mt-1" placeholder="Harga pasar">
                    </div>
                    <div class="flex-grow">
                        <label class="text-sm text-gray-400">Leverage</label>
                        <input type="number" id="leverage-input" class="input-primary mt-1" value="20">
                    </div>
                </div>
                <div class="flex gap-4">
                    <button id="long-btn" class="btn-primary flex-grow bg-green-500 hover:bg-green-600">Buy / Long</button>
                    <button id="short-btn" class="btn-primary flex-grow bg-red-500 hover:bg-red-600">Sell / Short</button>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-700">
                    <h3 class="text-center font-semibold text-lg">Simulasi Akun</h3>
                    <div class="grid grid-cols-2 gap-2 mt-2 text-center">
                        <div>
                            <p class="text-sm text-gray-500">Equity</p>
                            <p class="font-mono text-xl" id="sim-equity">$1,000.00</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Unrealized PNL</p>
                            <p class="font-mono text-xl" id="sim-pnl">$0.00</p>
                        </div>
                    </div>
                </div>
                <button id="reset-sim-btn" class="btn-secondary w-full mt-4">Reset Simulasi</button>
            </div>
        </section>
        
        <p id="footer-text" class="text-xs text-center text-gray-500 mt-8">Data disediakan oleh Binance API. Ini bukan saran keuangan.</p>
    </div>

    <script>
        // Deklarasi Elemen DOM
        const assetInput = document.getElementById('asset-input');
        const timeframeSelect = document.getElementById('timeframe-select');
        const analyzeBtn = document.getElementById('analyze-btn');
        const btnText = document.getElementById('btn-text');
        const btnLoader = document.getElementById('btn-loader');
        const assetError = document.getElementById('asset-error');
        const quickConfluenceCard = document.getElementById('quick-confluence-card');
        const moshaSopCard = document.getElementById('mosha-sop-card');
        const setupSummaryCard = document.getElementById('setup-summary-card');
        const tradingToolsCard = document.getElementById('trading-tools-card');
        
        // Elemen Dashboard
        const symbolDisplay = document.getElementById('symbol-display');
        const bullishScore = document.getElementById('bullish-score');
        const bearishScore = document.getElementById('bearish-score');
        const bullishBar = document.getElementById('bullish-bar');
        const bearishBar = document.getElementById('bearish-bar');
        const finalVerdict = document.getElementById('final-verdict');
        const boStatus = document.getElementById('bo-status');
        const vrStatus = document.getElementById('vr-status');
        const cfStatus = document.getElementById('cf-status');
        const tradingBias = document.getElementById('trading-bias');
        const tradingReason = document.getElementById('trading-reason');
        const entryPriceEl = document.getElementById('entry-price');
        const stopLossEl = document.getElementById('stop-loss');
        const simEquity = document.getElementById('sim-equity');
        const simPnl = document.getElementById('sim-pnl');
        const capitalInput = document.getElementById('capital-input');
        const entryInput = document.getElementById('entry-input');
        const leverageInput = document.getElementById('leverage-input');
        const longBtn = document.getElementById('long-btn');
        const shortBtn = document.getElementById('short-btn');
        const resetSimBtn = document.getElementById('reset-sim-btn');

        // State Aplikasi
        let klinesCache = {};
        let realtimePrice = 0;
        let ws = null;
        let currentPosition = null;
        let simCapital = 1000;
        
        // Objek Trading Playbook
        const playbook = {
            // Formula dan logika analisis
            calculateRSI: (closes, period = 14) => {
                let gains = [], losses = [];
                for (let i = 1; i < closes.length; i++) {
                    const diff = closes[i] - closes[i - 1];
                    gains.push(diff > 0 ? diff : 0);
                    losses.push(diff < 0 ? -diff : 0);
                }
                let avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
                let avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;
                if (avgLoss === 0) return 100;
                return 100 - (100 / (1 + (avgGain / avgLoss)));
            },
            calculateMACD: (closes, fast = 12, slow = 26, signal = 9) => {
                const EMA = (data, period) => {
                    const k = 2 / (period + 1);
                    let ema = [data[0]];
                    for (let i = 1; i < data.length; i++) {
                        ema.push(data[i] * k + ema[i-1] * (1-k));
                    }
                    return ema;
                };
                const emaFast = EMA(closes, fast);
                const emaSlow = EMA(closes, slow);
                const macdLine = emaFast.map((v, i) => v - emaSlow[i]);
                const signalLine = EMA(macdLine.slice(slow), signal);
                const lastMacd = macdLine[macdLine.length-1];
                const lastSignal = signalLine[signalLine.length-1];
                if (lastMacd > lastSignal) return 'Bullish';
                if (lastMacd < lastSignal) return 'Bearish';
                return 'Netral';
            },
            findBreakout: (klines) => {
                const closes = klines.map(k => parseFloat(k[4]));
                const lastClose = closes[closes.length-1];
                const prevClose = closes[closes.length-2];
                const high = Math.max(...closes.slice(-10));
                const low = Math.min(...closes.slice(-10));
                if (lastClose > high) return 'Bullish Breakout';
                if (lastClose < low) return 'Bearish Breakout';
                return 'No Breakout';
            },
            findVR: (klines) => {
                const bo = playbook.findBreakout(klines);
                if (bo.includes('Bullish')) return 'Bearish Retracement';
                if (bo.includes('Bearish')) return 'Bullish Retracement';
                return 'No Retracement';
            },
            findCF: (klines, vr) => {
                const bo = playbook.findBreakout(klines);
                if (bo.includes('Bullish') && vr.includes('Bearish')) return 'Bullish Confirmation';
                if (bo.includes('Bearish') && vr.includes('Bullish')) return 'Bearish Confirmation';
                return 'No Confirmation';
            }
        };

        // Fungsi fetch data dari Binance
        async function fetchKlines(symbol, timeframe) {
            const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${timeframe}&limit=200`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Gagal mengambil data klines.');
                const data = await response.json();
                return data.map(d => parseFloat(d[4]));
            } catch (error) {
                showError(error.message);
                return [];
            }
        }
        
        // Fungsi WebSocket untuk harga real-time
        function connectWebSocket(symbol) {
            if (ws) ws.close();
            const wsUrl = `wss://stream.binance.com:9443/ws/${symbol.toLowerCase()}@trade`;
            ws = new WebSocket(wsUrl);
            ws.onmessage = (event) => {
                const trade = JSON.parse(event.data);
                realtimePrice = parseFloat(trade.p);
                // Update UI harga real-time
                document.getElementById('entry-input').value = realtimePrice.toFixed(2);
                updateSimulasi();
            };
        }

        // Fungsi analisis dan update UI
        async function analyzeAndRender() {
            const symbol = assetInput.value.toUpperCase();
            const timeframe = timeframeSelect.value;
            symbolDisplay.textContent = symbol;
            
            showLoader(true);
            
            const closes = await fetchKlines(symbol, timeframe);
            if (closes.length === 0) {
                showLoader(false);
                return;
            }
            klinesCache.closes = closes;
            connectWebSocket(symbol);

            const rsi = playbook.calculateRSI(closes);
            const macd = playbook.calculateMACD(closes);
            const bo = playbook.findBreakout(closes.map(c => [0,0,0,0,c]));

            // Update status SOP
            boStatus.textContent = bo;
            vrStatus.textContent = playbook.findVR(closes.map(c => [0,0,0,0,c]));
            cfStatus.textContent = playbook.findCF(closes.map(c => [0,0,0,0,c]), vrStatus.textContent);

            // Update Konfluensi
            let bullScore = 0, bearScore = 0;
            if (rsi < 30) bullScore += 3;
            if (macd === 'Bullish') bullScore += 2;
            if (bo === 'Bullish Breakout') bullScore += 5;
            if (rsi > 70) bearScore += 3;
            if (macd === 'Bearish') bearScore += 2;
            if (bo === 'Bearish Breakout') bearScore += 5;

            bullishScore.textContent = `${(bullScore/10*100).toFixed(0)}% üêÇ`;
            bearishScore.textContent = `${(bearScore/10*100).toFixed(0)}% üêª`;
            bullishBar.style.width = `${(bullScore/10*100)}%`;
            bearishBar.style.width = `${(bearScore/10*100)}%`;

            let verdict = "NETRAL";
            if (bullScore > bearScore) verdict = "BULLISH";
            if (bearScore > bullScore) verdict = "BEARISH";
            finalVerdict.textContent = verdict;

            // Update Setup Trading
            if (verdict.includes('BULLISH')) {
                tradingBias.textContent = 'Buy / Long';
                tradingBias.className = 'text-green-500 font-bold mt-1';
                tradingReason.textContent = `Konfluensi Bullish kuat dari BO, RSI, dan MACD.`;
                entryPriceEl.textContent = realtimePrice ? realtimePrice.toFixed(2) : '--';
                stopLossEl.textContent = (realtimePrice * 0.98).toFixed(2); // Contoh SL 2%
            } else if (verdict.includes('BEARISH')) {
                tradingBias.textContent = 'Sell / Short';
                tradingBias.className = 'text-red-500 font-bold mt-1';
                tradingReason.textContent = `Konfluensi Bearish kuat dari BO, RSI, dan MACD.`;
                entryPriceEl.textContent = realtimePrice ? realtimePrice.toFixed(2) : '--';
                stopLossEl.textContent = (realtimePrice * 1.02).toFixed(2); // Contoh SL 2%
            } else {
                tradingBias.textContent = 'Netral';
                tradingBias.className = 'text-yellow-500 font-bold mt-1';
                tradingReason.textContent = `Pasar sedang konsolidasi atau menunggu sinyal yang jelas.`;
                entryPriceEl.textContent = '--';
                stopLossEl.textContent = '--';
            }

            // Tampilkan card
            quickConfluenceCard.classList.remove('hidden');
            moshaSopCard.classList.remove('hidden');
            setupSummaryCard.classList.remove('hidden');
            tradingToolsCard.classList.remove('hidden');
            
            showLoader(false);
        }

        // Fungsi simulasi trading
        function updateSimulasi() {
            const capital = parseFloat(capitalInput.value);
            const entry = parseFloat(entryInput.value);
            const leverage = parseFloat(leverageInput.value);

            if (!currentPosition) {
                simEquity.textContent = `$${capital.toFixed(2)}`;
                simPnl.textContent = `$0.00`;
                return;
            }

            const currentPrice = realtimePrice;
            const pnl = currentPosition.type === 'long' 
                ? (currentPrice - entry) / entry * currentPosition.cost * leverage
                : (entry - currentPrice) / entry * currentPosition.cost * leverage;

            const totalEquity = simCapital + pnl;
            simEquity.textContent = `$${totalEquity.toFixed(2)}`;
            simPnl.textContent = `$${pnl.toFixed(2)}`;
            simPnl.className = pnl > 0 ? 'positive' : 'negative';
        }

        function toggleLoader(show) {
            btnText.classList.toggle('hidden', show);
            btnLoader.classList.toggle('hidden', !show);
            analyzeBtn.disabled = show;
        }

        function showError(message) {
            assetError.textContent = message;
            assetError.classList.remove('hidden');
        }

        function showLoader(show) {
            toggleLoader(show);
            assetError.classList.add('hidden');
        }

        // Event Listeners
        analyzeBtn.addEventListener('click', analyzeAndRender);
        longBtn.addEventListener('click', () => {
            const capital = parseFloat(capitalInput.value);
            const entry = parseFloat(entryInput.value);
            const leverage = parseFloat(leverageInput.value);
            if (currentPosition) {
                alert("Tutup posisi sebelumnya.");
                return;
            }
            currentPosition = { type: 'long', entryPrice: entry, cost: capital, leverage: leverage };
            simCapital = capital;
            updateSimulasi();
        });
        shortBtn.addEventListener('click', () => {
            const capital = parseFloat(capitalInput.value);
            const entry = parseFloat(entryInput.value);
            const leverage = parseFloat(leverageInput.value);
            if (currentPosition) {
                alert("Tutup posisi sebelumnya.");
                return;
            }
            currentPosition = { type: 'short', entryPrice: entry, cost: capital, leverage: leverage };
            simCapital = capital;
            updateSimulasi();
        });
        resetSimBtn.addEventListener('click', () => {
            currentPosition = null;
            simCapital = 1000;
            capitalInput.value = 1000;
            updateSimulasi();
        });

        // Inisialisasi awal
        window.onload = () => {
            if (assetInput.value) {
                analyzeAndRender();
            }
        };
    </script>
</body>
</html>