<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mosha Playbook Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #000000; color: #E0E0E0; }
        .card { background-color: #151414; border: 1px solid #333; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); }
        .btn-primary { background-color: #f59e0b; color: #1f2937; font-weight: 600; padding: 0.625rem 1.25rem; border-radius: 0.5rem; transition: background-color 0.3s; }
        .btn-primary:hover { background-color: #d97706; }
        .btn-primary:disabled { background-color: #333; cursor: not-allowed; }
        .input-primary { background-color: #1c1b1b; border: 1px solid #444; color: #E0E0E0; padding: 0.625rem 1rem; width: 100%; border-radius: 0.5rem; }
        .positive { color: #4ade80; }
        .negative { color: #f87171; }
        .tag { padding: 0.25rem 0.625rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .tag-green { background-color: rgba(74, 124, 89, 0.2); color: #69b37f; }
        .tag-red { background-color: rgba(168, 58, 58, 0.2); color: #d17474; }
        .tag-yellow { background-color: rgba(181, 132, 15, 0.2); color: #e0c273; }
        .tag-gray { background-color: rgba(95, 99, 104, 0.2); color: #9aa0a6; }
        .loader { display: flex; justify-content: center; align-items: center; gap: 8px; }
        .dot { width: 14px; height: 14px; background-color: #e1e1e1; border-radius: 50%; animation: bounce 1.0s infinite ease-in-out both; }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.5); } }
        .blinking-text-animation { animation: blinking-text 1.0s infinite; }
        @keyframes blinking-text { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .status-container { display: flex; flex-direction: column; gap: 0.5rem; }
        .status-item { padding: 0.75rem; border-radius: 0.5rem; font-weight: 600; }
        .status-waiting { background-color: #333; color: #999; }
        .status-found { background-color: #166534; color: #dcfce7; }
        .status-valid { background-color: #1d4ed8; color: #dbeafe; }
        .status-entry { background-color: #854d0e; color: #fef9c3; }
        .status-final { background-color: #2563eb; color: #dbeafe; }
        .log-panel { background-color: #1c1b1b; border: 1px solid #444; border-radius: 0.75rem; padding: 1rem; margin-top: 1rem; font-family: monospace; font-size: 0.875rem; max-height: 400px; overflow-y: auto; }
        .log-item { margin-bottom: 0.5rem; color: #9aa0a6; }
        .log-item.info { color: #dbeafe; }
        .log-item.success { color: #69b37f; }
        .log-item.error { color: #d17474; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-yellow-500">Mosha Playbook Dashboard</h1>
            <p class="text-sm text-gray-400 mt-2">100% Implementasi Penuh Logika PDF</p>
        </header>

        <section class="card p-4 md:p-6 mb-6">
            <div class="flex flex-col md:flex-row gap-4">
                <input type="text" id="asset-input" class="input-primary uppercase flex-grow" placeholder="Contoh: BTCUSDT" value="BTCUSDT">
                <select id="timeframe-select" class="input-primary !w-auto">
                    <option value="1d">Daily (Father)</option>
                    <option value="4h">H4 (Mother)</option>
                    <option value="1h" selected>H1 (Baby)</option>
                    <option value="30m">M30</option>
                    <option value="15m">M15</option>
                    <option value="5m">M5</option>
                </select>
                <button id="analyze-btn" class="btn-primary">
                    <span id="btn-text">JALANKAN ANALISIS</span>
                    <div id="btn-loader" class="loader hidden">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                </button>
            </div>
            <p id="asset-error" class="text-red-500 text-sm mt-2 hidden"></p>
        </section>

        <section id="analysis-results-card" class="card p-4 md:p-6 mb-6 hidden">
            <h2 class="text-lg font-bold text-center mb-4">Analisis Pasar</h2>
            <div class="text-center mb-4">
                <p class="text-sm text-gray-400">Storyline Pasar (HTF):</p>
                <p id="storyline" class="text-2xl font-bold mt-1">---</p>
                <p class="text-sm text-gray-400 mt-2">Fase Market Cycle:</p>
                <p id="market-phase" class="text-xl font-bold mt-1">---</p>
            </div>
            
            <div class="border-t border-gray-700 pt-4 mt-4">
                <h3 class="font-bold text-yellow-400 mb-2">Langkah-langkah SOP</h3>
                <div class="status-container" id="sop-status-container">
                    <div class="status-item status-waiting">1. Breakout (BO): Menganalisis pergerakan harga.</div>
                    <div class="status-item status-waiting">2. Valid Retracement (VR): Mencari koreksi yang valid.</div>
                    <div class="status-item status-waiting">3. Confirmation (CF): Menunggu sinyal konfirmasi entri.</div>
                </div>
            </div>
        </section>
        
        <section id="setup-summary-card" class="card p-4 md:p-6 mb-6 hidden">
            <h2 class="text-lg font-bold text-center mb-4">Detail Setup Trading</h2>
            <div class="grid grid-cols-2 gap-4 text-center">
                <div>
                    <p class="text-sm text-gray-400">Saran Posisi</p>
                    <p class="text-xl font-bold mt-1" id="trading-bias">---</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Lokasi Entri Terbaik</p>
                    <p class="text-sm mt-1" id="trading-reason">---</p>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-700">
                <p class="text-sm text-gray-400 text-center">Area Kunci:</p>
                <div class="grid grid-cols-3 gap-2 mt-2">
                    <div class="text-center">
                        <p class="text-xs text-gray-500">Harga Entri</p>
                        <p class="font-mono" id="entry-price">--</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-500">Stop Loss (15 pips)</p>
                        <p class="font-mono" id="stop-loss">--</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-500">Take Profit (VR)</p>
                        <p class="font-mono" id="take-profit">--</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="analysis-log-card" class="card p-4 md:p-6 mb-6 hidden">
            <h2 class="text-lg font-bold text-center mb-4">Log Analisis</h2>
            <div class="log-panel" id="log-panel">
                <div class="log-item info">Log akan muncul di sini.</div>
            </div>
        </section>
        
        <p id="footer-text" class="text-xs text-center text-gray-500 mt-8">Data disediakan oleh Binance API. Ini bukan saran keuangan.</p>
    </div>

    <script>
        const assetInput = document.getElementById('asset-input');
        const timeframeSelect = document.getElementById('timeframe-select');
        const analyzeBtn = document.getElementById('analyze-btn');
        const btnText = document.getElementById('btn-text');
        const btnLoader = document.getElementById('btn-loader');
        const analysisResultsCard = document.getElementById('analysis-results-card');
        const setupSummaryCard = document.getElementById('setup-summary-card');
        const storylineEl = document.getElementById('storyline');
        const marketPhaseEl = document.getElementById('market-phase');
        const sopStatusContainer = document.getElementById('sop-status-container');
        const tradingBiasEl = document.getElementById('trading-bias');
        const tradingReasonEl = document.getElementById('trading-reason');
        const entryPriceEl = document.getElementById('entry-price');
        const stopLossEl = document.getElementById('stop-loss');
        const takeProfitEl = document.getElementById('take-profit');
        const logPanel = document.getElementById('log-panel');
        const analysisLogCard = document.getElementById('analysis-log-card');
        
        const TIMEFRAME_ORDER = ['1d', '4h', '1h', '30m', '15m', '5m', '1m'];
        const PIP_VALUES = { '1d': 0.0001, '4h': 0.0001, '1h': 0.0001, '30m': 0.0001, '15m': 0.0001, '5m': 0.0001, '1m': 0.0001 };
        
        function logToPage(message, type = 'info') {
            const logItem = document.createElement('div');
            logItem.className = `log-item ${type}`;
            logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logPanel.appendChild(logItem);
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        async function fetchKlines(symbol, interval, limit =1000) {
            logToPage(`Mengambil data klines untuk ${symbol} di timeframe ${interval}...`, 'info');
            const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Gagal mengambil data untuk ${symbol} di ${interval}.`);
                const data = await response.json();
                logToPage(`Data klines ${interval} diterima. Jumlah candle: ${data.length}`, 'success');
                return data;
            } catch (error) {
                logToPage(`ERROR: ${error.message}`, 'error');
                return [];
            }
        }

        // Fungsi untuk mendeteksi BO, termasuk BO Normal dan BO Structure (W/M-pattern)
        function findBreakout(klines, typeToFind = 'any') {
            if (klines.length < 20) return { status: 'NO_BREAKOUT', type: 'N/A', level: 0 };
            const highs = klines.map(k => parseFloat(k[2]));
            const lows = klines.map(k => parseFloat(k[3]));
            const lastCandleClose = parseFloat(klines[klines.length - 1][4]);
            
            // Logika untuk BO Structure (W/M-pattern)
            const recentHighs = highs.slice(-5, -1);
            const recentLows = lows.slice(-5, -1);
            const peakHigh = Math.max(...recentHighs);
            const valleyLow = Math.min(...recentLows);
            
            const isBullishStructure = lastCandleClose > peakHigh;
            const isBearishStructure = lastCandleClose < valleyLow;
            
            if (isBullishStructure && (typeToFind === 'BULLISH' || typeToFind === 'any')) {
                logToPage("BO Structure (W-pattern) BUY ditemukan.", 'success');
                return { status: 'BREAKOUT', type: 'BULLISH', level: peakHigh };
            }
            if (isBearishStructure && (typeToFind === 'BEARISH' || typeToFind === 'any')) {
                logToPage("BO Structure (M-pattern) SELL ditemukan.", 'success');
                return { status: 'BREAKOUT', type: 'BEARISH', level: valleyLow };
            }
            
            // Logika untuk BO Normal
            const highLevel = Math.max(...highs.slice(-10, -1));
            const lowLevel = Math.min(...lows.slice(-10, -1));
            
            const isBuyBreakout = lastCandleClose > highLevel;
            const isSellBreakout = lastCandleClose < lowLevel;
            
            if (isBuyBreakout && (typeToFind === 'BULLISH' || typeToFind === 'any')) {
                logToPage("BO Normal BUY ditemukan.", 'success');
                return { status: 'BREAKOUT', type: 'BULLISH', level: highLevel };
            }
            if (isSellBreakout && (typeToFind === 'BEARISH' || typeToFind === 'any')) {
                logToPage("BO Normal SELL ditemukan.", 'success');
                return { status: 'BREAKOUT', type: 'BEARISH', level: lowLevel };
            }
            
            logToPage("Tidak ada Breakout yang valid ditemukan.", 'info');
            return { status: 'NO_BREAKOUT', type: 'N/A', level: 0 };
        }

        function getNextTimeframe(currentTF) {
            const index = TIMEFRAME_ORDER.indexOf(currentTF);
            return TIMEFRAME_ORDER[index + 1] || null;
        }

        function addSOPStatus(message, type) {
            const statusEl = document.createElement('div');
            statusEl.className = `status-item ${type}`;
            statusEl.textContent = message;
            sopStatusContainer.appendChild(statusEl);
        }

        async function runMoshaSOP(symbol, mainTimeframe) {
            // Reset UI
            analyzeBtn.disabled = true;
            btnText.classList.add('hidden');
            btnLoader.classList.remove('hidden');
            analysisResultsCard.classList.remove('hidden');
            setupSummaryCard.classList.remove('hidden');
            analysisLogCard.classList.remove('hidden');
            sopStatusContainer.innerHTML = '';
            logPanel.innerHTML = '<div class="log-item info">Log akan muncul di sini.</div>';

            // Fase 1: Validasi Storyline dan BO Utama
            addSOPStatus("1. Mencari Storyline Pasar (HTF)...", 'status-waiting blinking-text-animation');
            logToPage("--- Memulai Analisis SOP ---", 'info');
            const mainTFIndex = TIMEFRAME_ORDER.indexOf(mainTimeframe);
            const htf = TIMEFRAME_ORDER[mainTFIndex - 2] || TIMEFRAME_ORDER[0];
            const htfKlines = await fetchKlines(symbol, htf);
            const htfBO = findBreakout(htfKlines);
            const storyline = htfBO.type === 'BULLISH' ? 'UPTREND (BUY)' : (htfBO.type === 'BEARISH' ? 'DOWNTREND (SELL)' : 'SIDEWAYS');
            storylineEl.textContent = storyline;
            storylineEl.className = `text-2xl font-bold mt-1 ${htfBO.type === 'BULLISH' ? 'positive' : (htfBO.type === 'BEARISH' ? 'negative' : 'text-gray-400')}`;
            logToPage(`Storyline Pasar Ditemukan: ${storyline}`, 'success');

            addSOPStatus(`2. Memulai SOP dengan BO di ${mainTimeframe}...`, 'status-waiting blinking-text-animation');
            const boKlines = await fetchKlines(symbol, mainTimeframe);
            const boResult = findBreakout(boKlines, htfBO.type);
            
            if (boResult.status !== 'BREAKOUT') {
                addSOPStatus(`âš ï¸ Tidak ada BO yang selaras dengan tren HTF. Analisis dihentikan.`, 'status-waiting');
                updateUIForNoSetup(storyline);
                logToPage("Analisis dihentikan: BO tidak selaras dengan tren HTF.", 'error');
                return;
            }
            addSOPStatus(`âœ… BO Ditemukan di ${mainTimeframe}: ${boResult.type}`, 'status-found');
            logToPage(`BO utama ditemukan: ${boResult.type} di level ${boResult.level}`, 'success');

            // Fase 2: Deteksi VR dan CF
            const vrTimeframe = getNextTimeframe(mainTimeframe);
            addSOPStatus(`3. Mencari VR di ${vrTimeframe}...`, 'status-waiting blinking-text-animation');
            const vrKlines = await fetchKlines(symbol, vrTimeframe);
            const vrResult = findBreakout(vrKlines, boResult.type === 'BULLISH' ? 'BEARISH' : 'BULLISH');
            
            if (vrResult.status !== 'BREAKOUT') {
                addSOPStatus(`âš ï¸ VR tidak valid atau belum terbentuk. Ini adalah Fase 1 (Continuation).`, 'status-waiting');
                updateUIForNoSetup(storyline, 'Fase 1 - Continuation (Menunggu)');
                logToPage("Analisis dihentikan: Tidak ada VR, ini Fase 1.", 'error');
                return;
            }
            addSOPStatus(`âœ… VR Ditemukan di ${vrTimeframe}: ${vrResult.type}`, 'status-valid');
            logToPage(`VR ditemukan: ${vrResult.type} di level ${vrResult.level}`, 'success');

            const cfTimeframe = vrTimeframe;
            addSOPStatus(`4. Mencari CF di ${cfTimeframe}...`, 'status-waiting blinking-text-animation');
            const cfKlines = await fetchKlines(symbol, cfTimeframe);
            const cfResult = findBreakout(cfKlines, boResult.type);

            if (cfResult.status !== 'BREAKOUT') {
                addSOPStatus(`âš ï¸ CF belum terbentuk. Ini adalah Fase 2 (High Risk Setup).`, 'status-waiting');
                updateUIForHighRiskSetup(storyline, boResult, vrResult);
                logToPage("Analisis dihentikan: Tidak ada CF, ini Fase 2.", 'error');
                return;
            }
            addSOPStatus(`âœ… CF Ditemukan di ${cfTimeframe}: ${cfResult.type}`, 'status-entry');
            logToPage(`CF ditemukan: ${cfResult.type} di level ${cfResult.level}`, 'success');
            
            // Fase 3: SOP Berulang (Pullback Entry)
            let finalCFResult = cfResult;
            let currentTF = cfTimeframe;
            let currentVR = vrResult;
            let isFinalSetupFound = false;

            while (true) {
                const nextTF = getNextTimeframe(currentTF);
                if (!nextTF) { 
                    isFinalSetupFound = true; 
                    logToPage(`Mencapai timeframe terkecil (${currentTF}). SOP berulang selesai.`, 'success');
                    break; 
                }
                
                addSOPStatus(`"Zona Besar", mengulangi SOP di ${nextTF}...`, 'status-waiting blinking-text-animation');
                logToPage(`Memulai SOP berulang untuk menemukan pullback di ${nextTF}`, 'info');
                
                const nextVRKlines = await fetchKlines(symbol, nextTF);
                const nextVRResult = findBreakout(nextVRKlines, finalCFResult.type === 'BULLISH' ? 'BEARISH' : 'BULLISH');
                
                if (nextVRResult.status === 'BREAKOUT') {
                    addSOPStatus(`ðŸš¨ Oops, ada VR di ${nextTF}. Tunggu CF di ${nextTF}.`, 'status-waiting');
                    logToPage(`VR ditemukan di ${nextTF}. Mencari CF...`, 'info');
                    const nextCFKlines = await fetchKlines(symbol, nextTF);
                    const nextCFResult = findBreakout(nextCFKlines, finalCFResult.type);
                    
                    if (nextCFResult.status === 'BREAKOUT') {
                        currentVR = nextVRResult;
                        finalCFResult = nextCFResult;
                        currentTF = nextTF;
                        addSOPStatus(`âœ… Siklus baru ditemukan di ${currentTF}.`, 'status-valid');
                        logToPage(`Siklus lengkap ditemukan di ${currentTF}. Melanjutkan pencarian...`, 'success');
                    } else {
                        addSOPStatus(`âš ï¸ CF di ${nextTF} belum terbentuk. Analisis final.`, 'status-final');
                        isFinalSetupFound = true;
                        logToPage(`CF tidak ditemukan di ${nextTF}. Ini adalah titik entri terakhir.`, 'info');
                        break; 
                    }
                } else {
                    addSOPStatus(`âœ… Tidak ada siklus kecil lagi. Setup valid.`, 'status-final');
                    isFinalSetupFound = true;
                    logToPage("Tidak ada siklus kecil yang ditemukan. Analisis final.", 'success');
                    break;
                }
            }
            
            if (isFinalSetupFound) {
                updateUIForCompleteSetup(storyline, boResult, currentVR, finalCFResult, currentTF);
            }
        }

        function updateUI(show) {
            analysisResultsCard.classList.toggle('hidden', !show);
            setupSummaryCard.classList.toggle('hidden', !show);
            analysisLogCard.classList.toggle('hidden', !show);
            analyzeBtn.disabled = !show;
            btnText.classList.remove('hidden');
            btnLoader.classList.add('hidden');
        }

        function updateUIForNoSetup(storyline, phase = 'Fase 1 - Continuation (Menunggu)') {
            updateUI(true);
            tradingBiasEl.textContent = 'Menunggu Setup';
            tradingBiasEl.className = 'text-xl font-bold mt-1 text-gray-400';
            tradingReasonEl.textContent = `Tidak ada setup ${storyline} yang valid. Tunggu konfirmasi.`;
            marketPhaseEl.textContent = phase;
            marketPhaseEl.className = 'text-xl font-bold mt-1 text-gray-400';
            entryPriceEl.textContent = '--';
            stopLossEl.textContent = '--';
            takeProfitEl.textContent = '--';
            btnText.classList.remove('hidden');
            btnLoader.classList.add('hidden');
            analyzeBtn.disabled = false;
        }
        
        function updateUIForHighRiskSetup(storyline, bo, vr) {
            updateUI(true);
            const direction = vr.type === 'BULLISH' ? 'Buy / Long' : 'Sell / Short';
            tradingBiasEl.textContent = direction;
            tradingBiasEl.className = `text-xl font-bold mt-1 ${vr.type === 'BULLISH' ? 'positive' : 'negative'}`;
            tradingReasonEl.textContent = `âš ï¸ Setup VR (High Risk). Tunggu CF.`;
            marketPhaseEl.textContent = 'Fase 2 - Retracement (High Risk)';
            marketPhaseEl.className = 'text-xl font-bold mt-1 negative';
            entryPriceEl.textContent = '$' + vr.level.toFixed(4);
            stopLossEl.textContent = '--';
            takeProfitEl.textContent = '$' + bo.level.toFixed(4);
            btnText.classList.remove('hidden');
            btnLoader.classList.add('hidden');
            analyzeBtn.disabled = false;
        }

        function updateUIForCompleteSetup(storyline, bo, vr, cf, finalTimeframe) {
            updateUI(true);
            const direction = bo.type === 'BULLISH' ? 'Buy / Long' : 'Sell / Short';
            tradingBiasEl.textContent = direction;
            tradingBiasEl.className = `text-xl font-bold mt-1 ${bo.type === 'BULLISH' ? 'positive' : 'negative'}`;
            tradingReasonEl.textContent = `SOP Lengkap! Fase 3 (Best Conti) di ${finalTimeframe}.`;
            marketPhaseEl.textContent = 'Fase 3 - Continuation (Best Setup)';
            marketPhaseEl.className = 'text-xl font-bold mt-1 positive';
            
            const assetPips = PIP_VALUES[finalTimeframe] || 0.0001; 
            const slLevel = bo.type === 'BULLISH' ? cf.level - (15 * assetPips) : cf.level + (15 * assetPips);
            
            entryPriceEl.textContent = '$' + cf.level.toFixed(4);
            stopLossEl.textContent = '$' + slLevel.toFixed(4);
            takeProfitEl.textContent = '$' + vr.level.toFixed(4);
            btnText.classList.remove('hidden');
            btnLoader.classList.add('hidden');
            analyzeBtn.disabled = false;
        }

        analyzeBtn.addEventListener('click', () => {
            const symbol = assetInput.value.toUpperCase();
            const timeframe = timeframeSelect.value;
            runMoshaSOP(symbol, timeframe);
        });
    </script>
</body>
</html>
