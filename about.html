<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Co-pilot CHART "AI" v6.0 (Enhanced)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* CSS Kustom untuk menyempurnakan tampilan */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #111827; /* Latar belakang gelap untuk kenyamanan mata */
            color: #d1d5db; /* Warna teks abu-abu terang */
        }
        .tab-button.active { 
            background-color: #3b82f6; /* Warna biru untuk tab aktif */
            color: white; 
        }
        .chart-upload-container { 
            background-color: #1f2937; 
            border-radius: 0.5rem; 
            padding: 1rem; 
            border: 1px solid #374151; 
            height: 100%; 
            display: flex; 
            flex-direction: column; 
        }
        .chart-preview-container { 
            flex-grow: 1; 
            position: relative; 
            background-color: #111827; 
            border-radius: 0.375rem; 
            border: 2px dashed #4b5563; /* Garis putus-putus untuk area drop */
            min-height: 150px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .chart-preview-container.drag-over {
            border-color: #3b82f6; /* Warna berubah saat gambar di-drag di atasnya */
            background-color: rgba(59, 130, 246, 0.1);
        }
        .chart-preview { 
            object-fit: contain; 
            width: 100%; 
            height: 100%; 
            position: absolute; 
            top: 0; 
            left: 0; 
        }
        .loader { 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #3498db; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; /* Animasi loading berputar */
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        .analysis-table-cell { 
            padding: 0.75rem; 
            border-bottom: 1px solid #374151; 
            vertical-align: top; 
        }
        .kalkulator-input { 
            background-color: #374151; 
            border: 1px solid #4b5563; 
            color: white; 
            border-radius: 0.375rem; 
            padding: 0.5rem 0.75rem; 
            width: 100%; 
        }
        .posisi-btn.active.long { 
            background-color: #22c55e; /* Warna hijau untuk posisi LONG aktif */
            color: white; 
            font-weight: bold; 
        }
        .posisi-btn.active.short { 
            background-color: #ef4444; /* Warna merah untuk posisi SHORT aktif */
            color: white; 
            font-weight: bold; 
        }
        /* Animasi berdenyut untuk menyorot rekomendasi probabilitas tinggi */
        @keyframes pulse-bg { 
            0% { background-color: rgba(59, 130, 246, 0.1); } 
            50% { background-color: rgba(59, 130, 246, 0.35); } 
            100% { background-color: rgba(59, 130, 246, 0.1); } 
        }
        .highlight-pulse { 
            animation: pulse-bg 2s ease-in-out infinite; 
            border-radius: 0.375rem; 
        }
        /* [IMPROVEMENT] Style untuk tombol 'Gunakan Data' di proyeksi */
        .use-projection-btn {
            background-color: #1e40af;
            color: white;
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
            margin-top: 8px;
        }
        .use-projection-btn:hover {
            background-color: #1d4ed8;
        }
    </style>
</head>
<body class="antialiased">

    <div class="min-h-screen flex flex-col">
        <header class="bg-gray-800/50 backdrop-blur-sm shadow-lg p-4 top-0 z-20 h-16 relative flex items-center justify-center">
    
    <div class="absolute left-4 top-1/2 -translate-y-1/2">
        <a href="https://opixtm.github.io/Trade/" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors duration-300">
            COPILOT
        </a>
    </div>

    <h1 class="text-2xl font-bold text-white">üõû<span class="text-blue-400">"AI"</span> enhanced</h1>

    <div class="absolute right-4 top-1/2 -translate-y-1/2">
        <a href="https://opixtm.github.io/Trade/services" target="_blank" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded transition-colors duration-300">
            BACKTEST
        </a>
    </div>

</header>
<div class="flex-grow flex flex-col md:flex-row p-4 gap-4">

            <aside class="w-full md:w-1/3 lg:w-1/4 flex flex-col gap-4">
                 <div class="bg-gray-800 rounded-lg p-4 flex flex-col gap-4 shadow-md flex-grow">
                    <div>
                        <h3 class="text-lg font-bold text-white mb-1">Mode Analisa</h3>
                        <p class="text-xs text-gray-400 mb-4">
                            <span class="font-bold">Mode Standar:</span> Cukup isi LTF. <br/>
                            <span class="font-bold">Mode MTF Presisi:</span> Isi HTF & LTF.
                        </p>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-1">1. Chart HTF (Tren Besar) <span class="text-gray-500 text-xs italic">- Opsional</span></label>
                            <div id="htf-drop-zone" class="chart-preview-container">
                                <img id="htf-chart-preview" src="" alt="Pratinjau Chart HTF" class="hidden chart-preview">
                                <div id="htf-chart-placeholder" class="text-center text-gray-500 p-2 pointer-events-none"><p class="text-xs">Klik atau Drop gambar di sini</p></div>
                            </div>
                            <input type="file" id="htf-chart-upload" class="hidden" accept="image/*">
                            <label for="htf-chart-upload" class="mt-2 cursor-pointer w-full text-center bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition block">Pilih Gambar HTF</label>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">2. Chart LTF (Entry) <span class="text-green-400 text-xs italic">- Wajib</span></label>
                            <div id="ltf-drop-zone" class="chart-preview-container">
                                <img id="ltf-chart-preview" src="" alt="Pratinjau Chart LTF" class="hidden chart-preview">
                                <div id="ltf-chart-placeholder" class="text-center text-gray-500 p-2 pointer-events-none"><p class="text-xs">Klik atau Drop gambar di sini</p></div>
                            </div>
                            <input type="file" id="ltf-chart-upload" class="hidden" accept="image/*">
                            <label for="ltf-chart-upload" class="mt-2 cursor-pointer w-full text-center bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition block">Pilih Gambar LTF</label>
                        </div>
                    </div>
                    
                    <button id="analyze-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition disabled:bg-gray-500 disabled:cursor-not-allowed text-lg">ANALISA SEKARANG</button>
                 </div>
            </aside>

            <main class="w-full md:w-2/3 lg:w-3/4 bg-gray-800 rounded-lg p-2 sm:p-4 shadow-md flex flex-col relative">
                <div id="loader" class="hidden absolute inset-0 bg-gray-900/80 flex items-center justify-center flex-col gap-2 z-50 rounded-lg">
                    <div class="loader"></div>
                    <p id="loader-text" class="text-white font-semibold"></p>
                </div>
                <div>
                     <div class="bg-yellow-900/50 border border-yellow-700 p-4 rounded-lg mb-4">
                        <h3 class="font-bold text-yellow-300">Setup Kunci AI (Wajib)</h3>
                        <input type="password" id="api-key-input" class="kalkulator-input mt-2" placeholder="Tempel API Key Google AI Studio di sini...">
                        <p class="text-xs text-gray-400 mt-1">Kunci akan disimpan di sesi browser Anda (terhapus saat tab ditutup). <a href="https://aistudio.google.com/app/apikey" target="_blank" class="underline hover:text-yellow-300 font-bold">Dapatkan Kunci di sini (Gratis)</a>.</p>
                    </div>
                    <div class="flex flex-wrap border-b border-gray-700">
                        <button class="tab-button flex-grow py-2 px-4 font-semibold text-gray-400 hover:bg-gray-700 transition rounded-t-lg active" data-tab="analisa">ANALYSIS</button>
                        <button class="tab-button flex-grow py-2 px-4 font-semibold text-gray-400 hover:bg-gray-700 transition rounded-t-lg" data-tab="kalkulator">CALC</button>
                        <button class="tab-button flex-grow py-2 px-4 font-semibold text-gray-400 hover:bg-gray-700 transition rounded-t-lg" data-tab="proyeksi">üìà Proyeksi</button>
                        <button class="tab-button flex-grow py-2 px-4 font-semibold text-gray-400 hover:bg-gray-700 transition rounded-t-lg" data-tab="backtest">‚öôÔ∏è Backtesting</button>
                    </div>
                </div>

                <div id="tab-content" class="flex-grow mt-4 overflow-y-auto">
                    <div id="analisa" class="tab-pane">
                        <div id="analysis-placeholder" class="text-center text-gray-500 p-8"><p>Unggah gambar chart untuk melihat hasil analisa AI di sini.</p></div>
                        <div id="analysis-wrapper" class="hidden">
                            <div id="analysis-content">
                                 <div class="mb-4 bg-gray-900 p-4 rounded-lg border-l-4 border-blue-400">
                                     <h4 class="font-bold text-lg text-white mb-2">Hasil Detektif Data (LTF)</h4>
                                     <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm items-center">
                                         <div>
                                            <span class="font-semibold text-gray-400">Aset:</span> 
                                            <span id="data-asset" class="font-bold"></span>
                                         </div>
                                         <div><span class="font-semibold text-gray-400">Timeframe:</span> <span id="data-timeframe" class="font-bold"></span></div>
                                         <div><span class="font-semibold text-gray-400">Harga Terakhir:</span> <span id="data-price" class="font-bold"></span></div>
                                     </div>
                                     <div class="mt-2">
                                        <span class="font-semibold text-gray-400">Indikator Terdeteksi:</span>
                                        <span id="data-indicators" class="font-bold text-xs text-blue-300"></span>
                                     </div>
                                 </div>
                                 <div class="bg-gray-900 rounded-lg overflow-hidden hidden md:block">
    <div class="grid grid-cols-1 md:grid-cols-3"><div class="analysis-table-cell font-bold text-gray-400 bg-gray-800">Parameter</div><div class="analysis-table-cell font-bold text-green-400 bg-gray-800">Setup LONG</div><div class="analysis-table-cell font-bold text-red-400 bg-gray-800">Setup SHORT</div></div>
    <div class="grid grid-cols-1 md:grid-cols-3"><div class="analysis-table-cell font-semibold">Kondisi Pasar</div><div class="analysis-table-cell" id="long-kondisi">-</div><div class="analysis-table-cell" id="short-kondisi">-</div></div>
    <div class="grid grid-cols-1 md:grid-cols-3"><div class="analysis-table-cell font-semibold">Strategi "Aman"</div><div class="analysis-table-cell" id="long-strategi">-</div><div class="analysis-table-cell" id="short-strategi">-</div></div>
    <div class="grid grid-cols-1 md:grid-cols-3"><div class="analysis-table-cell font-semibold">Probabilitas</div><div class="analysis-table-cell" id="long-probabilitas">-</div><div class="analysis-table-cell" id="short-probabilitas">-</div></div>
    <div class="grid grid-cols-1 md:grid-cols-3"><div class="analysis-table-cell font-semibold">Area Entry</div><div class="analysis-table-cell" id="long-entry">-</div><div class="analysis-table-cell" id="short-entry">-</div></div>
    <div class="grid grid-cols-1 md:grid-cols-3"><div class="analysis-table-cell font-semibold">Pemicu/Konfirmasi</div><div class="analysis-table-cell" id="long-pemicu">-</div><div class="analysis-table-cell" id="short-pemicu">-</div></div>
    <div class="grid grid-cols-1 md:grid-cols-3"><div class="analysis-table-cell font-semibold">Stop Loss</div><div class="analysis-table-cell" id="long-sl">-</div><div class="analysis-table-cell" id="short-sl">-</div></div>
    <div class="grid grid-cols-1 md:grid-cols-3"><div class="analysis-table-cell font-semibold">Alasan Stop Loss</div><div class="analysis-table-cell text-xs italic" id="long-alasan-sl">-</div><div class="analysis-table-cell text-xs italic" id="short-alasan-sl">-</div></div>
    <div class="grid grid-cols-1 md:grid-cols-3"><div class="analysis-table-cell font-semibold">Target Profit</div><div class="analysis-table-cell" id="long-tp">-</div><div class="analysis-table-cell" id="short-tp">-</div></div>
    <div class="grid grid-cols-1 md:grid-cols-3"><div class="analysis-table-cell font-semibold">Alasan Target Profit</div><div class="analysis-table-cell text-xs italic" id="long-alasan-tp">-</div><div class="analysis-table-cell text-xs italic" id="short-alasan-tp">-</div></div>
    <div class="grid grid-cols-1 md:grid-cols-3"><div class="analysis-table-cell font-semibold">Aksi</div><div class="analysis-table-cell"><button class="use-data-btn w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-2 rounded" data-setup="long">Gunakan Data</button></div><div class="analysis-table-cell"><button class="use-data-btn w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-2 rounded" data-setup="short">Gunakan Data</button></div></div>
 </div>

 <div class="space-y-4 md:hidden">
     <div class="bg-gray-900 rounded-lg p-4">
        <h3 class="font-bold text-lg text-green-400 mb-3 pb-2 border-b border-gray-700">Setup LONG</h3>
        <div class="space-y-3 text-sm">
            <div><strong class="text-gray-400 block">Kondisi Pasar:</strong> <span id="mobile-long-kondisi">-</span></div>
            <div><strong class="text-gray-400 block">Strategi "Aman":</strong> <span id="mobile-long-strategi">-</span></div>
            <div><strong class="text-gray-400 block">Probabilitas:</strong> <span id="mobile-long-probabilitas">-</span></div>
            <div><strong class="text-gray-400 block">Area Entry:</strong> <span id="mobile-long-entry">-</span></div>
            <div><strong class="text-gray-400 block">Pemicu/Konfirmasi:</strong> <span id="mobile-long-pemicu">-</span></div>
            <div><strong class="text-gray-400 block">Stop Loss:</strong> <span id="mobile-long-sl">-</span></div>
            <div><strong class="text-gray-400 block">Alasan SL:</strong> <i id="mobile-long-alasan-sl">-</i></div>
            <div><strong class="text-gray-400 block">Target Profit:</strong> <span id="mobile-long-tp">-</span></div>
            <div><strong class="text-gray-400 block">Alasan TP:</strong> <i id="mobile-long-alasan-tp">-</i></div>
            <button class="use-data-btn w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-2 rounded mt-2" data-setup="long">Gunakan Data</button>
        </div>
     </div>
     <div class="bg-gray-900 rounded-lg p-4">
        <h3 class="font-bold text-lg text-red-400 mb-3 pb-2 border-b border-gray-700">Setup SHORT</h3>
        <div class="space-y-3 text-sm">
            <div><strong class="text-gray-400 block">Kondisi Pasar:</strong> <span id="mobile-short-kondisi">-</span></div>
            <div><strong class="text-gray-400 block">Strategi "Aman":</strong> <span id="mobile-short-strategi">-</span></div>
            <div><strong class="text-gray-400 block">Probabilitas:</strong> <span id="mobile-short-probabilitas">-</span></div>
            <div><strong class="text-gray-400 block">Area Entry:</strong> <span id="mobile-short-entry">-</span></div>
            <div><strong class="text-gray-400 block">Pemicu/Konfirmasi:</strong> <span id="mobile-short-pemicu">-</span></div>
            <div><strong class="text-gray-400 block">Stop Loss:</strong> <span id="mobile-short-sl">-</span></div>
            <div><strong class="text-gray-400 block">Alasan SL:</strong> <i id="mobile-short-alasan-sl">-</i></div>
            <div><strong class="text-gray-400 block">Target Profit:</strong> <span id="mobile-short-tp">-</span></div>
            <div><strong class="text-gray-400 block">Alasan TP:</b> <i id="mobile-short-alasan-tp">-</i></div>
            <button class="use-data-btn w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-2 rounded mt-2" data-setup="short">Gunakan Data</button>
        </div>
     </div>
 </div>
                                 <div class="mt-4 bg-blue-900/50 border-l-4 border-blue-400 p-4 rounded-r-lg"><h4 class="font-bold text-lg text-white mb-2">Rekomendasi Utama:</h4><p id="rekomendasi-text" class="text-blue-200">-</p></div>
                                 
                                 <div id="saran-container" class="mt-4 hidden">
                                     <div class="bg-purple-900/50 border-l-4 border-purple-400 p-4 rounded-r-lg">
                                         <h4 class="font-bold text-lg text-purple-300 mb-2">‚ú® Saran Peningkatan Analisa AI</h4>
                                         <p id="saran-text" class="text-purple-200 text-sm">-</p>
                                     </div>
                                 </div>
                            </div>
                             <div id="optimization-container" class="mt-4 hidden">
                                 <button id="optimize-plan-btn" class="w-full bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition">‚ú® Minta Tinjauan & Optimasi Rencana</button>
                                 <div id="optimization-output" class="mt-4 bg-gray-900 p-4 rounded-lg hidden"></div>
                             </div>
                             <button id="export-btn" class="mt-4 w-full bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 transition">Ekspor Laporan (Gambar)</button>
                        </div>
                    </div>
                    <div id="kalkulator" class="tab-pane hidden">
                       <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-gray-900 p-4 rounded-lg space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="font-semibold text-gray-300">Total Modal ($)</label><input type="number" id="calc-modal" class="kalkulator-input mt-1" value="250"></div>
                                    <div><label class="font-semibold text-gray-300">Risiko/Trade (%)</label><input type="number" id="calc-risiko-pct" class="kalkulator-input mt-1" value="1.5" step="0.1"></div>
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-300">Pilih Posisi</label>
                                    <div class="grid grid-cols-2 gap-2 mt-1">
                                        <button id="btn-posisi-long" class="posisi-btn long p-2 rounded-lg bg-gray-700">LONG</button>
                                        <button id="btn-posisi-short" class="posisi-btn short p-2 rounded-lg bg-gray-700">SHORT</button>
                                    </div>
                                </div>
                                <div><label class="font-semibold text-gray-300">Harga Acuan (dari Zona Entry)</label><input type="number" id="calc-entry" step="any" class="kalkulator-input mt-1" placeholder="0.00"></div>
                                <div><label class="font-semibold text-gray-300">Leverage Pilihanmu (x)</label><input type="number" id="calc-leverage" class="kalkulator-input mt-1" value="10"></div>
                                <div>
                                    <label class="font-semibold text-gray-300">Biaya Posisi Manual ($) <span class="text-gray-500 text-xs italic">- Opsional</span></label>
                                    <input type="number" id="calc-margin-manual" class="kalkulator-input mt-1" placeholder="Ganti perhitungan otomatis">
                                </div>
                                <div><label class="font-semibold text-gray-300">Stop Loss</label><input type="number" id="calc-sl" step="any" class="kalkulator-input mt-1" placeholder="0.00"></div>
                                <div><label class="font-semibold text-gray-300">Manajemen Take Profit</label>
                                    <div class="space-y-2 mt-1">
                                        <div class="flex items-center gap-2"><input type="number" id="calc-tp1" step="any" class="kalkulator-input" placeholder="Harga TP 1"><input type="number" id="calc-tp1-pct" class="kalkulator-input w-24" value="50" placeholder="%"></div>
                                        <div class="flex items-center gap-2"><input type="number" id="calc-tp2" step="any" class="kalkulator-input" placeholder="Harga TP 2"><input type="number" id="calc-tp2-pct" class="kalkulator-input w-24" value="30" placeholder="%"></div>
                                        <div class="flex items-center gap-2"><input type="number" id="calc-tp3" step="any" class="kalkulator-input" placeholder="Harga TP 3"><input type="number" id="calc-tp3-pct" class="kalkulator-input w-24" value="20" placeholder="%"></div>
                                    </div>
                                </div>
                                <button id="hitung-rencana-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition">HITUNG RENCANA</button>
                            </div>
                            <div class="bg-gray-900 p-4 rounded-lg">
                                <h3 class="font-bold text-xl mb-4 text-white border-b border-gray-700 pb-2">Rencana Trading</h3>
                                <div id="kalkulator-hasil" class="space-y-3 hidden">
                                    <div class="flex justify-between items-baseline"><span id="out-risiko-label" class="font-semibold text-gray-400">Risiko per Trade (1.5%):</span><span id="out-risiko" class="font-bold text-lg text-red-400">$0.00</span></div>
                                    <div class="flex justify-between items-baseline"><span class="font-semibold text-gray-400">Ukuran Posisi (USD):</span><span id="out-posisi" class="font-bold text-lg text-white">$0.00</span></div>
                                    <div class="bg-blue-900/50 p-3 rounded-lg text-center"><p class="text-sm text-blue-300">Biaya Posisi (Margin)</p><p id="out-margin" class="font-bold text-2xl text-white">$0.00</p></div>
                                    <div class="flex justify-between items-baseline"><span class="font-semibold text-gray-400">Rekomendasi Leverage Aman:</span><span id="out-leverage-aman" class="font-bold text-lg text-yellow-400">~1x</span></div>
                                    <div><h4 class="font-bold text-lg text-white mt-4">Potensi Profit:</h4>
                                        <div class="mt-2 space-y-2">
                                            <div class="flex justify-between"><span id="out-tp1-label">TP 1 (RR 1:0.0):</span><span id="out-tp1-profit" class="font-semibold text-green-400">~$0.00</span></div>
                                            <div class="flex justify-between"><span id="out-tp2-label">TP 2 (RR 1:0.0):</span><span id="out-tp2-profit" class="font-semibold text-green-400">~$0.00</span></div>
                                            <div class="flex justify-between"><span id="out-tp3-label">TP 3 (RR 1:0.0):</span><span id="out-tp3-profit" class="font-semibold text-green-400">~$0.00</span></div>
                                        </div>
                                    </div>
                                </div>
                                 <div id="kalkulator-placeholder" class="text-center text-gray-500 pt-16"><p>Klik "HITUNG RENCANA" untuk melihat hasil perhitungan di sini.</p></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="proyeksi" class="tab-pane hidden">
                        <h3 class="text-xl font-bold text-white mb-4">Analisa Proyeksi Harga Kripto</h3>
                        <div class="bg-gray-900 p-4 rounded-lg">
                            <p class="text-gray-300 mb-4">Dapatkan proyeksi harga untuk aset kripto berdasarkan analisis AI komprehensif. AI akan berusaha mencari data *real-time*.</p>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <input type="text" id="proyeksi-asset-input" list="asset-list" class="kalkulator-input flex-grow" placeholder="Ketik atau pilih aset: BTCUSDT, ETHUSDT...">
                                <datalist id="asset-list">
                                    <option value="BTCUSDT">
                                    <option value="ETHUSDT">
                                    <option value="SOLUSDT">
                                    <option value="BNBUSDT">
                                    <option value="XRPUSDT">
                                    <option value="1000PEPEUSDT">
                                </datalist>
                                <button id="generate-proyeksi-btn" class="w-full sm:w-auto bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition">üìä GO üèÅ</button>
                            </div>
                            <div id="proyeksi" class="tab-pane">
    <div class="bg-gray-900 p-4 rounded-lg">
        <div id="proyeksi-output" class="mt-6">
            </div>

        <div class="mt-4 p-3 bg-gray-800 rounded-lg hidden" id="proyeksi-live-price-container">
            <div class="flex items-center">
                <p class="text-sm text-gray-400 mr-2">Harga Live Terkini:</p>
                <span id="ws-status-indicator" class="h-3 w-3 rounded-full bg-gray-500" title="Status Koneksi Data"></span>
            </div>
            <p class="text-xl font-bold text-green-400" id="proyeksi-live-price-output">-</p>
        </div>

    </div>
</div>

                    <div id="backtest" class="tab-pane hidden">
                        <h3 class="text-xl font-bold text-white mb-4">‚öôÔ∏è Backtesting Strategi</h3>
                        <div class="bg-gray-900 p-4 rounded-lg">
                            <p class="text-gray-300 mb-4">Unggah gambar chart historis Anda dan deskripsikan strategi trading yang ingin Anda backtest. AI akan mensimulasikan hasilnya.</p>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-300 mb-1">Gambar Chart Historis <span class="text-green-400 text-xs italic">- Wajib</span></label>
                                <div id="backtest-drop-zone" class="chart-preview-container">
                                    <img id="backtest-chart-preview" src="" alt="Pratinjau Chart Backtest" class="hidden chart-preview">
                                    <div id="backtest-chart-placeholder" class="text-center text-gray-500 p-2 pointer-events-none"><p class="text-xs">Klik atau Drop gambar di sini</p></div>
                                </div>
                                <input type="file" id="backtest-chart-upload" class="hidden" accept="image/*">
                                <label for="backtest-chart-upload" class="mt-2 cursor-pointer w-full text-center bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition block">Pilih Gambar Chart Historis</label>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-300 mb-1">Deskripsi Strategi Trading <span class="text-green-400 text-xs italic">- Wajib</span></label>
                                <textarea id="backtest-strategy-input" rows="5" class="kalkulator-input mt-1" placeholder="Contoh: Entry LONG jika harga menyentuh support kuat dan RSI di bawah 30. SL 1% di bawah support. TP di resistance terdekat."></textarea>
                            </div>
                            <button id="run-backtest-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition disabled:bg-gray-500 disabled:cursor-not-allowed text-lg">BACKTEST ‚ñ∂Ô∏è</button>
                            <div id="backtest-output" class="mt-6">
                                <div id="backtest-placeholder" class="text-center text-gray-500 p-8"><p>Unggah gambar dan deskripsikan strategi untuk melihat hasil backtest AI di sini.</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // Tambahkan DUA fungsi ini di dekat fungsi bantuan lainnya

const calculateEMA = (data, period) => {
    if (!data || data.length < period) return [];
    const k = 2 / (period + 1);
    let emaArray = [data.slice(0, period).reduce((a, b) => a + b, 0) / period];
    for (let i = period; i < data.length; i++) {
        emaArray.push((data[i] * k) + (emaArray[emaArray.length - 1] * (1 - k)));
    }
    return emaArray;
};

const calculateBollingerBands = (closes, period = 20, stdDevMultiplier = 2) => {
    if (!closes || closes.length < period) return { upper: 0, middle: 0, lower: 0 };
    const middleBand = calculateSMA(closes.slice(-period), period)[0];
    if (middleBand === undefined) return { upper: 0, middle: 0, lower: 0 };
    
    const slice = closes.slice(-period);
    const stdDev = Math.sqrt(slice.map(p => Math.pow(p - middleBand, 2)).reduce((a, b) => a + b, 0) / period);
    
    return {
        upper: middleBand + (stdDev * stdDevMultiplier),
        middle: middleBand,
        lower: middleBand - (stdDev * stdDevMultiplier)
    };
};
    
    const calculateSMA = (data, period) => {
    if (!data || data.length < period) return [];
    const sma = [];
    for (let i = period - 1; i < data.length; i++) {
        const slice = data.slice(i - period + 1, i + 1);
        const sum = slice.reduce((a, b) => a + b, 0);
        sma.push(sum / period);
    }
    return sma;
};

const calculateRSI = (closes, period = 14) => {
    if (!closes || closes.length <= period) return 'N/A';
    
    let gains = [];
    let losses = [];
    for (let i = 1; i < closes.length; i++) {
        const diff = closes[i] - closes[i-1];
        if (diff >= 0) {
            gains.push(diff);
            losses.push(0);
        } else {
            gains.push(0);
            losses.push(Math.abs(diff));
        }
    }

    let avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
    let avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;

    for (let i = period; i < gains.length; i++) {
        avgGain = (avgGain * (period - 1) + gains[i]) / period;
        avgLoss = (avgLoss * (period - 1) + losses[i]) / period;
    }

    if (avgLoss === 0) return 100;
    const rs = avgGain / avgLoss;
    return (100 - (100 / (1 + rs))).toFixed(2);
};

    // --- STATE APLIKASI ---
    let htfImageBase64 = null;
    let ltfImageBase64 = null;
    let latestAnalysisData = null;
    let pricePrecision = 4; // Default presisi harga
    let binanceWebSocket = null; // Untuk menyimpan instance WebSocket
    let currentLivePrice = null; // Untuk menyimpan harga live terkini
    let lastFetchedSymbol = null; // Untuk melacak simbol yang sedang di-fetch
    let backtestImageBase64 = null;
    // [IMPROVEMENT] State untuk auto-reconnect WebSocket
    let reconnectAttempts = 0;
    
    // --- SELEKSI ELEMEN DOM ---
    const apiKeyInput = document.getElementById('api-key-input');
    const htfUploadInput = document.getElementById('htf-chart-upload');
    const htfChartPreview = document.getElementById('htf-chart-preview');
    const htfChartPlaceholder = document.getElementById('htf-chart-placeholder');
    const htfDropZone = document.getElementById('htf-drop-zone');
    const ltfUploadInput = document.getElementById('ltf-chart-upload');
    const ltfChartPreview = document.getElementById('ltf-chart-preview');
    const ltfChartPlaceholder = document.getElementById('ltf-chart-placeholder');
    const ltfDropZone = document.getElementById('ltf-drop-zone');
    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loader-text');
    const analyzeBtn = document.getElementById('analyze-btn');
    
    // Tampilan Analisa
    const analysisWrapper = document.getElementById('analysis-wrapper');
    const analysisPlaceholder = document.getElementById('analysis-placeholder');
    const analysisContent = document.getElementById('analysis-content');
    const exportBtn = document.getElementById('export-btn');
    
    // Tampilan Data Detektif
    const dataAsset = document.getElementById('data-asset');
    const dataTimeframe = document.getElementById('data-timeframe');
    const dataPrice = document.getElementById('data-price');
    const dataIndicators = document.getElementById('data-indicators');
    const rekomendasiText = document.getElementById('rekomendasi-text');
    const saranContainer = document.getElementById('saran-container');
    const saranText = document.getElementById('saran-text');

    // Input Kalkulator
    const calcModal = document.getElementById('calc-modal');
    const calcRisikoPct = document.getElementById('calc-risiko-pct');
    const btnPosisiLong = document.getElementById('btn-posisi-long');
    const btnPosisiShort = document.getElementById('btn-posisi-short');
    const calcEntry = document.getElementById('calc-entry');
    const calcLeverage = document.getElementById('calc-leverage');
    const calcMarginManual = document.getElementById('calc-margin-manual');
    const calcSl = document.getElementById('calc-sl');
    const calcTp1 = document.getElementById('calc-tp1');
    const calcTp2 = document.getElementById('calc-tp2');
    const calcTp3 = document.getElementById('calc-tp3');
    const hitungRencanaBtn = document.getElementById('hitung-rencana-btn');

    // Output Kalkulator
    const kalkulatorHasil = document.getElementById('kalkulator-hasil');
    const kalkulatorPlaceholder = document.getElementById('kalkulator-placeholder');
    const outRisikoLabel = document.getElementById('out-risiko-label');
    const outRisiko = document.getElementById('out-risiko');
    const outPosisi = document.getElementById('out-posisi');
    const outMargin = document.getElementById('out-margin');
    const outLeverageAman = document.getElementById('out-leverage-aman');
    const outTp1Label = document.getElementById('out-tp1-label');
    const outTp1Profit = document.getElementById('out-tp1-profit');
    const outTp2Label = document.getElementById('out-tp2-label');
    const outTp2Profit = document.getElementById('out-tp2-profit');
    const outTp3Label = document.getElementById('out-tp3-label');
    const outTp3Profit = document.getElementById('out-tp3-profit');

    // Elemen Fitur Baru
    const optimizationContainer = document.getElementById('optimization-container');
    const optimizePlanBtn = document.getElementById('optimize-plan-btn');
    const optimizationOutput = document.getElementById('optimization-output');

    // Elemen Proyeksi Harga
    const proyeksiAssetInput = document.getElementById('proyeksi-asset-input');
    const generateProyeksiBtn = document.getElementById('generate-proyeksi-btn');
    const proyeksiOutput = document.getElementById('proyeksi-output');
    const proyeksiPlaceholder = document.getElementById('proyeksi-placeholder');
    const proyeksiLivePriceOutput = document.getElementById('proyeksi-live-price-output'); 

    // Elemen Backtesting Strategi
    const backtestUploadInput = document.getElementById('backtest-chart-upload');
    const backtestChartPreview = document.getElementById('backtest-chart-preview');
    const backtestChartPlaceholder = document.getElementById('backtest-chart-placeholder');
    const backtestDropZone = document.getElementById('backtest-drop-zone');
    const backtestStrategyInput = document.getElementById('backtest-strategy-input');
    const runBacktestBtn = document.getElementById('run-backtest-btn');
    const backtestOutput = document.getElementById('backtest-output');
    const backtestPlaceholder = document.getElementById('backtest-placeholder');


    // --- FUNGSI BANTUAN (HELPER) ---
    const showLoader = (text) => {
        loaderText.textContent = text;
        loader.classList.remove('hidden');
    };
    const hideLoader = () => loader.classList.add('hidden');
    const parsePrice = (priceString) => {
        if (!priceString || typeof priceString !== 'string') return NaN;
        const match = priceString.replace(/,/g, '.').match(/[\d.]+/); 
        return match ? parseFloat(match[0]) : NaN;
    };
    const getDecimalPlaces = (value) => {
        const s_value = String(value);
        if (s_value.indexOf('.') === -1) {
            return 0;
        }
        return s_value.split('.')[1].length || 0;
    };
    const updateCalculatorInputSteps = (precision) => {
        const stepValue = precision > 0 ? '0.' + '0'.repeat(precision - 1) + '1' : '1';
        const priceInputs = [calcEntry, calcSl, calcTp1, calcTp2, calcTp3];
        priceInputs.forEach(input => {
            input.step = stepValue;
        });
    };
    const checkEnableAnalyzeButton = () => {
        analyzeBtn.disabled = !(apiKeyInput.value.trim() && ltfImageBase64);
    };
    const checkEnableBacktestButton = () => {
        runBacktestBtn.disabled = !(apiKeyInput.value.trim() && backtestImageBase64 && backtestStrategyInput.value.trim());
    };

    // --- LOGIKA UPLOAD & DRAG/DROP ---
    function handleFile(file, imgEl, placeholderEl, stateSetter, enableCheckFunc) {
        if (!file || !file.type.startsWith('image/')) {
            showCustomMessage('Harap unggah file gambar saja (PNG, JPG, dll).', 'error');
            return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
            stateSetter(e.target.result.split(',')[1]); 
            imgEl.src = e.target.result;
            imgEl.classList.remove('hidden');
            placeholderEl.classList.add('hidden');
            enableCheckFunc();
        };
        reader.readAsDataURL(file);
    }

    function setupDropZone(dropZoneEl, inputEl, imgEl, placeholderEl, stateSetter, enableCheckFunc) {
        dropZoneEl.addEventListener('click', () => inputEl.click());
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZoneEl.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });
        dropZoneEl.addEventListener('dragenter', () => dropZoneEl.classList.add('drag-over'));
        dropZoneEl.addEventListener('dragleave', () => dropZoneEl.classList.remove('drag-over'));
        dropZoneEl.addEventListener('drop', (e) => {
            dropZoneEl.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            handleFile(file, imgEl, placeholderEl, stateSetter, enableCheckFunc);
        });
        inputEl.addEventListener('change', (e) => {
            const file = e.target.files[0];
            handleFile(file, imgEl, placeholderEl, stateSetter, enableCheckFunc);
        });
    }

    // --- LOGIKA INTI AI (GEMINI) ---
    function cleanAndParseJson(rawText) {
        console.log("Raw text from AI for parsing:", rawText);
        let jsonString = rawText;
        const markdownMatch = rawText.match(/```json\s*([\s\S]*?)\s*```/);
        if (markdownMatch && markdownMatch[1]) {
            jsonString = markdownMatch[1];
        } else {
            const braceMatch = rawText.match(/\{[\s\S]*\}/);
            if (braceMatch && braceMatch[0]) {
                jsonString = braceMatch[0];
            } else {
                throw new Error("Tidak ada blok JSON yang dapat dikenali dalam respons AI.");
            }
        }
        try {
            return JSON.parse(jsonString);
        } catch (e) {
            console.error("JSON parsing error. Problematic string:", jsonString);
            throw new Error(`Gagal mem-parsing JSON dari AI. Error: ${e.message}`);
        }
    }

    async function callGemini(parts, isJsonOutput = true) {
        const apiKey = apiKeyInput.value.trim();
        if (!apiKey) throw new Error("API Key belum dimasukkan.");
        const model = 'gemini-1.5-flash-latest'; // Menggunakan model flash terbaru
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
        const payload = { contents: [{ role: "user", parts }] };
        if (isJsonOutput) {
            payload.generationConfig = {
                "response_mime_type": "application/json",
            };
        }
        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!response.ok) {
            const errorBody = await response.json();
            const errorMessage = errorBody?.error?.message || `Permintaan API gagal: ${response.status}`;
            if (response.status === 429) throw new Error("Terlalu banyak permintaan (Rate Limit). Coba lagi nanti.");
            if (response.status === 503) throw new Error("Layanan AI sedang sibuk (Error 503). Coba lagi.");
            throw new Error(errorMessage);
        }
        const result = await response.json();
        if (result.candidates && result.candidates[0] && result.candidates[0].content.parts[0]) {
            return result.candidates[0].content.parts[0].text.trim();
        } else {
            if (result.promptFeedback && result.promptFeedback.blockReason) {
                throw new Error(`Permintaan diblokir oleh AI: ${result.promptFeedback.blockReason}`);
            }
            throw new Error("Struktur respons dari AI tidak valid atau kosong.");
        }
    }
    
    // [IMPROVEMENT] Function to fetch additional market data from Binance
    async function fetchBinanceAPIData(endpoint, params = {}) {
        const query = new URLSearchParams(params).toString();
        const url = `https://fapi.binance.com/fapi/v1/${endpoint}?${query}`;
        try {
            const response = await fetch(url);
            if (!response.ok) {
                console.error(`Binance API Error ${response.status}: ${await response.text()}`);
                return null;
            }
            return response.json();
        } catch (error) {
            console.error(`Kesalahan Jaringan saat fetch ke Binance: ${error.message}`);
            return null;
        }
    }

    async function extractKeyData(imageBase64) {
        const prompt = `Anda adalah AI OCR yang memiliki akurasi tinggi. Tugas Anda adalah mengekstrak data dari gambar chart trading dengan mengikuti ATURAN PALING KETAT.
        
        1.  **Harga Terakhir (lastPrice)**: Ini adalah tugas paling penting. Lakukan dengan urutan ini, JANGAN DILANGGAR:
            * **Langkah A (Prioritas Utama):** Fokus pada SUMBU HARGA di sisi KANAN chart. Cari KOTAK LABEL HARGA (seringkali berwarna atau memiliki timer countdown) yang menempel di sumbu tersebut. Angka di dalam kotak ini adalah 'lastPrice' yang benar.
            * **Langkah B (Jika Langkah A Gagal):** Jika tidak ada kotak label, cari GARIS HORIZONTAL PUTUS-PUTUS yang berasal dari candle terakhir menuju sumbu harga. Baca angka pada sumbu harga yang DITUNJUK OLEH GARIS ITU.
            * **ZONA TERLARANG:** JANGAN PERNAH mengambil angka dari LEGENDA di pojok KIRI ATAS (yang berisi info O,H,L,C atau nama indikator seperti Bollinger, EMA). Area ini seringkali berisi angka yang salah dan MENIPU. Abaikan sepenuhnya area ini untuk mencari harga.
        2.  **Aset & Timeframe**: Identifikasi dari teks di pojok kiri atas.
        3.  **Indikator (identifiedIndicators)**: Identifikasi SEMUA nama indikator yang terlihat (misal: 'Bollinger Bands', 'EMA', 'RSI', 'MACD', 'Volume').
        4. Identifikasi pola candle potennsial pada 3 candle terakhir pada lower time frame chart

        Jika data tidak ada, gunakan "Tidak Terdeteksi". JANGAN MENEBAK.

        Balas HANYA dengan satu objek JSON valid dengan skema ini: {"type": "object", "properties": {"isChart": {"type": "boolean"}, "asset": {"type": "string"}, "timeframe": {"type": "string"}, "lastPrice": {"type": "string"}, "identifiedIndicators": {"type": "array", "items": {"type": "string"}}}}
        Jika gambar bukan chart trading, balas dengan: {"isChart": false}.`;
        
        const parts = [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: imageBase64 } }];
        const jsonText = await callGemini(parts, true);
        return cleanAndParseJson(jsonText);
    }

    async function startAnalysis() {
        if (!ltfImageBase64) {
            showCustomMessage("Harap unggah gambar Chart LTF terlebih dahulu.", "error");
            return;
        }
        
        showLoader('Mengekstrak Data (1/2)...');
        analyzeBtn.disabled = true;
        analysisPlaceholder.classList.remove('hidden');
        analysisWrapper.classList.add('hidden');
        optimizationContainer.classList.add('hidden');
        saranContainer.classList.add('hidden');

        try {
            const keyData = await extractKeyData(ltfImageBase64);
            if (!keyData || !keyData.isChart) {
                throw new Error("Gambar yang diunggah bukan chart trading yang valid.");
            }
            
            dataAsset.textContent = keyData.asset || 'N/A';
            dataTimeframe.textContent = keyData.timeframe || 'N/A';
            dataPrice.textContent = keyData.lastPrice || 'N/A';
            dataIndicators.textContent = keyData.identifiedIndicators?.join(', ') || 'Tidak ada terdeteksi';

            const lastPriceNumber = parsePrice(keyData.lastPrice);
            if (!isNaN(lastPriceNumber)) {
                pricePrecision = getDecimalPlaces(lastPriceNumber);
                updateCalculatorInputSteps(pricePrecision);
            }

            showLoader('Sabar Bro Sedang Mempertajam Analisa (2/2)...');
            
            let analysisParts = [];
            const assetInfo = keyData.asset || 'aset ini';
            
            const jsonSchema = `{
                "longSetup": { "kondisiPasar": "string", "strategiAman": "string", "probabilitas": "string", "areaEntry": "string", "pemicuKonfirmasi": "string", "stopLoss": "string", "alasanStopLoss": "string", "targetProfit": {"tp1": "string", "tp2": "string", "tp3": "string"}, "alasanTargetProfit": "string" },
                "shortSetup": { "kondisiPasar": "string", "strategiAman": "string", "probabilitas": "string", "areaEntry": "string", "pemicuKonfirmasi": "string", "stopLoss": "string", "alasanStopLoss": "string", "targetProfit": {"tp1": "string", "tp2": "string", "tp3": "string"}, "alasanTargetProfit": "string" },
                "rekomendasiUtama": "string",
                "saranPeningkatan": "string"
            }`;

            let basePrompt = `ANDA WAJIB MEMATUHI STRUKTUR JSON INI TANPA PENGECUALIAN. Seluruh output Anda HARUS berupa satu objek JSON valid tunggal. Jangan menambahkan teks atau field lain di luar skema.
            Anda adalah "Valhalla", analis profesional scalping dengan reputasi tinggi dalam presisi dan manajemen risiko ekstrem. Keahlian Anda berakar kuat pada teori teknikal yang telah terbukti seperti price action, struktur pasar, dan indikator konfirmatif. Pengguna sedang menganalisa ${assetInfo}. Tugas Anda adalah menyusun strategi scalping yang super aman, super jitu, dan berbasis logika teknikal yang tervalidasi.\n`;
            
            if (keyData.identifiedIndicators && keyData.identifiedIndicators.length > 0) {
                basePrompt += `Indikator berikut telah teridentifikasi pada chart: ${keyData.identifiedIndicators.join(', ')}. **WAJIB** gunakan pembacaan dari indikator-indikator ini dalam analisamu, terutama di bagian 'Kondisi Pasar' dan 'Pemicu/Konfirmasi'. Cobalah untuk membaca nilai aktual dari indikator tersebut (misal: level RSI, apakah Stochastic sedang overbought/oversold).\n`;
            }

            basePrompt += `- Untuk setiap parameter ('Kondisi Pasar', 'Strategi Aman', 'Pemicu/Konfirmasi'), berikan penjelasan yang **detail dan mendalam**, bukan hanya satu kalimat tapi tetap fokus.
                Berikan deskripsi teknikal yang menyeluruh: arah tren (naik/turun/sideways), kekuatan tren (misal: divergensi RSI, crossing MA), zona penting (support/resistance), serta sinyal teknikal yang relevan dari indikator yang terlihat.
                Jelaskan alasan teknikal mengapa pasar saat ini dikategorikan dalam kondisi tersebut ataupun jika bisa meningkatkan validitasnya bisa tanbahkan analisa market structure berdasarkan strategi smart money concept (yang terlihat dalam chart).
                Gunakan istilah baku (tebalkan kata): bullish, bearish, ranging, break/retest, dll..
            - Untuk 'areaEntry' dan 'stopLoss', **WAJIB** untuk menyertakan **level harga spesifik** di dalam teksnya. Contoh: "Area entry di sekitar 150.00 - 151.00 karena merupakan zona support." atau "Stop loss di 148.00, tepat di bawah swing low terakhir."
            - Field 'probabilitas' HARUS menyertakan istilah deskriptif dan persentase (misal, "Tinggi (70%)").
            - Berikan 3 level Target Profit (TP1, TP2, TP3) yang realistis untuk scalping, masing-masing dengan harga spesifik dan alasan teknikal singkat.  (misal: "TP1 di 152.00, resistance minor sebelumnya").
            - **PENTING**: Berikan alasan singkat dan jelas untuk nilai 'stopLoss' dan 'targetProfit' yang Anda tentukan. Alasan harus berdasarkan struktur pasar yang terlihat di chart (misal: "di bawah swing low terakhir", "di area resistance terdekat").
            - **SARAN PENINGKATAN**: Setelah analisa selesai, berikan satu saran singkat di field 'saranPeningkatan' tentang bagaimana analisa ini bisa lebih divalidasi. Contoh: "Untuk konfirmasi lebih kuat, perhatikan volume saat breakout" atau "Analisa akan lebih kuat jika dikonfirmasi dengan indikator RSI". Jika analisa sudah sangat kuat, isi dengan "Analisa saat ini sudah cukup komprehensif."
            - Dasarkan analisa Anda HANYA pada informasi visual di chart. Seluruh output Anda harus berupa satu objek JSON valid yang sesuai dengan struktur berikut: ${jsonSchema} \n
            
            Format jawaban Anda dengan jelas menggunakan poin-poin. Jangan gunakan format Markdown. Cukup teks biasa dengan baris baru.`;

            if(htfImageBase64) {
                analysisParts.push(
                    { text: `${basePrompt} Pengguna telah memberikan DUA gambar untuk analisa Multi-Timeframe (MTF).
                    - Gambar PERTAMA adalah chart Higher Timeframe (HTF). Analisa ini untuk menentukan tren dan bias pasar utama (bullish/bearish/ranging).
                    - Gambar KEDUA adalah chart Lower Timeframe (LTF). Gunakan bias dari HTF sebagai filter utama untuk menemukan setup probabilitas tertinggi di LTF. 'rekomendasiUtama' harus menyebutkan tren HTF.`},
                    { inlineData: { mimeType: "image/jpeg", data: htfImageBase64 } },
                    { inlineData: { mimeType: "image/jpeg", data: ltfImageBase64 } }
                );
            } else {
                analysisParts.push(
                    { text: `${basePrompt} Analisa gambar chart yang diberikan untuk membuat rencana trading detail untuk LONG dan SHORT.`},
                    { inlineData: { mimeType: "image/jpeg", data: ltfImageBase64 } }
                );
            }

            const analysisJsonText = await callGemini(analysisParts, true);
            const strategicData = cleanAndParseJson(analysisJsonText);

            latestAnalysisData = { keyData, ...strategicData };
            updateAnalysisUI(latestAnalysisData);

        } catch (error) {
            console.error("Kesalahan Analisa:", error);
            analysisPlaceholder.innerHTML = `<p class="text-red-400 p-4">Maaf, terjadi kesalahan saat menganalisa chart.<br><span class="text-xs text-gray-400">${error.message}</span></p>`;
            analysisPlaceholder.classList.remove('hidden');
            analysisWrapper.classList.add('hidden');
        } finally {
            hideLoader();
            checkEnableAnalyzeButton();
        }
    }
    
    function updateAnalysisUI(data) {
        if (!data || !data.longSetup || !data.shortSetup) {
            analysisPlaceholder.innerHTML = `<p class="text-red-400 p-4">Struktur data strategi dari AI tidak sesuai. Coba analisa ulang.</p>`;
            analysisWrapper.classList.add('hidden');
            analysisPlaceholder.classList.remove('hidden');
            return;
        }
        
        analysisPlaceholder.classList.add('hidden');
        analysisWrapper.classList.remove('hidden');
        optimizationContainer.classList.remove('hidden');
        
        const { longSetup, shortSetup, rekomendasiUtama, saranPeningkatan } = data;
        
        const fieldMap = {
            'kondisi': 'kondisiPasar', 'strategi': 'strategiAman', 'probabilitas': 'probabilitas',
            'entry': 'areaEntry', 'pemicu': 'pemicuKonfirmasi', 'sl': 'stopLoss',
            'alasan-sl': 'alasanStopLoss', 'alasan-tp': 'alasanTargetProfit'
        };

        Object.entries(fieldMap).forEach(([uiField, jsonKey]) => {
            const longValue = longSetup?.[jsonKey]?.replace(/\n/g, '<br />') || '-';
            const shortValue = shortSetup?.[jsonKey]?.replace(/\n/g, '<br />') || '-';

            document.getElementById(`long-${uiField}`).innerHTML = longValue;
            document.getElementById(`short-${uiField}`).innerHTML = shortValue;
            
            const mobileLongEl = document.getElementById(`mobile-long-${uiField}`);
            if(mobileLongEl) mobileLongEl.innerHTML = longValue;
            
            const mobileShortEl = document.getElementById(`mobile-short-${uiField}`);
            if(mobileShortEl) mobileShortEl.innerHTML = shortValue;
        });

        const formatTp = (tpData) => {
            if (tpData && typeof tpData === 'object') {
                return `TP1: ${tpData.tp1 || '-'}<br>TP2: ${tpData.tp2 || '-'}<br>TP3: ${tpData.tp3 || '-'}`;
            }
            return tpData || '-';
        };
        
        const longTpFormatted = formatTp(longSetup.targetProfit);
        const shortTpFormatted = formatTp(shortSetup.targetProfit);

        document.getElementById('long-tp').innerHTML = longTpFormatted;
        document.getElementById('short-tp').innerHTML = shortTpFormatted;
        document.getElementById('mobile-long-tp').innerHTML = longTpFormatted;
        document.getElementById('mobile-short-tp').innerHTML = shortTpFormatted;

        rekomendasiText.innerHTML = rekomendasiUtama?.replace(/\n/g, '<br />') || '-';
        
        if (saranPeningkatan && !saranPeningkatan.toLowerCase().includes("cukup komprehensif")) {
            saranText.textContent = saranPeningkatan;
            saranContainer.classList.remove('hidden');
        } else {
            saranContainer.classList.add('hidden');
        }
        
        ['long', 'short'].forEach(type => {
            const probCellDesktop = document.getElementById(`${type}-probabilitas`);
            const probCellMobile = document.getElementById(`mobile-${type}-probabilitas`);
            const probData = (type === 'long' ? longSetup : shortSetup)?.probabilitas;

            [probCellDesktop, probCellMobile].forEach(cell => {
                 if(cell) {
                    cell.classList.remove('highlight-pulse');
                    if (probData && (probData.toLowerCase().includes('prioritas') || probData.toLowerCase().includes('tinggi'))) {
                        cell.classList.add('highlight-pulse');
                    }
                }
            });
        });
    }

    function exportReport() {
        showLoader('Mempersiapkan Laporan...');
        html2canvas(document.getElementById('analysis-content'), { backgroundColor: '#111827', scale: 2 })
            .then(canvas => {
                const link = document.createElement('a');
                link.download = `Co-Pilot_Report_${dataAsset.textContent || 'report'}_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                hideLoader();
            }).catch(err => {
                console.error('Ekspor gagal:', err);
                hideLoader();
                showCustomMessage('Gagal mengekspor laporan.', 'error');
            });
    }
    
    function populateCalculatorFromAnalysis(setupType) {
        if (!latestAnalysisData) {
            showCustomMessage("Lakukan analisa chart terlebih dahulu.", 'info');
            return;
        }

        const setupData = (setupType === 'long') ? latestAnalysisData.longSetup : latestAnalysisData.shortSetup;

        if (!setupData || !setupData.areaEntry || setupData.areaEntry.toLowerCase().includes("tidak ada")) {
            showCustomMessage(`Data analisa untuk setup ${setupType.toUpperCase()} tidak tersedia.`, 'info');
            return;
        }

        const formatValue = (valueString) => {
            const parsed = parsePrice(valueString);
            return isNaN(parsed) ? '' : parsed.toFixed(pricePrecision);
        };

        calcEntry.value = formatValue(setupData.areaEntry);
        calcSl.value = formatValue(setupData.stopLoss);
        
        if (setupData.targetProfit && typeof setupData.targetProfit === 'object') {
            calcTp1.value = formatValue(setupData.targetProfit.tp1);
            calcTp2.value = formatValue(setupData.targetProfit.tp2);
            calcTp3.value = formatValue(setupData.targetProfit.tp3);
        } else {
            const tpLines = (setupData.targetProfit || '').split(/<br\s*\/?>|\n/);
            calcTp1.value = formatValue(tpLines[0]);
            calcTp2.value = formatValue(tpLines[1]);
            calcTp3.value = formatValue(tpLines[2]);
        }
    }

    function useAnalysisData(e) {
        const setupType = e.target.dataset.setup;
        btnPosisiLong.classList.toggle('active', setupType === 'long');
        btnPosisiLong.classList.toggle('long', setupType === 'long');
        btnPosisiShort.classList.toggle('active', setupType === 'short');
        btnPosisiShort.classList.toggle('short', setupType === 'short');
        populateCalculatorFromAnalysis(setupType);
        document.querySelector('.tab-button[data-tab="kalkulator"]').click();
        calcEntry.focus();
    }
    
    function hitungRencana() {
        const [totalModal, risikoPct, entryPrice, slPrice, leverage, manualMargin] = 
            [calcModal, calcRisikoPct, calcEntry, calcSl, calcLeverage, calcMarginManual].map(el => parseFloat(el.value));

        if ([totalModal, entryPrice, slPrice, leverage].some(isNaN)) {
             showCustomMessage("Pastikan Modal, Harga Entry, Stop Loss, dan Leverage terisi.", "error");
             return;
        }
        if (isNaN(risikoPct) && isNaN(manualMargin)) {
            showCustomMessage("Harap isi 'Risiko/Trade (%)' atau 'Biaya Posisi Manual ($)'.", "error");
            return;
        }

        kalkulatorPlaceholder.classList.add('hidden');
        kalkulatorHasil.classList.remove('hidden');
        
        let risikoUSD, ukuranPosisiUSD, marginUSD;
        const jarakSL = Math.abs(entryPrice - slPrice);
        if (jarakSL === 0) {
            showCustomMessage("Jarak Stop Loss tidak boleh nol.", "error");
            return;
        }

        if (manualMargin > 0) {
            marginUSD = manualMargin;
            ukuranPosisiUSD = marginUSD * leverage;
            risikoUSD = ukuranPosisiUSD * (jarakSL / entryPrice);
            const effectiveRisikoPct = (risikoUSD / totalModal) * 100;
            outRisikoLabel.textContent = `Risiko per Trade (${effectiveRisikoPct.toFixed(2)}%):`;
            calcRisikoPct.value = effectiveRisikoPct.toFixed(2);
        } else {
            risikoUSD = totalModal * (risikoPct / 100);
            ukuranPosisiUSD = risikoUSD / (jarakSL / entryPrice);
            marginUSD = ukuranPosisiUSD / leverage;
            outRisikoLabel.textContent = `Risiko per Trade (${risikoPct}%):`;
            calcMarginManual.value = '';
        }

        outRisiko.textContent = `$${risikoUSD.toFixed(2)}`;
        outPosisi.textContent = `$${ukuranPosisiUSD.toFixed(2)}`;
        outMargin.textContent = `$${marginUSD.toFixed(2)}`;
        outLeverageAman.textContent = `~${(ukuranPosisiUSD / totalModal).toFixed(1)}x`;

        [{el: calcTp1, label: outTp1Label, profit: outTp1Profit}, {el: calcTp2, label: outTp2Label, profit: outTp2Profit}, {el: calcTp3, label: outTp3Label, profit: outTp3Profit}].forEach((tp, i) => {
            const tpPrice = parseFloat(tp.el.value);
            if (!isNaN(tpPrice) && jarakSL > 0) {
                const rr = Math.abs(tpPrice - entryPrice) / jarakSL;
                tp.label.textContent = `TP ${i+1} (RR 1:${rr.toFixed(1)}):`;
                tp.profit.textContent = `~$${(rr * risikoUSD).toFixed(2)}`;
            } else {
                 tp.label.textContent = `TP ${i+1}:`;
                 tp.profit.textContent = `~$0.00`;
            }
        });
    }

    async function optimizeTradePlan() {
        if (!latestAnalysisData) { showCustomMessage("Lakukan analisa chart terlebih dahulu.", "error"); return; }
        showLoader("Meminta tinjauan dari manajer risiko AI...");
        optimizationOutput.classList.add('hidden');
        try {
            const planString = JSON.stringify(latestAnalysisData, null, 2);
            const prompt = `Anda adalah seorang manajer risiko trading yang sangat berpengalaman. Diberikan sebuah rencana trading dalam format JSON berikut untuk aset ${latestAnalysisData.keyData.asset}.
            Rencana Trading:
            ${planString}

            Tugas Anda adalah meninjau rencana ini secara kritis namun "padat". Berikan umpan balik yang membangun dalam Bahasa Indonesia. Fokus pada:
            1.  **Validasi Setup**: Apakah ada kelemahan dalam logika setup yang diusulkan?
            2.  **Manajemen Risiko**: Apakah Stop Loss sudah optimal? Apakah ada cara untuk memperketatnya?
            3.  **Skenario Alternatif**: Apa skenario lain yang mungkin terjadi yang tidak dipertimbangkan?
            4.  **Peringatan**: Apa risiko eksternal terbesar (misal, berita terbaru yang up to date) yang harus diwaspadai?
            
            Format jawaban Anda dengan jelas menggunakan poin-poin. Jangan gunakan format Markdown. Cukup teks biasa dengan baris baru.`;

            const optimizationText = await callGemini([{ text: prompt }], false);
            optimizationOutput.innerHTML = `<h4 class="font-bold text-lg text-purple-300 mb-2">Tinjauan Manajer Risiko AI</h4><p class="text-sm text-gray-300 whitespace-pre-wrap">${optimizationText}</p>`;
            optimizationOutput.classList.remove('hidden');

        } catch (error) {
            optimizationOutput.innerHTML = `<p class="text-red-400">Gagal mendapatkan tinjauan: ${error.message}</p>`;
            optimizationOutput.classList.remove('hidden');
        } finally {
            hideLoader();
        }
    }

    // [IMPROVEMENT] Fungsi untuk Analisa Proyeksi Harga (DITINGKATKAN)
    // Ganti seluruh fungsi startPriceProjection lama Anda dengan yang ini
async function startPriceProjection() {
    const assetSymbol = proyeksiAssetInput.value.trim().toUpperCase();
    if (!assetSymbol) {
        showCustomMessage("Harap masukkan simbol aset kripto (contoh: BTCUSDT).", "error");
        return;
    }

    currentLivePrice = null;
    if (lastFetchedSymbol !== assetSymbol.toLowerCase() || !binanceWebSocket || binanceWebSocket.readyState !== WebSocket.OPEN) {
        initBinanceWebSocket(assetSymbol);
    }

    showLoader(`Menghubungkan ke data live untuk ${assetSymbol}...`);
    proyeksiOutput.innerHTML = '';
    proyeksiPlaceholder.classList.add('hidden');

    try {
        let attempts = 0;
        const maxAttempts = 20;
        while (currentLivePrice === null && attempts < maxAttempts) {
            await new Promise(resolve => setTimeout(resolve, 500));
            attempts++;
        }

        if (currentLivePrice === null) {
            throw new Error(`Gagal mengambil data harga live untuk ${assetSymbol}.`);
        }
        
        showLoader(`Mengumpulkan data pasar lengkap untuk ${assetSymbol}...`);

        const [
            tickerData, fundingData, openInterestData, lsRatioUmumData,
            lsRatioTopTraderData, klines30d, klines15m, klines1h, klines4h, klines1d
        ] = await Promise.all([
            fetchBinanceAPIData('ticker/24hr', { symbol: assetSymbol }),
            fetchBinanceAPIData('premiumIndex', { symbol: assetSymbol }),
            fetchBinanceAPIData('openInterest', { symbol: assetSymbol }),
            fetch(`https://fapi.binance.com/futures/data/globalLongShortAccountRatio?symbol=${assetSymbol}&period=5m&limit=1`).then(res => res.json()),
            fetch(`https://fapi.binance.com/futures/data/topLongShortAccountRatio?symbol=${assetSymbol}&period=5m&limit=1`).then(res => res.json()),
            fetchBinanceAPIData('klines', { symbol: assetSymbol, interval: '1d', limit: 30 }),
            fetchBinanceAPIData('klines', { symbol: assetSymbol, interval: '15m', limit: 100 }),
            fetchBinanceAPIData('klines', { symbol: assetSymbol, interval: '1h', limit: 100 }),
            fetchBinanceAPIData('klines', { symbol: assetSymbol, interval: '4h', limit: 100 }),
            fetchBinanceAPIData('klines', { symbol: assetSymbol, interval: '1d', limit: 100 })
        ]);

        const volume24h = tickerData ? parseFloat(tickerData.quoteVolume).toLocaleString('id-ID') : 'N/A';
        let volumePercentage = 'N/A';
        if (klines30d && tickerData) {
            const last7dVolumes = klines30d.slice(-7).map(k => parseFloat(k[7]));
            const avgVolume7d = last7dVolumes.reduce((a, b) => a + b, 0) / 7;
            const currentVolume = parseFloat(tickerData.quoteVolume);
            if (avgVolume7d > 0) volumePercentage = ((currentVolume / avgVolume7d - 1) * 100).toFixed(2);
        }
        
        const openInterest = openInterestData ? parseFloat(openInterestData.openInterest).toLocaleString('id-ID') : 'N/A';
        const lsRatioUmum = lsRatioUmumData?.[0]?.longShortRatio ? parseFloat(lsRatioUmumData[0].longShortRatio).toFixed(2) : 'N/A';
        const lsRatioTopTrader = lsRatioTopTraderData?.[0]?.longShortRatio ? parseFloat(lsRatioTopTraderData[0].longShortRatio).toFixed(2) : 'N/A';
        const fundingRate = fundingData ? (parseFloat(fundingData.lastFundingRate) * 100).toFixed(4) + '%' : 'N/A';
        
        let countdownFunding = 'N/A';
        if (fundingData && fundingData.nextFundingTime) {
            const timeLeftMs = parseInt(fundingData.nextFundingTime) - Date.now();
            if (timeLeftMs > 0) {
                const hours = Math.floor(timeLeftMs / 3600000);
                const minutes = Math.floor((timeLeftMs % 3600000) / 60000);
                countdownFunding = `${hours} jam ${minutes} menit`;
            }
        }

        const rsi15m = calculateRSI(klines15m.map(k => parseFloat(k[4])));
        const rsi1h = calculateRSI(klines1h.map(k => parseFloat(k[4])));
        const rsi4h = calculateRSI(klines4h.map(k => parseFloat(k[4])));
        const rsi1d = calculateRSI(klines1d.map(k => parseFloat(k[4])));
        
        // BLOK BARU (DENGAN KALKULASI)
const timeframes = {
    '15m': klines15m.map(k => parseFloat(k[4])),
    '1h': klines1h.map(k => parseFloat(k[4])),
    '4h': klines4h.map(k => parseFloat(k[4])),
    '1d': klines1d.map(k => parseFloat(k[4])),
};

const getIndicatorPositions = (closes) => {
    if (closes.length < 50) return { bb: 'Data Kurang', ema: 'Data Kurang' };
    const lastClose = closes[closes.length - 1];

    // Kalkulasi EMA50
    const ema50 = calculateEMA(closes, 50).pop();
    const posisiEma = lastClose > ema50 ? 'Di atas EMA50' : 'Di bawah EMA50';

    // Kalkulasi Bollinger Bands
    const bb = calculateBollingerBands(closes, 20, 2);
    let posisiBb = 'Di dalam Band';
    if (lastClose > bb.upper) posisiBb = 'Di atas Upper Band';
    if (lastClose < bb.lower) posisiBb = 'Di bawah Lower Band';
    
    return { bb: posisiBb, ema: posisiEma };
};

const indicatorPositions15m = getIndicatorPositions(timeframes['15m']);
const indicatorPositions1h = getIndicatorPositions(timeframes['1h']);
const indicatorPositions4h = getIndicatorPositions(timeframes['4h']);
const indicatorPositions1d = getIndicatorPositions(timeframes['1d']);

const posisiBb15m = indicatorPositions15m.bb, posisiEma5015m = indicatorPositions15m.ema;
const posisiBb1h = indicatorPositions1h.bb, posisiEma501h = indicatorPositions1h.ema;
const posisiBb4h = indicatorPositions4h.bb, posisiEma504h = indicatorPositions4h.ema;
const posisiBb1d = indicatorPositions1d.bb, posisiEma501d = indicatorPositions1d.ema;

        showLoader(`Menganalisa proyeksi untuk ${assetSymbol}...`);
        
        const prompt = `Anda adalah seorang Analis Kuantitatif & Ahli Sentimen Pasar untuk aset kripto. Anda sangat mahir dalam mensintesis berbagai data menjadi saran trading yang logis dan bisa dieksekusi. Seluruh respons Anda WAJIB dalam Bahasa Indonesia.

Tugas Anda adalah memberikan analisa holistik untuk aset \`${assetSymbol}\`.

Berikut adalah DATA PASAR TERKINI yang telah divalidasi dan WAJIB Anda gunakan sebagai dasar utama analisa:

**1. Kondisi Umum & Volume:**
* **Harga Saat Ini:** ${currentLivePrice} USD
* **Volume 24 Jam:** ${volume24h} USD (Ini adalah ${volumePercentage}% dari rata-rata volume 7 hari terakhir).

**2. Analisa Sentimen & Kekuatan Tren:**
* **Open Interest:** ${openInterest} USD (Menunjukkan total uang di pasar saat ini).
* **Rasio Long/Short (Umum):** ${lsRatioUmum} (Menunjukkan sentimen trader ritel/umum).
* **Rasio Long/Short (Top Trader):** ${lsRatioTopTrader} (Menunjukkan sentimen 'smart money').
* **Funding Rate:** ${fundingRate} (Menunjukkan biaya untuk menahan posisi dan sentimen jangka pendek).
* **Countdown Funding Berikutnya:** ${countdownFunding} (Potensi volatilitas di sekitar waktu ini).

**3. Data Indikator Teknis Multi-Timeframe:**
* **Timeframe 15 Menit:** RSI=${rsi15m}, Posisi BB='${posisiBb15m}', Posisi vs EMA50='${posisiEma5015m}'.
* **Timeframe 1 Jam:** RSI=${rsi1h}, Posisi BB='${posisiBb1h}', Posisi vs EMA50='${posisiEma501h}'.
* **Timeframe 4 Jam:** RSI=${rsi4h}, Posisi BB='${posisiBb4h}', Posisi vs EMA50='${posisiEma504h}'.
* **Timeframe 1 Hari:** RSI=${rsi1d}, Posisi BB='${posisiBb1d}', Posisi vs EMA50='${posisiEma501d}'.

**INSTRUKSI UTAMA:**
Berdasarkan sintesis holistik dari SEMUA data di atas, berikan jawaban HANYA dalam format JSON yang valid dan terstruktur di bawah ini. Jangan menambahkan teks atau penjelasan lain di luar format JSON.

{
  "saran_bagi_pemilik_aset": "string (Pilih salah satu: TAHAN, JUAL, TAMBAH, KURANGI SEBAGIAN)",
  "alasan_saran_pemilik": "string (Berikan alasan singkat dan logis berdasarkan data)",
  "saran_bagi_non_pemilik": "string (Contoh: BELI di area xxxx-yyyy USD atau TUNGGU KONFIRMASI)",
  "alasan_saran_non_pemilik": "string (Jelaskan mengapa area tersebut ideal atau mengapa harus menunggu)",
  // STRUKTUR BARU
  "analisa_kondisi_saat_ini": {
    "volatilitas": "string (Gambarkan tingkat fluktuasi saat ini: Rendah, Sedang, atau Tinggi)",
    "rentang_harga_terdekat": "string (Perkirakan rentang harga untuk beberapa jam ke depan)",
    "detail_indikator_per_timeframe": [
      {
        "timeframe": "15 Menit",
        "analisa": "string (Jelaskan secara singkat arti dari data indikator HANYA untuk timeframe 15 Menit)"
      },
      {
        "timeframe": "1 Jam",
        "analisa": "string (Jelaskan secara singkat arti dari data indikator HANYA untuk timeframe 1 Jam)"
      },
      {
        "timeframe": "4 Jam",
        "analisa": "string (Jelaskan secara singkat arti dari data indikator HANYA untuk timeframe 4 Jam)"
      },
      {
        "timeframe": "1 Hari",
        "analisa": "string (Jelaskan secara singkat arti dari data indikator HANYA untuk timeframe 1 Hari)"
      }
    ],
    "kesimpulan_indikator": "string (Setelah merinci per timeframe, baru berikan kesimpulan gabungannya di sini)"
  },
  "proyeksi_lengkap": [
    {
      "periode": "Jangka Pendek (1-7 hari)",
      "target_harga": "string",
      "alasan": "string"
    },
    {
      "periode": "Jangka Menengah (1-4 minggu)",
      "target_harga": "string",
      "alasan": "string"
    },
    {
      "periode": "Jangka Panjang (1-6 bulan)",
      "target_harga": "string",
      "alasan": "string"
    }
  ]
}
`;
        const jsonText = await callGemini([{ text: prompt }], true);
        const data = cleanAndParseJson(jsonText);
        
        if (!data.proyeksi_lengkap || data.proyeksi_lengkap.length === 0) {
             proyeksiOutput.innerHTML = `<div class="bg-yellow-900/50 border border-yellow-700 p-4 rounded-lg text-yellow-200"><h4 class="font-bold text-lg mb-2">Analisis Tidak Dilanjutkan</h4><p>AI tidak dapat menghasilkan proyeksi harga yang komprehensif saat ini.</p></div>`;
        } else {
             const getSaranColor = (saran) => {
                if (saran.includes('JUAL') || saran.includes('KURANGI')) return 'text-red-400';
                if (saran.includes('BELI') || saran.includes('TAMBAH')) return 'text-green-400';
                return 'text-yellow-400';
             };

             let resultsHtml = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <h4 class="font-bold text-lg text-white mb-2">Untuk Pemilik Aset</h4>
                        <p class="font-bold text-xl ${getSaranColor(data.saran_bagi_pemilik_aset || '')}">${data.saran_bagi_pemilik_aset || '-'}</p>
                        <p class="text-sm text-gray-400 mt-1">${data.alasan_saran_pemilik || '-'}</p>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <h4 class="font-bold text-lg text-white mb-2">Untuk Non-Pemilik Aset</h4>
                        <p class="font-bold text-xl ${getSaranColor(data.saran_bagi_non_pemilik || '')}">${data.saran_bagi_non_pemilik || '-'}</p>
                        <p class="text-sm text-gray-400 mt-1">${data.alasan_saran_non_pemilik || '-'}</p>
                    </div>
                </div>

                <div class="bg-gray-800 p-4 rounded-lg mb-4">
    <h4 class="font-bold text-lg text-white mb-2">Analisa Kondisi Saat Ini</h4>
    <div class="space-y-2 text-sm">
        <p><strong class="text-gray-400">Volatilitas:</strong> ${data.analisa_kondisi_saat_ini?.volatilitas || '-'}</p>
        <p><strong class="text-gray-400">Rentang Harga Terdekat:</strong> ${data.analisa_kondisi_saat_ini?.rentang_harga_terdekat || '-'}</p>
        
        <div class="mt-3 pt-3 border-t border-gray-700">
            <strong class="text-gray-400 block mb-2">Detail Indikator per Timeframe:</strong>
            ${(data.analisa_kondisi_saat_ini?.detail_indikator_per_timeframe || []).map(tf => `
                <p class="mb-1"><strong class="text-blue-400">${tf.timeframe}:</strong> ${tf.analisa}</p>
            `).join('')}
        </div>

        <div class="mt-3 pt-3 border-t border-gray-700">
             <strong class="text-gray-400 block mb-1">Kesimpulan Indikator:</strong>
             <p>${data.analisa_kondisi_saat_ini?.kesimpulan_indikator || '-'}</p>
        </div>
    </div>
</div

                <h4 class="font-bold text-lg text-white mb-2">Proyeksi Lengkap</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${data.proyeksi_lengkap.map(p => `
                        <div class="bg-gray-800 p-4 rounded-lg flex flex-col justify-between">
                            <div>
                                <h5 class="font-semibold text-blue-400">${p.periode}</h5>
                                <p class="text-lg font-bold text-white">${p.target_harga}</p>
                                <p class="text-sm text-gray-300 mt-1">${p.alasan}</p>
                            </div>
                            <button class="use-projection-btn mt-3" data-price="${(p.target_harga || '0').match(/[\d.]+/)[0]}">Gunakan di Kalkulator</button>
                        </div>
                    `).join('')}
                </div>
             `;
             proyeksiOutput.innerHTML = resultsHtml;
        }

    } catch (error) {
        console.error("Kesalahan Proyeksi Harga:", error);
        proyeksiOutput.innerHTML = `<p class="text-red-400">Gagal menganalisa proyeksi harga: ${error.message}</p>`;
    
    } finally {
        hideLoader();
    }
}

    // [IMPROVEMENT] Fungsi untuk Inisialisasi WebSocket Binance (DITINGKATKAN)
    function initBinanceWebSocket(symbol) {
    if (binanceWebSocket && binanceWebSocket.readyState === WebSocket.OPEN) {
        binanceWebSocket.close();
    }

    const lowerCaseSymbol = symbol.toLowerCase();
    lastFetchedSymbol = lowerCaseSymbol;
    const wsUrl = `wss://stream.binance.com/ws`;
    binanceWebSocket = new WebSocket(wsUrl);
    const statusIndicator = document.getElementById('ws-status-indicator');

    binanceWebSocket.onopen = () => {
        console.log(`WebSocket Binance terhubung.`);
        if (statusIndicator) {
            statusIndicator.className = 'h-3 w-3 rounded-full bg-green-500 animate-pulse';
            statusIndicator.title = 'Terhubung ke data live';
        }
        reconnectAttempts = 0;
        const subscribeMessage = { "method": "SUBSCRIBE", "params": [`${lowerCaseSymbol}@bookTicker`], "id": 1 };
        binanceWebSocket.send(JSON.stringify(subscribeMessage));
    };

    binanceWebSocket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.error) {
            console.error('WebSocket Error:', data.error.msg);
            if (statusIndicator) {
                statusIndicator.className = 'h-3 w-3 rounded-full bg-red-500';
                statusIndicator.title = `Error: ${data.error.msg}`;
            }
            binanceWebSocket.close();
            proyeksiOutput.innerHTML = `<p class="text-red-400">Gagal terhubung ke data live: ${data.error.msg}</p>`;
            hideLoader();
            return;
        }
        if (data.s && data.s.toLowerCase() === lastFetchedSymbol && data.a) { 
            const livePrice = parseFloat(data.a);
            if (!isNaN(livePrice)) {
                if (currentLivePrice === null) { 
                    showLoader('Harga diterima. Mengirim data ke AI...'); 
                }
                currentLivePrice = livePrice;
                if (proyeksiLivePriceOutput) { 
                    proyeksiLivePriceOutput.textContent = `$${livePrice.toFixed(getDecimalPlaces(livePrice))}`; 
                }
            }
        }
    };

    binanceWebSocket.onerror = (error) => {
        console.error(`WebSocket Binance error:`, error);
        if (statusIndicator) {
            statusIndicator.className = 'h-3 w-3 rounded-full bg-red-500';
            statusIndicator.title = 'Koneksi data error';
        }
    };

    binanceWebSocket.onclose = (event) => {
        console.log(`WebSocket ditutup. Kode: ${event.code}`);
        if (event.code !== 1000 && reconnectAttempts < 3) {
            reconnectAttempts++;
            if (statusIndicator) {
                statusIndicator.className = 'h-3 w-3 rounded-full bg-yellow-500 animate-pulse';
                statusIndicator.title = `Koneksi terputus, mencoba menyambung kembali... (${reconnectAttempts}/3)`;
            }
            setTimeout(() => initBinanceWebSocket(lastFetchedSymbol), 5000);
        } else if (reconnectAttempts >= 3) {
            if (statusIndicator) {
                statusIndicator.className = 'h-3 w-3 rounded-full bg-red-500';
                statusIndicator.title = 'Gagal menyambung kembali ke data live';
            }
        }
    };
} // <-- PASTIKAN KURUNG KURAWAL PENUTUP INI ADA

    async function startBacktest() {
        if (!backtestImageBase64) {
            showCustomMessage("Harap unggah gambar Chart Historis terlebih dahulu.", "error");
            return;
        }
        if (!backtestStrategyInput.value.trim()) {
            showCustomMessage("Harap deskripsikan strategi trading Anda.", "error");
            return;
        }

        showLoader('Menganalisa Chart Historis & Mensimulasikan Strategi...');
        runBacktestBtn.disabled = true;
        backtestOutput.innerHTML = '';
        backtestPlaceholder.classList.add('hidden');

        try {
            const strategyDescription = backtestStrategyInput.value.trim();
            const prompt = `Anda adalah AI ahli backtesting strategi trading. Anda akan menganalisis sebuah gambar chart historis dan mensimulasikan kinerja strategi trading yang diberikan.

            **Gambar Chart Historis:** Anda akan diberikan gambar chart. Identifikasi aset, timeframe, pola harga, level support/resistance, dan indikator yang terlihat.
            **Strategi Trading:**
            "${strategyDescription}"

            **Tugas Anda:**
            1.  **Analisis Chart:** Identifikasi kondisi pasar dan setup potensial di gambar chart berdasarkan strategi yang diberikan.
            2.  **Simulasi:** Lakukan simulasi "backtest" visual. Untuk setiap setup yang teridentifikasi, tentukan apakah strategi tersebut akan menghasilkan profit atau loss, berdasarkan pergerakan harga yang terlihat di gambar.
            3.  **Hasil:** Berikan ringkasan hasil backtest dalam format JSON yang terstruktur.

            Balas HANYA dengan satu objek JSON valid dengan skema berikut:
            \`\`\`json
            {
              "asset": {"type": "string"},
              "timeframe": {"type": "string"},
              "totalTradesIdentified": {"type": "number"},
              "winningTrades": {"type": "number"},
              "losingTrades": {"type": "number"},
              "winRatePercentage": {"type": "number"},
              "estimatedProfitLoss": {"type": "string"},
              "keyObservations": ["string"],
              "recommendationsForStrategy": ["string"],
              "disclaimer": "string"
            }
            \`\`\`
            
            Jika Anda tidak dapat mengidentifikasi setup atau mensimulasikan strategi dari gambar, setel \`totalTradesIdentified\` ke 0 dan berikan pesan yang sesuai di \`keyObservations\`.
            Disclaimer standar: "Hasil backtest ini berdasarkan analisis visual gambar chart dan tidak menjamin kinerja di masa depan. Pasar sangat dinamis dan dapat berubah."
            `;

            const parts = [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: backtestImageBase64 } }];
            const jsonText = await callGemini(parts, true);
            const data = cleanAndParseJson(jsonText);

            if (!data || data.totalTradesIdentified === undefined) {
                throw new Error("Struktur respons backtest dari AI tidak valid.");
            }

            let resultsHtml = `
                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                    <h4 class="font-bold text-lg text-white mb-2">Ringkasan Backtest untuk ${data.asset || 'Aset Tidak Dikenal'} (${data.timeframe || 'Timeframe Tidak Dikenal'})</h4>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div><span class="font-semibold text-gray-400">Total Trades:</span> <span class="font-bold">${data.totalTradesIdentified}</span></div>
                        <div><span class="font-semibold text-gray-400">Winning Trades:</span> <span class="font-bold text-green-400">${data.winningTrades || 0}</span></div>
                        <div><span class="font-semibold text-gray-400">Losing Trades:</span> <span class="font-bold text-red-400">${data.losingTrades || 0}</span></div>
                        <div><span class="font-semibold text-gray-400">Win Rate:</span> <span class="font-bold ${data.winRatePercentage >= 50 ? 'text-green-400' : 'text-red-400'}">${data.winRatePercentage !== undefined ? data.winRatePercentage.toFixed(2) + '%' : 'N/A'}</span></div>
                    </div>
                    <div class="mt-3"><span class="font-semibold text-gray-400">Estimasi Profit/Loss:</span> <span class="font-bold text-xl ${data.estimatedProfitLoss && data.estimatedProfitLoss.includes('+') ? 'text-green-400' : (data.estimatedProfitLoss && data.estimatedProfitLoss.includes('-') ? 'text-red-400' : 'text-white')}">${data.estimatedProfitLoss || 'N/A'}</span></div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg mt-4">
                    <h5 class="font-semibold text-gray-400 mb-2">Observasi Kunci</h5>
                    <ul class="list-disc list-inside text-sm mt-2 space-y-1">${data.keyObservations.map(o => `<li>${o}</li>`).join('')}</ul>
                    <h5 class="font-semibold text-gray-400 mt-4 mb-2">Saran Peningkatan Strategi</h5>
                    <ul class="list-disc list-inside text-sm mt-2 space-y-1">${data.recommendationsForStrategy.map(r => `<li>${r}</li>`).join('')}</ul>
                </div>
                <div class="mt-4 bg-yellow-900/50 border border-yellow-700 p-3 rounded-lg text-yellow-200 text-sm italic">
                    <p>${data.disclaimer || "Hasil backtest ini berdasarkan analisis visual gambar chart dan tidak menjamin kinerja di masa depan. Pasar sangat dinamis dan dapat berubah."}</p>
                </div>
            `;
            backtestOutput.innerHTML = resultsHtml;

        } catch (error) {
            console.error("Kesalahan Backtest:", error);
            backtestOutput.innerHTML = `<p class="text-red-400">Maaf, terjadi kesalahan saat menjalankan backtest.<br><span class="text-xs text-gray-400">${error.message}</span></p>`;
        } finally {
            hideLoader();
            checkEnableBacktestButton();
        }
    }

    function showCustomMessage(message, type = 'info') {
        const messageBox = document.createElement('div');
        const color = type === 'error' ? 'bg-red-800' : 'bg-blue-800';
        messageBox.className = `fixed top-5 right-5 ${color} text-white p-4 rounded-lg shadow-lg z-50 transition-opacity duration-300`;
        messageBox.textContent = message;
        document.body.appendChild(messageBox);
        setTimeout(() => {
            messageBox.style.opacity = '0';
            setTimeout(() => messageBox.remove(), 300);
        }, 3000);
    }

    // --- INISIALISASI EVENT LISTENERS ---
    apiKeyInput.addEventListener('input', () => {
        // [IMPROVEMENT] Menggunakan sessionStorage
        sessionStorage.setItem('valhallaUltimateApiKey', apiKeyInput.value);
        checkEnableAnalyzeButton();
        checkEnableBacktestButton();
    });
    setupDropZone(htfDropZone, htfUploadInput, htfChartPreview, htfChartPlaceholder, (val) => htfImageBase64 = val, checkEnableAnalyzeButton);
    setupDropZone(ltfDropZone, ltfUploadInput, ltfChartPreview, ltfChartPlaceholder, (val) => ltfImageBase64 = val, checkEnableAnalyzeButton);
    analyzeBtn.addEventListener('click', startAnalysis);
    exportBtn.addEventListener('click', exportReport);
    analysisWrapper.addEventListener('click', (e) => {
        if (e.target.classList.contains('use-data-btn')) useAnalysisData(e);
    });
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
            button.classList.add('active');
            document.getElementById(button.getAttribute('data-tab')).classList.remove('hidden');

            if (button.getAttribute('data-tab') !== 'proyeksi' && binanceWebSocket) {
                binanceWebSocket.close();
            }
        });
    });
    btnPosisiLong.addEventListener('click', () => {
        btnPosisiLong.classList.add('active', 'long');
        btnPosisiShort.classList.remove('active', 'short');
        populateCalculatorFromAnalysis('long');
    });
    btnPosisiShort.addEventListener('click', () => {
        btnPosisiShort.classList.add('active', 'short');
        btnPosisiLong.classList.remove('active', 'long');
        populateCalculatorFromAnalysis('short');
    });
    hitungRencanaBtn.addEventListener('click', hitungRencana);
    optimizePlanBtn.addEventListener('click', optimizeTradePlan);
    
    generateProyeksiBtn.addEventListener('click', startPriceProjection);
    
    // [IMPROVEMENT] Event listener untuk tombol "Gunakan di Kalkulator" pada proyeksi
    proyeksiOutput.addEventListener('click', (e) => {
        if (e.target.classList.contains('use-projection-btn')) {
            const price = e.target.dataset.price;
            if (price) {
                document.querySelector('.tab-button[data-tab="kalkulator"]').click();
                // Mengisi harga ke TP1, asumsi paling umum
                document.getElementById('calc-tp1').value = parseFloat(price).toFixed(pricePrecision);
                showCustomMessage(`Harga Proyeksi ${price} dimasukkan ke TP1.`, 'info');
            }
        }
    });

    setupDropZone(backtestDropZone, backtestUploadInput, backtestChartPreview, backtestChartPlaceholder, (val) => backtestImageBase64 = val, checkEnableBacktestButton);
    backtestStrategyInput.addEventListener('input', checkEnableBacktestButton);
    runBacktestBtn.addEventListener('click', startBacktest);

    // --- SETUP AWAL ---
    // [IMPROVEMENT] Menggunakan sessionStorage
    const savedApiKey = sessionStorage.getItem('valhallaUltimateApiKey');
    if (savedApiKey) apiKeyInput.value = savedApiKey;
    checkEnableAnalyzeButton();
    checkEnableBacktestButton();
    const activeTab = document.querySelector('.tab-button.active');
    if (!activeTab) {
        document.querySelector('.tab-button[data-tab="analisa"]').click();
    }
});
</script>
</body>
</html>
