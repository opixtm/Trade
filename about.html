<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROJECTOR</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js" charset="utf-8"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
       <style>
        /* CSS Kustom untuk menyempurnakan tampilan */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #111827; /* Latar belakang gelap untuk kenyamanan mata */
            color: #d1d5db; /* Warna teks abu-abu terang */
        }
        .tab-button.active { 
            background-color: #3b82f6; /* Warna biru untuk tab aktif */
            color: white; 
        }
        .chart-upload-container { 
            background-color: #1f2937; 
            border-radius: 0.5rem; 
            padding: 1rem; 
            border: 1px solid #374151; 
            height: 100%; 
            display: flex; 
            flex-direction: column; 
        }
        .chart-preview-container { 
            flex-grow: 1; 
            position: relative; 
            background-color: #111827; 
            border-radius: 0.375rem; 
            border: 2px dashed #4b5563; /* Garis putus-putus untuk area drop */
            min-height: 150px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .chart-preview-container.drag-over {
            border-color: #3b82f6; /* Warna berubah saat gambar di-drag di atasnya */
            background-color: rgba(59, 130, 246, 0.1);
        }
        .chart-preview { 
            object-fit: contain; 
            width: 100%; 
            height: 100%; 
            position: absolute; 
            top: 0; 
            left: 0; 
        }
        .loader { 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #3498db; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; /* Animasi loading berputar */
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        .analysis-table-cell { 
            padding: 0.75rem; 
            border-bottom: 1px solid #374151; 
            vertical-align: top; 
        }
        .kalkulator-input { 
            background-color: #374151; 
            border: 1px solid #4b5563; 
            color: white; 
            border-radius: 0.375rem; 
            padding: 0.5rem 0.75rem; 
            width: 100%; 
        }
        .posisi-btn.active.long { 
            background-color: #22c55e; /* Warna hijau untuk posisi LONG aktif */
            color: white; 
            font-weight: bold; 
        }
        .posisi-btn.active.short { 
            background-color: #ef4444; /* Warna merah untuk posisi SHORT aktif */
            color: white; 
            font-weight: bold; 
        }
        /* Animasi berdenyut untuk menyorot rekomendasi probabilitas tinggi */
        @keyframes pulse-bg { 
            0% { background-color: rgba(59, 130, 246, 0.1); } 
            50% { background-color: rgba(59, 130, 246, 0.35); } 
            100% { background-color: rgba(59, 130, 246, 0.1); } 
        }
        .highlight-pulse { 
            animation: pulse-bg 2s ease-in-out infinite; 
            border-radius: 0.375rem; 
        }
        /* Style untuk tombol 'Gunakan Data' di proyeksi */
        .use-projection-btn {
            background-color: #1e40af;
            color: white;
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
            margin-top: 8px;
        }
        .use-projection-btn:hover {
            background-color: #1d4ed8;
        }

        /* Dasbor Konfluensi Styles */
        .status-uptrend { color: #34d399; }
        .status-downtrend { color: #f43f5e; }
        .status-chop { color: #fbbf24; }
        .blinking-text-animation { animation: blinking-text 1.8s infinite; }
        @keyframes blinking-text { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    </style>
</head>
<body class="antialiased">

    <div class="min-h-screen flex flex-col">
        <header class="bg-gray-800/50 backdrop-blur-sm shadow-lg p-4 top-0 z-20 h-16 relative flex items-center justify-center">
    
    <div class="absolute left-4 top-1/2 -translate-y-1/2">
        <a href="https://opixtm.github.io/Trade/" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors duration-300">
            COPILOT
        </a>
    </div>

    <h1 class="text-2xl font-bold text-white">üö¨<span class="text-blue-400">"AI"</span>PROJECTOR ‚òïÔ∏è</h1>

    <div class="absolute right-4 top-1/2 -translate-y-1/2">
        <a href="https://opixtm.github.io/Trade/services" target="_blank" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded transition-colors duration-300">
            BACKTEST
        </a>
    </div>

</header>
<div class="flex-grow flex flex-col md:flex-row p-4 gap-4">

            <aside class="w-full md:w-1/3 lg:w-1/4 flex flex-col gap-4">
                 <div class="bg-gray-800 rounded-lg p-4 flex flex-col gap-4 shadow-md flex-grow">
                    <div>
                        <h3 class="text-lg font-bold text-white mb-1">Mode Analisa</h3>
                        <p class="text-xs text-gray-400 mb-4">
                            <span class="font-bold">Mode Standar:</span> Cukup isi LTF. <br/>
                            <span class="font-bold">Mode MTF Presisi:</span> Isi HTF & LTF.
                        </p>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-1">1. Chart HTF (Tren Besar) <span class="text-gray-500 text-xs italic">- Opsional</span></label>
                            <div id="htf-drop-zone" class="chart-preview-container">
                                <img id="htf-chart-preview" src="" alt="Pratinjau Chart HTF" class="hidden chart-preview">
                                <div id="htf-chart-placeholder" class="text-center text-gray-500 p-2 pointer-events-none"><p class="text-xs">Klik atau Drop gambar di sini</p></div>
                            </div>
                            <input type="file" id="htf-chart-upload" class="hidden" accept="image/*">
                            <label for="htf-chart-upload" class="mt-2 cursor-pointer w-full text-center bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition block">Pilih Gambar HTF</label>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">2. Chart LTF (Entry) <span class="text-green-400 text-xs italic">- Wajib</span></label>
                            <div id="ltf-drop-zone" class="chart-preview-container">
                                <img id="ltf-chart-preview" src="" alt="Pratinjau Chart LTF" class="hidden chart-preview">
                                <div id="ltf-chart-placeholder" class="text-center text-gray-500 p-2 pointer-events-none"><p class="text-xs">Klik atau Drop gambar di sini</p></div>
                            </div>
                            <input type="file" id="ltf-chart-upload" class="hidden" accept="image/*">
                            <label for="ltf-chart-upload" class="mt-2 cursor-pointer w-full text-center bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition block">Pilih Gambar LTF</label>
                        </div>
                    </div>
                    
                    <button id="analyze-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition disabled:bg-gray-500 disabled:cursor-not-allowed text-lg">ANALISA SEKARANG</button>
                 </div>
            </aside>

            <main class="w-full md:w-2/3 lg:w-3/4 bg-gray-800 rounded-lg p-2 sm:p-4 shadow-md flex flex-col relative">
                <div id="loader" class="hidden absolute inset-0 bg-gray-900/80 flex items-center justify-center flex-col gap-2 z-50 rounded-lg">
                    <div class="loader"></div>
                    <p id="loader-text" class="text-white font-semibold"></p>
                </div>
                <div>
                     <div class="bg-yellow-900/50 border border-yellow-700 p-4 rounded-lg mb-4">
                        <h3 class="font-bold text-yellow-300">Setup Kunci AI (Wajib)</h3>
                        <input type="password" id="api-key-input" class="kalkulator-input mt-2" placeholder="Tempel API Key Google AI Studio di sini...">
                        <p class="text-xs text-gray-400 mt-1">Kunci akan disimpan secara lokal di browser Anda. <a href="https://aistudio.google.com/app/apikey" target="_blank" class="underline hover:text-yellow-300 font-bold">Dapatkan Kunci di sini (Gratis)</a>.</p>
                    </div>
                    <div class="flex flex-wrap border-b border-gray-700">
                        <button class="tab-button flex-grow py-2 px-4 font-semibold text-gray-400 hover:bg-gray-700 transition rounded-t-lg active" data-tab="analisa">ANALISIS</button>
                        <button class="tab-button flex-grow py-2 px-4 font-semibold text-gray-400 hover:bg-gray-700 transition rounded-t-lg" data-tab="kalkulator">KALKULATOR</button>
                        <button class="tab-button flex-grow py-2 px-4 font-semibold text-gray-400 hover:bg-gray-700 transition rounded-t-lg" data-tab="proyeksi">üìà PROYEKSI</button>
                        <button class="tab-button flex-grow py-2 px-4 font-semibold text-gray-400 hover:bg-gray-700 transition rounded-t-lg" data-tab="konfluensi">ü§ù KONFLUENSI</button>
                    </div>
                </div>

                <div id="tab-content" class="flex-grow mt-4 overflow-y-auto">
                    <div id="analisa" class="tab-pane">
                        <div id="analysis-placeholder" class="text-center text-gray-500 p-8"><p>Unggah gambar chart untuk melihat hasil analisa AI di sini.</p></div>
                        <div id="analysis-wrapper" class="hidden">
                            <div id="analysis-content">
                                 <div class="mb-4 bg-gray-900 p-4 rounded-lg border-l-4 border-blue-400">
                                     <h4 class="font-bold text-lg text-white mb-2">Hasil Detektif Data (LTF)</h4>
                                     <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm items-center">
                                         <div>
                                            <span class="font-semibold text-gray-400">Aset:</span> 
                                            <span id="data-asset" class="font-bold"></span>
                                         </div>
                                         <div><span class="font-semibold text-gray-400">Timeframe:</span> <span id="data-timeframe" class="font-bold"></span></div>
                                         <div><span class="font-semibold text-gray-400">Harga Terakhir:</span> <span id="data-price" class="font-bold"></span></div>
                                     </div>
                                     <div class="mt-2">
                                        <span class="font-semibold text-gray-400">Indikator Terdeteksi:</span>
                                        <span id="data-indicators" class="font-bold text-xs text-blue-300"></span>
                                     </div>
                                 </div>
                                 <div class="bg-gray-900 rounded-lg overflow-hidden hidden md:block">
    <div class="grid grid-cols-1 md:grid-cols-3"><div class="analysis-table-cell font-bold text-gray-400 bg-gray-800">Parameter</div><div class="analysis-table-cell font-bold text-green-400 bg-gray-800">Setup LONG</div><div class="analysis-table-cell font-bold text-red-400 bg-gray-800">Setup SHORT</div></div>
    <div class="grid grid-cols-1 md:grid-cols-3"><div class="analysis-table-cell font-semibold">Kondisi Pasar</div><div class="analysis-table-cell" id="long-kondisi">-</div><div class="analysis-table-cell" id="short-kondisi">-</div></div>
    <div class="grid grid-cols-1 md:grid-cols-3"><div class="analysis-table-cell font-semibold">Strategi "Aman"</div><div class="analysis-table-cell" id="long-strategi">-</div><div class="analysis-table-cell" id="short-strategi">-</div></div>
    <div class="grid grid-cols-1 md:grid-cols-3"><div class="analysis-table-cell font-semibold">Probabilitas</div><div class="analysis-table-cell" id="long-probabilitas">-</div><div class="analysis-table-cell" id="short-probabilitas">-</div></div>
    <div class="grid grid-cols-1 md:grid-cols-3"><div class="analysis-table-cell font-semibold">Area Entry</div><div class="analysis-table-cell" id="long-entry">-</div><div class="analysis-table-cell" id="short-entry">-</div></div>
    <div class="grid grid-cols-1 md:grid-cols-3"><div class="analysis-table-cell font-semibold">Pemicu/Konfirmasi</div><div class="analysis-table-cell" id="long-pemicu">-</div><div class="analysis-table-cell" id="short-pemicu">-</div></div>
    <div class="grid grid-cols-1 md:grid-cols-3"><div class="analysis-table-cell font-semibold">Stop Loss</div><div class="analysis-table-cell" id="long-sl">-</div><div class="analysis-table-cell" id="short-sl">-</div></div>
    <div class="grid grid-cols-1 md:grid-cols-3"><div class="analysis-table-cell font-semibold">Alasan Stop Loss</div><div class="analysis-table-cell text-xs italic" id="long-alasan-sl">-</div><div class="analysis-table-cell text-xs italic" id="short-alasan-sl">-</div></div>
    <div class="grid grid-cols-1 md:grid-cols-3"><div class="analysis-table-cell font-semibold">Target Profit</div><div class="analysis-table-cell" id="long-tp">-</div><div class="analysis-table-cell" id="short-tp">-</div></div>
    <div class="grid grid-cols-1 md:grid-cols-3"><div class="analysis-table-cell font-semibold">Alasan Target Profit</div><div class="analysis-table-cell text-xs italic" id="long-alasan-tp">-</div><div class="analysis-table-cell text-xs italic" id="short-alasan-tp">-</div></div>
    <div class="grid grid-cols-1 md:grid-cols-3"><div class="analysis-table-cell font-semibold">Aksi</div><div class="analysis-table-cell"><button class="use-data-btn w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-2 rounded" data-setup="long">Gunakan Data</button></div><div class="analysis-table-cell"><button class="use-data-btn w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-2 rounded" data-setup="short">Gunakan Data</button></div></div>
 </div>

 <div class="space-y-4 md:hidden">
     <div class="bg-gray-900 rounded-lg p-4">
        <h3 class="font-bold text-lg text-green-400 mb-3 pb-2 border-b border-gray-700">Setup LONG</h3>
        <div class="space-y-3 text-sm">
            <div><strong class="text-gray-400 block">Kondisi Pasar:</strong> <span id="mobile-long-kondisi">-</span></div>
            <div><strong class="text-gray-400 block">Strategi "Aman":</strong> <span id="mobile-long-strategi">-</span></div>
            <div><strong class="text-gray-400 block">Probabilitas:</strong> <span id="mobile-long-probabilitas">-</span></div>
            <div><strong class="text-gray-400 block">Area Entry:</strong> <span id="mobile-long-entry">-</span></div>
            <div><strong class="text-gray-400 block">Pemicu/Konfirmasi:</strong> <span id="mobile-long-pemicu">-</span></div>
            <div><strong class="text-gray-400 block">Stop Loss:</strong> <span id="mobile-long-sl">-</span></div>
            <div><strong class="text-gray-400 block">Alasan SL:</strong> <i id="mobile-long-alasan-sl">-</i></div>
            <div><strong class="text-gray-400 block">Target Profit:</strong> <span id="mobile-long-tp">-</span></div>
            <div><strong class="text-gray-400 block">Alasan TP:</strong> <i id="mobile-long-alasan-tp">-</i></div>
            <button class="use-data-btn w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-2 rounded mt-2" data-setup="long">Gunakan Data</button>
        </div>
     </div>
     <div class="bg-gray-900 rounded-lg p-4">
        <h3 class="font-bold text-lg text-red-400 mb-3 pb-2 border-b border-gray-700">Setup SHORT</h3>
        <div class="space-y-3 text-sm">
            <div><strong class="text-gray-400 block">Kondisi Pasar:</strong> <span id="mobile-short-kondisi">-</span></div>
            <div><strong class="text-gray-400 block">Strategi "Aman":</strong> <span id="mobile-short-strategi">-</span></div>
            <div><strong class="text-gray-400 block">Probabilitas:</strong> <span id="mobile-short-probabilitas">-</span></div>
            <div><strong class="text-gray-400 block">Area Entry:</strong> <span id="mobile-short-entry">-</span></div>
            <div><strong class="text-gray-400 block">Pemicu/Konfirmasi:</strong> <span id="mobile-short-pemicu">-</span></div>
            <div><strong class="text-gray-400 block">Stop Loss:</strong> <span id="mobile-short-sl">-</span></div>
            <div><strong class="text-gray-400 block">Alasan SL:</strong> <i id="mobile-short-alasan-sl">-</i></div>
            <div><strong class="text-gray-400 block">Target Profit:</strong> <span id="mobile-short-tp">-</span></div>
            <div><strong class="text-gray-400 block">Alasan TP:</b> <i id="mobile-short-alasan-tp">-</i></div>
            <button class="use-data-btn w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-2 rounded mt-2" data-setup="short">Gunakan Data</button>
        </div>
     </div>
 </div>
                                 <div class="mt-4 bg-blue-900/50 border-l-4 border-blue-400 p-4 rounded-r-lg"><h4 class="font-bold text-lg text-white mb-2">Rekomendasi Utama:</h4><p id="rekomendasi-text" class="text-blue-200">-</p></div>
                                 
                                 <div id="saran-container" class="mt-4 hidden">
                                     <div class="bg-purple-900/50 border-l-4 border-purple-400 p-4 rounded-r-lg">
                                         <h4 class="font-bold text-lg text-purple-300 mb-2">‚ú® Saran Peningkatan Analisa AI</h4>
                                         <p id="saran-text" class="text-purple-200 text-sm">-</p>
                                     </div>
                                 </div>
                            </div>
                             <div id="optimization-container" class="mt-4 hidden">
                                 <button id="optimize-plan-btn" class="w-full bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition">‚ú® Minta Tinjauan & Optimasi Rencana</button>
                                 <div id="optimization-output" class="mt-4 bg-gray-900 p-4 rounded-lg hidden"></div>
                             </div>
                             <button id="export-btn" class="mt-4 w-full bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 transition">Ekspor Laporan (Gambar)</button>
                        </div>
                    </div>
                    <div id="kalkulator" class="tab-pane hidden">
                       <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-gray-900 p-4 rounded-lg space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="font-semibold text-gray-300">Total Modal ($)</label><input type="number" id="calc-modal" class="kalkulator-input mt-1" value="250"></div>
                                    <div><label class="font-semibold text-gray-300">Risiko/Trade (%)</label><input type="number" id="calc-risiko-pct" class="kalkulator-input mt-1" value="1.5" step="0.1"></div>
                                </div>
                                <div>
                                    <label class="font-semibold text-gray-300">Pilih Posisi</label>
                                    <div class="grid grid-cols-2 gap-2 mt-1">
                                        <button id="btn-posisi-long" class="posisi-btn long p-2 rounded-lg bg-gray-700">LONG</button>
                                        <button id="btn-posisi-short" class="posisi-btn short p-2 rounded-lg bg-gray-700">SHORT</button>
                                    </div>
                                </div>
                                <div><label class="font-semibold text-gray-300">Harga Acuan (dari Zona Entry)</label><input type="number" id="calc-entry" step="any" class="kalkulator-input mt-1" placeholder="0.00"></div>
                                <div><label class="font-semibold text-gray-300">Leverage Pilihanmu (x)</label><input type="number" id="calc-leverage" class="kalkulator-input mt-1" value="10"></div>
                                <div>
                                    <label class="font-semibold text-gray-300">Biaya Posisi Manual ($) <span class="text-gray-500 text-xs italic">- Opsional</span></label>
                                    <input type="number" id="calc-margin-manual" class="kalkulator-input mt-1" placeholder="Ganti perhitungan otomatis">
                                </div>
                                <div><label class="font-semibold text-gray-300">Stop Loss</label><input type="number" id="calc-sl" step="any" class="kalkulator-input mt-1" placeholder="0.00"></div>
                                <div><label class="font-semibold text-gray-300">Manajemen Take Profit</label>
                                    <div class="space-y-2 mt-1">
                                        <div class="flex items-center gap-2"><input type="number" id="calc-tp1" step="any" class="kalkulator-input" placeholder="Harga TP 1"><input type="number" id="calc-tp1-pct" class="kalkulator-input w-24" value="50" placeholder="%"></div>
                                        <div class="flex items-center gap-2"><input type="number" id="calc-tp2" step="any" class="kalkulator-input" placeholder="Harga TP 2"><input type="number" id="calc-tp2-pct" class="kalkulator-input w-24" value="30" placeholder="%"></div>
                                        <div class="flex items-center gap-2"><input type="number" id="calc-tp3" step="any" class="kalkulator-input" placeholder="Harga TP 3"><input type="number" id="calc-tp3-pct" class="kalkulator-input w-24" value="20" placeholder="%"></div>
                                    </div>
                                </div>
                                <button id="hitung-rencana-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition">HITUNG RENCANA</button>
                            </div>
                            <div class="bg-gray-900 p-4 rounded-lg">
                                <h3 class="font-bold text-xl mb-4 text-white border-b border-gray-700 pb-2">Rencana Trading</h3>
                                <div id="kalkulator-hasil" class="space-y-3 hidden">
                                    <div class="flex justify-between items-baseline"><span id="out-risiko-label" class="font-semibold text-gray-400">Risiko per Trade (1.5%):</span><span id="out-risiko" class="font-bold text-lg text-red-400">$0.00</span></div>
                                    <div class="flex justify-between items-baseline"><span class="font-semibold text-gray-400">Ukuran Posisi (USD):</span><span id="out-posisi" class="font-bold text-lg text-white">$0.00</span></div>
                                    <div class="bg-blue-900/50 p-3 rounded-lg text-center"><p class="text-sm text-blue-300">Biaya Posisi (Margin)</p><p id="out-margin" class="font-bold text-2xl text-white">$0.00</p></div>
                                    <div class="flex justify-between items-baseline"><span class="font-semibold text-gray-400">Rekomendasi Leverage Aman:</span><span id="out-leverage-aman" class="font-bold text-lg text-yellow-400">~1x</span></div>
                                    <div><h4 class="font-bold text-lg text-white mt-4">Potensi Profit:</h4>
                                        <div class="mt-2 space-y-2">
                                            <div class="flex justify-between"><span id="out-tp1-label">TP 1 (RR 1:0.0):</span><span id="out-tp1-profit" class="font-semibold text-green-400">~$0.00</span></div>
                                            <div class="flex justify-between"><span id="out-tp2-label">TP 2 (RR 1:0.0):</span><span id="out-tp2-profit" class="font-semibold text-green-400">~$0.00</span></div>
                                            <div class="flex justify-between"><span id="out-tp3-label">TP 3 (RR 1:0.0):</span><span id="out-tp3-profit" class="font-semibold text-green-400">~$0.00</span></div>
                                        </div>
                                    </div>
                                </div>
                                 <div id="kalkulator-placeholder" class="text-center text-gray-500 pt-16"><p>Klik "HITUNG RENCANA" untuk melihat hasil perhitungan di sini.</p></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="proyeksi" class="tab-pane hidden">
                        <h3 class="text-xl font-bold text-white mb-4">Analisa Proyeksi Harga Kripto</h3>
                        <div class="bg-gray-900 p-4 rounded-lg">
                            <p class="text-gray-300 mb-4">Dapatkan proyeksi harga untuk aset kripto berdasarkan analisis AI komprehensif. AI akan berusaha mencari data *real-time*.</p>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <input type="text" id="proyeksi-asset-input" list="asset-list" class="kalkulator-input flex-grow" placeholder="Ketik atau pilih aset: BTCUSDT, ETHUSDT...">
                                <datalist id="asset-list">
                                    <option value="BTCUSDT">
                                    <option value="ETHUSDT">
                                    <option value="SOLUSDT">
                                    <option value="BNBUSDT">
                                    <option value="XRPUSDT">
                                    <option value="1000PEPEUSDT">
                                </datalist>
                                <button id="generate-proyeksi-btn" class="w-full sm:w-auto bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition">‚è©Ô∏è</button>
                            </div>
                            <div id="proyeksi-output" class="mt-6">
                                <div id="proyeksi-placeholder" class="text-center text-gray-500 p-8"><p>Masukkan simbol aset dan klik "Analisa Proyeksi" untuk melihat hasil.</p></div>
                            </div>
                            <div class="mt-4 p-3 bg-gray-800 rounded-lg hidden" id="proyeksi-live-price-container">
                                <p class="text-sm text-gray-400">Harga Saat Analisa:</p>
                                <p class="text-xl font-bold text-green-400" id="proyeksi-live-price-output">-</p>
                            </div>
                        </div>
                    </div>

                    <div id="konfluensi" class="tab-pane hidden">
                        <div class="bg-gray-900 p-4 rounded-lg mb-6">
                            <div class="flex flex-wrap justify-between items-center gap-4">
                                <div>
                                    <h2 class="text-2xl font-bold text-white">ü§ù Dasbor Konfluensi</h2>
                                    <p class="text-yellow-500">Analisa berdasarkan VPVR, MA, RSI, Stochastic RSI, MACD & Pola Candlestick.</p>
                                </div>
                                <div class="flex items-center gap-4 flex-wrap">
                                    <div class="flex items-center gap-2">
                                        <label for="konfluensi_asset" class="text-sm font-medium text-gray-400">Aset:</label>
                                        <input type="text" id="konfluensi_asset" list="asset-list" class="kalkulator-input !w-auto" placeholder="Pilih aset...">
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <label for="konfluensi_timeframe" class="text-sm font-medium text-gray-400">Timeframe:</label>
                                        <select id="konfluensi_timeframe" class="kalkulator-input !w-auto">
                                            <option value="1m">1 Menit</option><option value="3m">3 Menit</option><option value="15m">15 Menit</option><option value="1h" selected>1 Jam</option><option value="4h">4 Jam</option><option value="1d">1 Hari</option>
                                        </select>
                                    </div>
                                    <button id="konfluensi_run_btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg">Analisa</button>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                            <section class="lg:col-span-3 bg-gray-900 p-2 md:p-4 rounded-lg min-h-[500px] flex items-center justify-center">
                                <div id="konfluensi_chartLoader" class="text-center"><p class="text-gray-500">Pilih aset dan timeframe, lalu klik "Analisa".</p></div>
                                <div id="konfluensi_chartDiv" class="w-full h-full" style="visibility: hidden;"></div>
                            </section>
                            <aside class="flex flex-col gap-6">
                                <div class="bg-gray-900 p-4 rounded-lg"><h2 class="text-lg font-bold text-blue-400 mb-2">PUTUSAN (KONFLUENSI)</h2><div id="konfluensi_verdictLoader" class="text-gray-400 hidden">Menganalisis...</div><p id="konfluensi_verdictText" class="text-gray-300">Hasil akan muncul di sini.</p></div>
                                <div class="bg-gray-900 p-4 rounded-lg"><h3 class="font-semibold text-white mb-3">Volume Profile (VPVR)</h3><div class="space-y-2 text-sm"><div class="flex justify-between items-center"><span class="text-gray-400">Value Area High (VAH)</span><span id="konfluensi_vahValue" class="font-mono font-medium text-red-400">-</span></div><div class="flex justify-between items-center"><span class="text-gray-400">Point of Control (POC)</span><span id="konfluensi_pocValue" class="font-mono font-bold text-blue-400">-</span></div><div class="flex justify-between items-center"><span class="text-gray-400">Value Area Low (VAL)</span><span id="konfluensi_valValue" class="font-mono font-medium text-green-400">-</span></div></div></div>
                                <div class="bg-gray-900 p-4 rounded-lg"><h3 class="font-semibold text-white mb-3">Validasi Tren (SMA 20/50)</h3><div id="konfluensi_maStatusContainer" class="space-y-2 text-sm"><p class="text-gray-500">Menunggu...</p></div></div>
                                <!-- [MODIFIKASI] Card baru untuk Oscillator -->
                                <div class="bg-gray-900 p-4 rounded-lg">
                                    <h3 class="font-semibold text-white mb-3">Analisa Momentum (Oscillator)</h3>
                                    <div id="konfluensi_oscillator_container" class="space-y-2 text-sm">
                                        <div class="flex justify-between items-center"><span class="text-gray-400">RSI (14)</span><div><span id="konfluensi_rsi_value" class="font-mono font-medium">-</span><span id="konfluensi_rsi_status" class="text-xs font-bold ml-2">-</span></div></div>
                                        <div class="flex justify-between items-center"><span class="text-gray-400">Stoch RSI (%K/%D)</span><div><span id="konfluensi_stoch_value" class="font-mono font-medium">-</span><span id="konfluensi_stoch_status" class="text-xs font-bold ml-2">-</span></div></div>
                                        <div class="flex justify-between items-center"><span class="text-gray-400">MACD Cross</span><span id="konfluensi_macd_cross" class="font-mono font-bold">-</span></div>
                                        <div class="flex justify-between items-center"><span class="text-gray-400">MACD Histogram</span><span id="konfluensi_macd_hist" class="font-mono font-medium">-</span></div>
                                    </div>
                                </div>
                                <div class="bg-gray-900 p-4 rounded-lg"><h3 class="font-semibold text-white mb-3">Pemicu Sinyal Candlestick</h3><div id="konfluensi_patternDisplay" class="text-center p-2 rounded-md bg-gray-800"><p class="text-gray-500 font-medium">BELUM ADA</p></div></div>
                            </aside>
                        </div>
                    </div>


                </div>
            </main>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // Tambahkan DUA fungsi ini di dekat fungsi bantuan lainnya

const calculateEMA = (data, period) => {
    if (!data || data.length < period) return [];
    const k = 2 / (period + 1);
    let emaArray = [data.slice(0, period).reduce((a, b) => a + b, 0) / period];
    for (let i = period; i < data.length; i++) {
        emaArray.push((data[i] * k) + (emaArray[emaArray.length - 1] * (1 - k)));
    }
    return emaArray;
};

const calculateBollingerBands = (closes, period = 20, stdDevMultiplier = 2) => {
    if (!closes || closes.length < period) return { upper: 0, middle: 0, lower: 0 };
    const middleBand = calculateSMA(closes.slice(-period), period)[0];
    if (middleBand === undefined) return { upper: 0, middle: 0, lower: 0 };
    
    const slice = closes.slice(-period);
    const stdDev = Math.sqrt(slice.map(p => Math.pow(p - middleBand, 2)).reduce((a, b) => a + b, 0) / period);
    
    return {
        upper: middleBand + (stdDev * stdDevMultiplier),
        middle: middleBand,
        lower: middleBand - (stdDev * stdDevMultiplier)
    };
};
    
    const calculateSMA = (data, period) => {
    if (!data || data.length < period) return [];
    const sma = [];
    for (let i = period - 1; i < data.length; i++) {
        const slice = data.slice(i - period + 1, i + 1);
        const sum = slice.reduce((a, b) => a + b, 0);
        sma.push(sum / period);
    }
    return sma;
};

const calculateRSI = (closes, period = 14) => {
    if (!closes || closes.length <= period) return 'N/A';
    
    let gains = [];
    let losses = [];
    for (let i = 1; i < closes.length; i++) {
        const diff = closes[i] - closes[i-1];
        if (diff >= 0) {
            gains.push(diff);
            losses.push(0);
        } else {
            gains.push(0);
            losses.push(Math.abs(diff));
        }
    }

    let avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
    let avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;

    for (let i = period; i < gains.length; i++) {
        avgGain = (avgGain * (period - 1) + gains[i]) / period;
        avgLoss = (avgLoss * (period - 1) + losses[i]) / period;
    }

    if (avgLoss === 0) return 100;
    const rs = avgGain / avgLoss;
    return (100 - (100 / (1 + rs))).toFixed(2);
};

    // --- STATE APLIKASI ---
    let htfImageBase64 = null;
    let ltfImageBase64 = null;
    let latestAnalysisData = null;
    let pricePrecision = 4; // Default presisi harga
    let isKonfluensiInitialized = false;
    
    // --- SELEKSI ELEMEN DOM ---
    const apiKeyInput = document.getElementById('api-key-input');
    const htfUploadInput = document.getElementById('htf-chart-upload');
    const htfChartPreview = document.getElementById('htf-chart-preview');
    const htfChartPlaceholder = document.getElementById('htf-chart-placeholder');
    const htfDropZone = document.getElementById('htf-drop-zone');
    const ltfUploadInput = document.getElementById('ltf-chart-upload');
    const ltfChartPreview = document.getElementById('ltf-chart-preview');
    const ltfChartPlaceholder = document.getElementById('ltf-chart-placeholder');
    const ltfDropZone = document.getElementById('ltf-drop-zone');
    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loader-text');
    const analyzeBtn = document.getElementById('analyze-btn');
    
    // Tampilan Analisa
    const analysisWrapper = document.getElementById('analysis-wrapper');
    const analysisPlaceholder = document.getElementById('analysis-placeholder');
    const analysisContent = document.getElementById('analysis-content');
    const exportBtn = document.getElementById('export-btn');
    
    // Tampilan Data Detektif
    const dataAsset = document.getElementById('data-asset');
    const dataTimeframe = document.getElementById('data-timeframe');
    const dataPrice = document.getElementById('data-price');
    const dataIndicators = document.getElementById('data-indicators');
    const rekomendasiText = document.getElementById('rekomendasi-text');
    const saranContainer = document.getElementById('saran-container');
    const saranText = document.getElementById('saran-text');

    // Input Kalkulator
    const calcModal = document.getElementById('calc-modal');
    const calcRisikoPct = document.getElementById('calc-risiko-pct');
    const btnPosisiLong = document.getElementById('btn-posisi-long');
    const btnPosisiShort = document.getElementById('btn-posisi-short');
    const calcEntry = document.getElementById('calc-entry');
    const calcLeverage = document.getElementById('calc-leverage');
    const calcMarginManual = document.getElementById('calc-margin-manual');
    const calcSl = document.getElementById('calc-sl');
    const calcTp1 = document.getElementById('calc-tp1');
    const calcTp2 = document.getElementById('calc-tp2');
    const calcTp3 = document.getElementById('calc-tp3');
    const hitungRencanaBtn = document.getElementById('hitung-rencana-btn');

    // Output Kalkulator
    const kalkulatorHasil = document.getElementById('kalkulator-hasil');
    const kalkulatorPlaceholder = document.getElementById('kalkulator-placeholder');
    const outRisikoLabel = document.getElementById('out-risiko-label');
    const outRisiko = document.getElementById('out-risiko');
    const outPosisi = document.getElementById('out-posisi');
    const outMargin = document.getElementById('out-margin');
    const outLeverageAman = document.getElementById('out-leverage-aman');
    const outTp1Label = document.getElementById('out-tp1-label');
    const outTp1Profit = document.getElementById('out-tp1-profit');
    const outTp2Label = document.getElementById('out-tp2-label');
    const outTp2Profit = document.getElementById('out-tp2-profit');
    const outTp3Label = document.getElementById('out-tp3-label');
    const outTp3Profit = document.getElementById('out-tp3-profit');

    // Elemen Fitur Baru
    const optimizationContainer = document.getElementById('optimization-container');
    const optimizePlanBtn = document.getElementById('optimize-plan-btn');
    const optimizationOutput = document.getElementById('optimization-output');

    // Elemen Proyeksi Harga
    const proyeksiAssetInput = document.getElementById('proyeksi-asset-input');
    const generateProyeksiBtn = document.getElementById('generate-proyeksi-btn');
    const proyeksiOutput = document.getElementById('proyeksi-output');
    const proyeksiPlaceholder = document.getElementById('proyeksi-placeholder');
    const proyeksiLivePriceOutput = document.getElementById('proyeksi-live-price-output'); 

    // --- FUNGSI BANTUAN (HELPER) ---
    const showLoader = (text) => {
        loaderText.textContent = text;
        loader.classList.remove('hidden');
    };
    const hideLoader = () => loader.classList.add('hidden');
    const parsePrice = (priceString) => {
        if (!priceString || typeof priceString !== 'string') return NaN;
        const match = priceString.replace(/,/g, '.').match(/[\d.]+/); 
        return match ? parseFloat(match[0]) : NaN;
    };
    const getDecimalPlaces = (value) => {
        const s_value = String(value);
        if (s_value.indexOf('.') === -1) {
            return 0;
        }
        return s_value.split('.')[1].length || 0;
    };
    const updateCalculatorInputSteps = (precision) => {
        const stepValue = precision > 0 ? '0.' + '0'.repeat(precision - 1) + '1' : '1';
        const priceInputs = [calcEntry, calcSl, calcTp1, calcTp2, calcTp3];
        priceInputs.forEach(input => {
            input.step = stepValue;
        });
    };
    const checkEnableAnalyzeButton = () => {
        analyzeBtn.disabled = !(apiKeyInput.value.trim() && ltfImageBase64);
    };

    // --- LOGIKA UPLOAD & DRAG/DROP ---
    function handleFile(file, imgEl, placeholderEl, stateSetter, enableCheckFunc) {
        if (!file || !file.type.startsWith('image/')) {
            showCustomMessage('Harap unggah file gambar saja (PNG, JPG, dll).', 'error');
            return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
            stateSetter(e.target.result.split(',')[1]); 
            imgEl.src = e.target.result;
            imgEl.classList.remove('hidden');
            placeholderEl.classList.add('hidden');
            enableCheckFunc();
        };
        reader.readAsDataURL(file);
    }

    function setupDropZone(dropZoneEl, inputEl, imgEl, placeholderEl, stateSetter, enableCheckFunc) {
        dropZoneEl.addEventListener('click', () => inputEl.click());
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZoneEl.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });
        dropZoneEl.addEventListener('dragenter', () => dropZoneEl.classList.add('drag-over'));
        dropZoneEl.addEventListener('dragleave', () => dropZoneEl.classList.remove('drag-over'));
        dropZoneEl.addEventListener('drop', (e) => {
            dropZoneEl.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            handleFile(file, imgEl, placeholderEl, stateSetter, enableCheckFunc);
        });
        inputEl.addEventListener('change', (e) => {
            const file = e.target.files[0];
            handleFile(file, imgEl, placeholderEl, stateSetter, enableCheckFunc);
        });
    }

    // --- LOGIKA INTI AI (GEMINI) ---
    function cleanAndParseJson(rawText) {
        console.log("Raw text from AI for parsing:", rawText);
        let jsonString = rawText;
        const markdownMatch = rawText.match(/```json\s*([\s\S]*?)\s*```/);
        if (markdownMatch && markdownMatch[1]) {
            jsonString = markdownMatch[1];
        } else {
            const braceMatch = rawText.match(/\{[\s\S]*\}/);
            if (braceMatch && braceMatch[0]) {
                jsonString = braceMatch[0];
            } else {
                throw new Error("Tidak ada blok JSON yang dapat dikenali dalam respons AI.");
            }
        }
        try {
            return JSON.parse(jsonString);
        } catch (e) {
            console.error("JSON parsing error. Problematic string:", jsonString);
            throw new Error(`Gagal mem-parsing JSON dari AI. Error: ${e.message}`);
        }
    }

    async function callGemini(parts, isJsonOutput = true) {
        const apiKey = apiKeyInput.value.trim();
        if (!apiKey) throw new Error("API Key belum dimasukkan.");
        const model = 'gemini-1.5-flash-latest'; // Menggunakan model flash terbaru
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
        const payload = { contents: [{ role: "user", parts }] };
        if (isJsonOutput) {
            payload.generationConfig = {
                "response_mime_type": "application/json",
            };
        }
        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!response.ok) {
            const errorBody = await response.json();
            const errorMessage = errorBody?.error?.message || `Permintaan API gagal: ${response.status}`;
            if (response.status === 429) throw new Error("Terlalu banyak permintaan (Rate Limit). Coba lagi nanti.");
            if (response.status === 503) throw new Error("Layanan AI sedang sibuk (Error 503). Coba lagi.");
            throw new Error(errorMessage);
        }
        const result = await response.json();
        if (result.candidates && result.candidates[0] && result.candidates[0].content.parts[0]) {
            return result.candidates[0].content.parts[0].text.trim();
        } else {
            if (result.promptFeedback && result.promptFeedback.blockReason) {
                throw new Error(`Permintaan diblokir oleh AI: ${result.promptFeedback.blockReason}`);
            }
            throw new Error("Struktur respons dari AI tidak valid atau kosong.");
        }
    }
    
    async function fetchBinanceAPIData(endpoint, params = {}) {
        const query = new URLSearchParams(params).toString();
        const url = `https://fapi.binance.com/fapi/v1/${endpoint}?${query}`;
        try {
            const response = await fetch(url);
            if (!response.ok) {
                console.error(`Binance API Error ${response.status}: ${await response.text()}`);
                return null;
            }
            return response.json();
        } catch (error) {
            console.error(`Kesalahan Jaringan saat fetch ke Binance: ${error.message}`);
            return null;
        }
    }

    async function extractKeyData(imageBase64) {
        const prompt = `Anda adalah AI OCR yang memiliki akurasi tinggi. Tugas Anda adalah mengekstrak data dari gambar chart trading dengan mengikuti ATURAN PALING KETAT.
        
        1.  **Harga Terakhir (lastPrice)**: Ini adalah tugas paling penting. Lakukan dengan urutan ini, JANGAN DILANGGAR:
            * **Langkah A (Prioritas Utama):** Fokus pada SUMBU HARGA di sisi KANAN chart. Cari KOTAK LABEL HARGA (seringkali berwarna atau memiliki timer countdown) yang menempel di sumbu tersebut. Angka di dalam kotak ini adalah 'lastPrice' yang benar.
            * **Langkah B (Jika Langkah A Gagal):** Jika tidak ada kotak label, cari GARIS HORIZONTAL PUTUS-PUTUS yang berasal dari candle terakhir menuju sumbu harga. Baca angka pada sumbu harga yang DITUNJUK OLEH GARIS ITU.
            * **ZONA TERLARANG:** JANGAN PERNAH mengambil angka dari LEGENDA di pojok KIRI ATAS (yang berisi info O,H,L,C atau nama indikator seperti Bollinger, EMA). Area ini seringkali berisi angka yang salah dan MENIPU. Abaikan sepenuhnya area ini untuk mencari harga.
        2.  **Aset & Timeframe**: Identifikasi dari teks di pojok kiri atas.
        3.  **Indikator (identifiedIndicators)**: Identifikasi SEMUA nama indikator yang terlihat (misal: 'Bollinger Bands', 'EMA', 'RSI', 'MACD', 'Volume').
        4. Identifikasi pola candle potennsial pada 3 candle terakhir pada lower time frame chart

        Jika data tidak ada, gunakan "Tidak Terdeteksi". JANGAN MENEBAK.

        Balas HANYA dengan satu objek JSON valid dengan skema ini: {"type": "object", "properties": {"isChart": {"type": "boolean"}, "asset": {"type": "string"}, "timeframe": {"type": "string"}, "lastPrice": {"type": "string"}, "identifiedIndicators": {"type": "array", "items": {"type": "string"}}}}
        Jika gambar bukan chart trading, balas dengan: {"isChart": false}.`;
        
        const parts = [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: imageBase64 } }];
        const jsonText = await callGemini(parts, true);
        return cleanAndParseJson(jsonText);
    }

    async function startAnalysis() {
        if (!ltfImageBase64) {
            showCustomMessage("Harap unggah gambar Chart LTF terlebih dahulu.", "error");
            return;
        }
        
        showLoader('Mengekstrak Data (1/2)...');
        analyzeBtn.disabled = true;
        analysisPlaceholder.classList.remove('hidden');
        analysisWrapper.classList.add('hidden');
        optimizationContainer.classList.add('hidden');
        saranContainer.classList.add('hidden');

        try {
            const keyData = await extractKeyData(ltfImageBase64);
            if (!keyData || !keyData.isChart) {
                throw new Error("Gambar yang diunggah bukan chart trading yang valid.");
            }
            
            dataAsset.textContent = keyData.asset || 'N/A';
            dataTimeframe.textContent = keyData.timeframe || 'N/A';
            dataPrice.textContent = keyData.lastPrice || 'N/A';
            dataIndicators.textContent = keyData.identifiedIndicators?.join(', ') || 'Tidak ada terdeteksi';

            const lastPriceNumber = parsePrice(keyData.lastPrice);
            if (!isNaN(lastPriceNumber)) {
                pricePrecision = getDecimalPlaces(lastPriceNumber);
                updateCalculatorInputSteps(pricePrecision);
            }

            showLoader('Sabar Bro Sedang Mempertajam Analisa (2/2)...');
            
            let analysisParts = [];
            const assetInfo = keyData.asset || 'aset ini';
            
            const jsonSchema = `{
                "longSetup": { "kondisiPasar": "string", "strategiAman": "string", "probabilitas": "string", "areaEntry": "string", "pemicuKonfirmasi": "string", "stopLoss": "string", "alasanStopLoss": "string", "targetProfit": {"tp1": "string", "tp2": "string", "tp3": "string"}, "alasanTargetProfit": "string" },
                "shortSetup": { "kondisiPasar": "string", "strategiAman": "string", "probabilitas": "string", "areaEntry": "string", "pemicuKonfirmasi": "string", "stopLoss": "string", "alasanStopLoss": "string", "targetProfit": {"tp1": "string", "tp2": "string", "tp3": "string"}, "alasanTargetProfit": "string" },
                "rekomendasiUtama": "string",
                "saranPeningkatan": "string"
            }`;

            let basePrompt = `ANDA WAJIB MEMATUHI STRUKTUR JSON INI TANPA PENGECUALIAN. Seluruh output Anda HARUS berupa satu objek JSON valid tunggal. Jangan menambahkan teks atau field lain di luar skema.
            Anda adalah "Valhalla", analis profesional scalping dengan reputasi tinggi dalam presisi dan manajemen risiko ekstrem. Keahlian Anda berakar kuat pada teori teknikal yang telah terbukti seperti price action, struktur pasar, dan indikator konfirmatif. Pengguna sedang menganalisa ${assetInfo}. Tugas Anda adalah menyusun strategi scalping yang super aman, super jitu, dan berbasis logika teknikal yang tervalidasi.\n`;
            
            if (keyData.identifiedIndicators && keyData.identifiedIndicators.length > 0) {
                basePrompt += `Indikator berikut telah teridentifikasi pada chart: ${keyData.identifiedIndicators.join(', ')}. **WAJIB** gunakan pembacaan dari indikator-indikator ini dalam analisamu, terutama di bagian 'Kondisi Pasar' dan 'Pemicu/Konfirmasi'. Cobalah untuk membaca nilai aktual dari indikator tersebut (misal: level RSI, apakah Stochastic sedang overbought/oversold).\n`;
            }

            basePrompt += `- Untuk setiap parameter ('Kondisi Pasar', 'Strategi Aman', 'Pemicu/Konfirmasi'), berikan penjelasan yang **detail dan mendalam**, bukan hanya satu kalimat tapi tetap fokus.
                Berikan deskripsi teknikal yang menyeluruh: arah tren (naik/turun/sideways), kekuatan tren (misal: divergensi RSI, crossing MA), zona penting (support/resistance), serta sinyal teknikal yang relevan dari indikator yang terlihat.
                Jelaskan alasan teknikal mengapa pasar saat ini dikategorikan dalam kondisi tersebut ataupun jika bisa meningkatkan validitasnya bisa tanbahkan analisa market structure berdasarkan strategi smart money concept (yang terlihat dalam chart).
                Gunakan istilah baku (tebalkan kata): bullish, bearish, ranging, break/retest, dll..
            - Untuk 'areaEntry' dan 'stopLoss', **WAJIB** untuk menyertakan **level harga spesifik** di dalam teksnya. Contoh: "Area entry di sekitar 150.00 - 151.00 karena merupakan zona support." atau "Stop loss di 148.00, tepat di bawah swing low terakhir."
            - Field 'probabilitas' HARUS menyertakan istilah deskriptif dan persentase (misal, "Tinggi (70%)").
            - Berikan 3 level Target Profit (TP1, TP2, TP3) yang realistis untuk scalping, masing-masing dengan harga spesifik dan alasan teknikal singkat.  (misal: "TP1 di 152.00, resistance minor sebelumnya").
            - **PENTING**: Berikan alasan singkat dan jelas untuk nilai 'stopLoss' dan 'targetProfit' yang Anda tentukan. Alasan harus berdasarkan struktur pasar yang terlihat di chart (misal: "di bawah swing low terakhir", "di area resistance terdekat").
            - **SARAN PENINGKATAN**: Setelah analisa selesai, berikan satu saran singkat di field 'saranPeningkatan' tentang bagaimana analisa ini bisa lebih divalidasi. Contoh: "Untuk konfirmasi lebih kuat, perhatikan volume saat breakout" atau "Analisa akan lebih kuat jika dikonfirmasi dengan indikator RSI". Jika analisa sudah sangat kuat, isi dengan "Analisa saat ini sudah cukup komprehensif."
            - Dasarkan analisa Anda HANYA pada informasi visual di chart. Seluruh output Anda harus berupa satu objek JSON valid yang sesuai dengan struktur berikut: ${jsonSchema} \n
            
            Format jawaban Anda dengan jelas menggunakan poin-poin. Jangan gunakan format Markdown. Cukup teks biasa dengan baris baru.`;

            if(htfImageBase64) {
                analysisParts.push(
                    { text: `${basePrompt} Pengguna telah memberikan DUA gambar untuk analisa Multi-Timeframe (MTF).
                    - Gambar PERTAMA adalah chart Higher Timeframe (HTF). Analisa ini untuk menentukan tren dan bias pasar utama (bullish/bearish/ranging).
                    - Gambar KEDUA adalah chart Lower Timeframe (LTF). Gunakan bias dari HTF sebagai filter utama untuk menemukan setup probabilitas tertinggi di LTF. 'rekomendasiUtama' harus menyebutkan tren HTF.`},
                    { inlineData: { mimeType: "image/jpeg", data: htfImageBase64 } },
                    { inlineData: { mimeType: "image/jpeg", data: ltfImageBase64 } }
                );
            } else {
                analysisParts.push(
                    { text: `${basePrompt} Analisa gambar chart yang diberikan untuk membuat rencana trading detail untuk LONG dan SHORT.`},
                    { inlineData: { mimeType: "image/jpeg", data: ltfImageBase64 } }
                );
            }

            const analysisJsonText = await callGemini(analysisParts, true);
            const strategicData = cleanAndParseJson(analysisJsonText);

            latestAnalysisData = { keyData, ...strategicData };
            updateAnalysisUI(latestAnalysisData);

        } catch (error) {
            console.error("Kesalahan Analisa:", error);
            analysisPlaceholder.innerHTML = `<p class="text-red-400 p-4">Maaf, terjadi kesalahan saat menganalisa chart.<br><span class="text-xs text-gray-400">${error.message}</span></p>`;
            analysisPlaceholder.classList.remove('hidden');
            analysisWrapper.classList.add('hidden');
        } finally {
            hideLoader();
            checkEnableAnalyzeButton();
        }
    }
    
    function updateAnalysisUI(data) {
        if (!data || !data.longSetup || !data.shortSetup) {
            analysisPlaceholder.innerHTML = `<p class="text-red-400 p-4">Struktur data strategi dari AI tidak sesuai. Coba analisa ulang.</p>`;
            analysisWrapper.classList.add('hidden');
            analysisPlaceholder.classList.remove('hidden');
            return;
        }
        
        analysisPlaceholder.classList.add('hidden');
        analysisWrapper.classList.remove('hidden');
        optimizationContainer.classList.remove('hidden');
        
        const { longSetup, shortSetup, rekomendasiUtama, saranPeningkatan } = data;
        
        const fieldMap = {
            'kondisi': 'kondisiPasar', 'strategi': 'strategiAman', 'probabilitas': 'probabilitas',
            'entry': 'areaEntry', 'pemicu': 'pemicuKonfirmasi', 'sl': 'stopLoss',
            'alasan-sl': 'alasanStopLoss', 'alasan-tp': 'alasanTargetProfit'
        };

        Object.entries(fieldMap).forEach(([uiField, jsonKey]) => {
            const longValue = longSetup?.[jsonKey]?.replace(/\n/g, '<br />') || '-';
            const shortValue = shortSetup?.[jsonKey]?.replace(/\n/g, '<br />') || '-';

            document.getElementById(`long-${uiField}`).innerHTML = longValue;
            document.getElementById(`short-${uiField}`).innerHTML = shortValue;
            
            const mobileLongEl = document.getElementById(`mobile-long-${uiField}`);
            if(mobileLongEl) mobileLongEl.innerHTML = longValue;
            
            const mobileShortEl = document.getElementById(`mobile-short-${uiField}`);
            if(mobileShortEl) mobileShortEl.innerHTML = shortValue;
        });

        const formatTp = (tpData) => {
            if (tpData && typeof tpData === 'object') {
                return `TP1: ${tpData.tp1 || '-'}<br>TP2: ${tpData.tp2 || '-'}<br>TP3: ${tpData.tp3 || '-'}`;
            }
            return tpData || '-';
        };
        
        const longTpFormatted = formatTp(longSetup.targetProfit);
        const shortTpFormatted = formatTp(shortSetup.targetProfit);

        document.getElementById('long-tp').innerHTML = longTpFormatted;
        document.getElementById('short-tp').innerHTML = shortTpFormatted;
        document.getElementById('mobile-long-tp').innerHTML = longTpFormatted;
        document.getElementById('mobile-short-tp').innerHTML = shortTpFormatted;

        rekomendasiText.innerHTML = rekomendasiUtama?.replace(/\n/g, '<br />') || '-';
        
        if (saranPeningkatan && !saranPeningkatan.toLowerCase().includes("cukup komprehensif")) {
            saranText.textContent = saranPeningkatan;
            saranContainer.classList.remove('hidden');
        } else {
            saranContainer.classList.add('hidden');
        }
        
        ['long', 'short'].forEach(type => {
            const probCellDesktop = document.getElementById(`${type}-probabilitas`);
            const probCellMobile = document.getElementById(`mobile-${type}-probabilitas`);
            const probData = (type === 'long' ? longSetup : shortSetup)?.probabilitas;

            [probCellDesktop, probCellMobile].forEach(cell => {
                 if(cell) {
                    cell.classList.remove('highlight-pulse');
                    if (probData && (probData.toLowerCase().includes('prioritas') || probData.toLowerCase().includes('tinggi'))) {
                        cell.classList.add('highlight-pulse');
                    }
                }
            });
        });
    }

    function exportReport() {
        showLoader('Mempersiapkan Laporan...');
        html2canvas(document.getElementById('analysis-content'), { backgroundColor: '#111827', scale: 2 })
            .then(canvas => {
                const link = document.createElement('a');
                link.download = `Co-Pilot_Report_${dataAsset.textContent || 'report'}_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                hideLoader();
            }).catch(err => {
                console.error('Ekspor gagal:', err);
                hideLoader();
                showCustomMessage('Gagal mengekspor laporan.', 'error');
            });
    }
    
    function populateCalculatorFromAnalysis(setupType) {
        if (!latestAnalysisData) {
            showCustomMessage("Lakukan analisa chart terlebih dahulu.", 'info');
            return;
        }

        const setupData = (setupType === 'long') ? latestAnalysisData.longSetup : latestAnalysisData.shortSetup;

        if (!setupData || !setupData.areaEntry || setupData.areaEntry.toLowerCase().includes("tidak ada")) {
            showCustomMessage(`Data analisa untuk setup ${setupType.toUpperCase()} tidak tersedia.`, 'info');
            return;
        }

        const formatValue = (valueString) => {
            const parsed = parsePrice(valueString);
            return isNaN(parsed) ? '' : parsed.toFixed(pricePrecision);
        };

        calcEntry.value = formatValue(setupData.areaEntry);
        calcSl.value = formatValue(setupData.stopLoss);
        
        if (setupData.targetProfit && typeof setupData.targetProfit === 'object') {
            calcTp1.value = formatValue(setupData.targetProfit.tp1);
            calcTp2.value = formatValue(setupData.targetProfit.tp2);
            calcTp3.value = formatValue(setupData.targetProfit.tp3);
        } else {
            const tpLines = (setupData.targetProfit || '').split(/<br\s*\/?>|\n/);
            calcTp1.value = formatValue(tpLines[0]);
            calcTp2.value = formatValue(tpLines[1]);
            calcTp3.value = formatValue(tpLines[2]);
        }
    }

    function useAnalysisData(e) {
        const setupType = e.target.dataset.setup;
        btnPosisiLong.classList.toggle('active', setupType === 'long');
        btnPosisiLong.classList.toggle('long', setupType === 'long');
        btnPosisiShort.classList.toggle('active', setupType === 'short');
        btnPosisiShort.classList.toggle('short', setupType === 'short');
        populateCalculatorFromAnalysis(setupType);
        document.querySelector('.tab-button[data-tab="kalkulator"]').click();
        calcEntry.focus();
    }
    
    function hitungRencana() {
        const [totalModal, risikoPct, entryPrice, slPrice, leverage, manualMargin] = 
            [calcModal, calcRisikoPct, calcEntry, calcSl, calcLeverage, calcMarginManual].map(el => parseFloat(el.value));

        if ([totalModal, entryPrice, slPrice, leverage].some(isNaN)) {
             showCustomMessage("Pastikan Modal, Harga Entry, Stop Loss, dan Leverage terisi.", "error");
             return;
        }
        if (isNaN(risikoPct) && isNaN(manualMargin)) {
            showCustomMessage("Harap isi 'Risiko/Trade (%)' atau 'Biaya Posisi Manual ($)'.", "error");
            return;
        }

        kalkulatorPlaceholder.classList.add('hidden');
        kalkulatorHasil.classList.remove('hidden');
        
        let risikoUSD, ukuranPosisiUSD, marginUSD;
        const jarakSL = Math.abs(entryPrice - slPrice);
        if (jarakSL === 0) {
            showCustomMessage("Jarak Stop Loss tidak boleh nol.", "error");
            return;
        }

        if (manualMargin > 0) {
            marginUSD = manualMargin;
            ukuranPosisiUSD = marginUSD * leverage;
            risikoUSD = ukuranPosisiUSD * (jarakSL / entryPrice);
            const effectiveRisikoPct = (risikoUSD / totalModal) * 100;
            outRisikoLabel.textContent = `Risiko per Trade (${effectiveRisikoPct.toFixed(2)}%):`;
            calcRisikoPct.value = effectiveRisikoPct.toFixed(2);
        } else {
            risikoUSD = totalModal * (risikoPct / 100);
            ukuranPosisiUSD = risikoUSD / (jarakSL / entryPrice);
            marginUSD = ukuranPosisiUSD / leverage;
            outRisikoLabel.textContent = `Risiko per Trade (${risikoPct}%):`;
            calcMarginManual.value = '';
        }

        outRisiko.textContent = `$${risikoUSD.toFixed(2)}`;
        outPosisi.textContent = `$${ukuranPosisiUSD.toFixed(2)}`;
        outMargin.textContent = `$${marginUSD.toFixed(2)}`;
        outLeverageAman.textContent = `~${(ukuranPosisiUSD / totalModal).toFixed(1)}x`;

        [{el: calcTp1, label: outTp1Label, profit: outTp1Profit}, {el: calcTp2, label: outTp2Label, profit: outTp2Profit}, {el: calcTp3, label: outTp3Label, profit: outTp3Profit}].forEach((tp, i) => {
            const tpPrice = parseFloat(tp.el.value);
            if (!isNaN(tpPrice) && jarakSL > 0) {
                const rr = Math.abs(tpPrice - entryPrice) / jarakSL;
                tp.label.textContent = `TP ${i+1} (RR 1:${rr.toFixed(1)}):`;
                tp.profit.textContent = `~$${(rr * risikoUSD).toFixed(2)}`;
            } else {
                 tp.label.textContent = `TP ${i+1}:`;
                 tp.profit.textContent = `~$0.00`;
            }
        });
    }

    async function optimizeTradePlan() {
        if (!latestAnalysisData) { showCustomMessage("Lakukan analisa chart terlebih dahulu.", "error"); return; }
        showLoader("Meminta tinjauan dari manajer risiko AI...");
        optimizationOutput.classList.add('hidden');
        try {
            const planString = JSON.stringify(latestAnalysisData, null, 2);
            const prompt = `Anda adalah seorang manajer risiko trading yang sangat berpengalaman. Diberikan sebuah rencana trading dalam format JSON berikut untuk aset ${latestAnalysisData.keyData.asset}.
            Rencana Trading:
            ${planString}

            Tugas Anda adalah meninjau rencana ini secara kritis namun "padat". Berikan umpan balik yang membangun dalam Bahasa Indonesia. Fokus pada:
            1.  **Validasi Setup**: Apakah ada kelemahan dalam logika setup yang diusulkan?
            2.  **Manajemen Risiko**: Apakah Stop Loss sudah optimal? Apakah ada cara untuk memperketatnya?
            3.  **Skenario Alternatif**: Apa skenario lain yang mungkin terjadi yang tidak dipertimbangkan?
            4.  **Peringatan**: Apa risiko eksternal terbesar (misal, berita terbaru yang up to date) yang harus diwaspadai?
            
            Format jawaban Anda dengan jelas menggunakan poin-poin. Jangan gunakan format Markdown. Cukup teks biasa dengan baris baru.`;

            const optimizationText = await callGemini([{ text: prompt }], false);
            optimizationOutput.innerHTML = `<h4 class="font-bold text-lg text-purple-300 mb-2">Tinjauan Manajer Risiko AI</h4><p class="text-sm text-gray-300 whitespace-pre-wrap">${optimizationText}</p>`;
            optimizationOutput.classList.remove('hidden');

        } catch (error) {
            optimizationOutput.innerHTML = `<p class="text-red-400">Gagal mendapatkan tinjauan: ${error.message}</p>`;
            optimizationOutput.classList.remove('hidden');
        } finally {
            hideLoader();
        }
    }

async function startPriceProjection() {
    const assetSymbol = proyeksiAssetInput.value.trim().toUpperCase();
    if (!assetSymbol) {
        showCustomMessage("Harap masukkan simbol aset kripto (contoh: BTCUSDT).", "error");
        return;
    }

    showLoader(`Mengambil data pasar untuk ${assetSymbol}...`);
    proyeksiOutput.innerHTML = '';
    proyeksiPlaceholder.classList.add('hidden');
    document.getElementById('proyeksi-live-price-container').classList.add('hidden');

    try {
        const priceTickerData = await fetchBinanceAPIData('ticker/price', { symbol: assetSymbol });
        if (!priceTickerData || !priceTickerData.price) {
            throw new Error(`Gagal mengambil harga terkini untuk ${assetSymbol}. Pastikan simbol valid.`);
        }
        const hargaSaatAnalisa = parseFloat(priceTickerData.price);
        
        proyeksiLivePriceOutput.textContent = `$${hargaSaatAnalisa.toFixed(getDecimalPlaces(hargaSaatAnalisa))}`;
        document.getElementById('proyeksi-live-price-container').classList.remove('hidden');

        showLoader(`Mengumpulkan data pasar lengkap untuk ${assetSymbol}...`);

        const [
            tickerData, fundingData, openInterestData, lsRatioUmumData,
            lsRatioTopTraderData, klines30d, klines15m, klines1h, klines4h, klines1d
        ] = await Promise.all([
            fetchBinanceAPIData('ticker/24hr', { symbol: assetSymbol }),
            fetchBinanceAPIData('premiumIndex', { symbol: assetSymbol }),
            fetchBinanceAPIData('openInterest', { symbol: assetSymbol }),
            fetch(`https://fapi.binance.com/futures/data/globalLongShortAccountRatio?symbol=${assetSymbol}&period=5m&limit=1`).then(res => res.json()),
            fetch(`https://fapi.binance.com/futures/data/topLongShortAccountRatio?symbol=${assetSymbol}&period=5m&limit=1`).then(res => res.json()),
            fetchBinanceAPIData('klines', { symbol: assetSymbol, interval: '1d', limit: 30 }),
            fetchBinanceAPIData('klines', { symbol: assetSymbol, interval: '15m', limit: 100 }),
            fetchBinanceAPIData('klines', { symbol: assetSymbol, interval: '1h', limit: 100 }),
            fetchBinanceAPIData('klines', { symbol: assetSymbol, interval: '4h', limit: 100 }),
            fetchBinanceAPIData('klines', { symbol: assetSymbol, interval: '1d', limit: 100 })
        ]);

        const volume24h = tickerData ? parseFloat(tickerData.quoteVolume).toLocaleString('id-ID') : 'N/A';
        let volumePercentage = 'N/A';
        if (klines30d && tickerData) {
            const last7dVolumes = klines30d.slice(-7).map(k => parseFloat(k[7]));
            const avgVolume7d = last7dVolumes.reduce((a, b) => a + b, 0) / 7;
            const currentVolume = parseFloat(tickerData.quoteVolume);
            if (avgVolume7d > 0) volumePercentage = ((currentVolume / avgVolume7d - 1) * 100).toFixed(2);
        }
        
        const openInterest = openInterestData ? parseFloat(openInterestData.openInterest).toLocaleString('id-ID') : 'N/A';
        const lsRatioUmum = lsRatioUmumData?.[0]?.longShortRatio ? parseFloat(lsRatioUmumData[0].longShortRatio).toFixed(2) : 'N/A';
        const lsRatioTopTrader = lsRatioTopTraderData?.[0]?.longShortRatio ? parseFloat(lsRatioTopTraderData[0].longShortRatio).toFixed(2) : 'N/A';
        const fundingRate = fundingData ? (parseFloat(fundingData.lastFundingRate) * 100).toFixed(4) + '%' : 'N/A';
        
        let countdownFunding = 'N/A';
        if (fundingData && fundingData.nextFundingTime) {
            const timeLeftMs = parseInt(fundingData.nextFundingTime) - Date.now();
            if (timeLeftMs > 0) {
                const hours = Math.floor(timeLeftMs / 3600000);
                const minutes = Math.floor((timeLeftMs % 3600000) / 60000);
                countdownFunding = `${hours} jam ${minutes} menit`;
            }
        }

        const rsi15m = calculateRSI(klines15m.map(k => parseFloat(k[4])));
        const rsi1h = calculateRSI(klines1h.map(k => parseFloat(k[4])));
        const rsi4h = calculateRSI(klines4h.map(k => parseFloat(k[4])));
        const rsi1d = calculateRSI(klines1d.map(k => parseFloat(k[4])));
        
        const timeframes = {
            '15m': klines15m.map(k => parseFloat(k[4])),
            '1h': klines1h.map(k => parseFloat(k[4])),
            '4h': klines4h.map(k => parseFloat(k[4])),
            '1d': klines1d.map(k => parseFloat(k[4])),
        };

        const getIndicatorPositions = (closes) => {
            if (closes.length < 50) return { bb: 'Data Kurang', ema: 'Data Kurang' };
            const lastClose = closes[closes.length - 1];
            const ema50 = calculateEMA(closes, 50).pop();
            const posisiEma = lastClose > ema50 ? 'Di atas EMA50' : 'Di bawah EMA50';
            const bb = calculateBollingerBands(closes, 20, 2);
            let posisiBb = 'Di dalam Band';
            if (lastClose > bb.upper) posisiBb = 'Di atas Upper Band';
            if (lastClose < bb.lower) posisiBb = 'Di bawah Lower Band';
            return { bb: posisiBb, ema: posisiEma };
        };

        const indicatorPositions15m = getIndicatorPositions(timeframes['15m']);
        const indicatorPositions1h = getIndicatorPositions(timeframes['1h']);
        const indicatorPositions4h = getIndicatorPositions(timeframes['4h']);
        const indicatorPositions1d = getIndicatorPositions(timeframes['1d']);

        const posisiBb15m = indicatorPositions15m.bb, posisiEma5015m = indicatorPositions15m.ema;
        const posisiBb1h = indicatorPositions1h.bb, posisiEma501h = indicatorPositions1h.ema;
        const posisiBb4h = indicatorPositions4h.bb, posisiEma504h = indicatorPositions4h.ema;
        const posisiBb1d = indicatorPositions1d.bb, posisiEma501d = indicatorPositions1d.ema;

        showLoader(`Menganalisa proyeksi untuk ${assetSymbol}...`);
        
        const prompt = `Anda adalah seorang Analis Kuantitatif & Ahli Sentimen Pasar untuk aset kripto. Anda sangat mahir dalam mensintesis berbagai data menjadi saran trading yang logis, aman, dan jitu. Seluruh respons Anda WAJIB dalam Bahasa Indonesia.

Tugas Anda adalah memberikan analisa holistik untuk aset \`${assetSymbol}\`.

Berikut adalah DATA PASAR TERKINI yang telah divalidasi dan WAJIB Anda gunakan sebagai dasar utama analisa:

**1. Data Harga & Volume:**
* **Harga Saat Ini:** ${hargaSaatAnalisa} USD
* **Volume 24 Jam:** ${volume24h} USD (Ini adalah ${volumePercentage}% dari rata-rata volume 7 hari terakhir).

**2. Data Sentimen Pasar:**
* **Open Interest:** ${openInterest} USD (Total uang di pasar).
* **Rasio Long/Short (Umum):** ${lsRatioUmum} (Sentimen trader ritel).
* **Rasio Long/Short (Top Trader):** ${lsRatioTopTrader} (Sentimen 'smart money').
* **Funding Rate:** ${fundingRate} (Biaya posisi & sentimen jangka pendek).
* **Countdown Funding Berikutnya:** ${countdownFunding}.

**3. Data Indikator Teknis Multi-Timeframe:**
* **15 Menit:** RSI=${rsi15m}, Posisi BB='${posisiBb15m}', Posisi vs EMA50='${posisiEma5015m}'.
* **1 Jam:** RSI=${rsi1h}, Posisi BB='${posisiBb1h}', Posisi vs EMA50='${posisiEma501h}'.
* **4 Jam:** RSI=${rsi4h}, Posisi BB='${posisiBb4h}', Posisi vs EMA50='${posisiEma504h}'.
* **1 Hari:** RSI=${rsi1d}, Posisi BB='${posisiBb1d}', Posisi vs EMA50='${posisiEma501d}'.

**INSTRUKSI UTAMA:**
Berdasarkan sintesis holistik dari SEMUA data di atas, berikan jawaban HANYA dalam format JSON yang valid dan terstruktur di bawah ini. Jangan menambahkan teks atau penjelasan lain di luar format JSON.

{
  "saran_bagi_pemilik_aset": "string (Pilih salah satu: TAHAN, JUAL, TAMBAH, KURANGI SEBAGIAN)",
  "alasan_saran_pemilik": "string (Alasan singkat dan logis berdasarkan data)",
  "saran_bagi_non_pemilik": "string (Contoh: BELI di area xxxx-yyyy USD atau TUNGGU KONFIRMASI)",
  "alasan_saran_non_pemilik": "string (Jelaskan mengapa area tersebut ideal atau mengapa harus menunggu)",
  "analisa_kondisi_saat_ini": {
    "volatilitas": "string (Rendah, Sedang, atau Tinggi)",
    "sentimen_keseluruhan": "string (Jelaskan kesimpulan dari data Volume, Long/Short Ratio, dan Funding Rate)",
    "detail_indikator_per_timeframe": [
      {
        "timeframe": "15 Menit",
        "analisa": "string (Jelaskan secara singkat arti dari data indikator HANYA untuk timeframe 15 Menit)"
      },
      {
        "timeframe": "1 Jam",
        "analisa": "string (Jelaskan secara singkat arti dari data indikator HANYA untuk timeframe 1 Jam)"
      },
      {
        "timeframe": "4 Jam",
        "analisa": "string (Jelaskan secara singkat arti dari data indikator HANYA untuk timeframe 4 Jam)"
      },
      {
        "timeframe": "1 Hari",
        "analisa": "string (Jelaskan secara singkat arti dari data indikator HANYA untuk timeframe 1 Hari)"
      }
    ],
    "kesimpulan_indikator": "string (Setelah merinci per timeframe, baru berikan kesimpulan gabungannya di sini)"
  },
  "analisa_smc": {
    "order_block_bullish": "string (WAJIB ANALISA. Berdasarkan data k-line yang ada, berikan estimasi terbaikmu untuk rentang harga OB Bullish terdekat. Jika sulit, jelaskan mengapa, contoh: 'Tidak ada OB jelas karena pasar ranging, namun area support terdekat di $XXXX bisa menjadi acuan')",
    "order_block_bearish": "string (WAJIB ANALISA. Berdasarkan data k-line yang ada, berikan estimasi terbaikmu untuk rentang harga OB Bearish terdekat. Jika sulit, jelaskan mengapa)",
    "fair_value_gap": "string (WAJIB ANALISA. Berdasarkan data k-line yang ada, berikan estimasi terbaikmu untuk rentang harga FVG terdekat yang berpotensi diisi. Jika sulit, jelaskan mengapa)",
    "liquidity_pools": "string (WAJIB ANALISA. Berdasarkan data k-line yang ada, berikan estimasi terbaikmu untuk level harga liquidity pool terdekat, misal 'Equal Highs di $XXXX'. Jika sulit, jelaskan mengapa)",
    "kesimpulan_smc": "string (Simpulkan narasi pasar berdasarkan temuan SMC di atas. Ke mana harga kemungkinan besar akan bergerak untuk mengambil likuiditas atau memitigasi zona?)"
  },
  "proyeksi_lengkap": [
    {
      "periode": "Jangka Pendek (1-7 hari)",
      "target_harga": "string",
      "alasan": "string"
    },
    {
      "periode": "Jangka Menengah (1-4 minggu)",
      "target_harga": "string",
      "alasan": "string"
    },
    {
      "periode": "Jangka Panjang (1-6 bulan)",
      "target_harga": "string",
      "alasan": "string"
    }
  ]
}
`;
        const jsonText = await callGemini([{ text: prompt }], true);
        const data = cleanAndParseJson(jsonText);
        
        if (!data.proyeksi_lengkap || data.proyeksi_lengkap.length === 0) {
             proyeksiOutput.innerHTML = `<div class="bg-yellow-900/50 border border-yellow-700 p-4 rounded-lg text-yellow-200"><h4 class="font-bold text-lg mb-2">Analisis Tidak Dilanjutkan</h4><p>AI tidak dapat menghasilkan proyeksi harga yang komprehensif saat ini.</p></div>`;
        } else {
             const getSaranColor = (saran) => {
                if (saran.includes('JUAL') || saran.includes('KURANGI')) return 'text-red-400';
                if (saran.includes('BELI') || saran.includes('TAMBAH')) return 'text-green-400';
                return 'text-yellow-400';
             };

             let resultsHtml = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <h4 class="font-bold text-lg text-white mb-2">Untuk Pemilik Aset</h4>
                        <p class="font-bold text-xl ${getSaranColor(data.saran_bagi_pemilik_aset || '')}">${data.saran_bagi_pemilik_aset || '-'}</p>
                        <p class="text-sm text-gray-400 mt-1">${data.alasan_saran_pemilik || '-'}</p>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <h4 class="font-bold text-lg text-white mb-2">Untuk Non-Pemilik Aset (Cek ke ü§ù KONFLUENSI)</h4>
                        <p class="font-bold text-xl ${getSaranColor(data.saran_bagi_non_pemilik || '')}">${data.saran_bagi_non_pemilik || '-'}</p>
                        <p class="text-sm text-gray-400 mt-1">${data.alasan_saran_non_pemilik || '-'}</p>
                    </div>
                </div>

                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                    <h4 class="font-bold text-lg text-white mb-3">Analisa Kondisi Pasar</h4>
                    <div class="space-y-3 text-sm">
                        <p><strong class="text-gray-400 w-32 inline-block">Volatilitas:</strong> ${data.analisa_kondisi_saat_ini?.volatilitas || '-'}</p>
                        <p><strong class="text-gray-400 w-32 inline-block">Sentimen Pasar:</strong> ${data.analisa_kondisi_saat_ini?.sentimen_keseluruhan || '-'}</p>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-700 text-sm">
                        <strong class="text-gray-400 block mb-2">Detail Indikator per Timeframe:</strong>
                        ${(data.analisa_kondisi_saat_ini?.detail_indikator_per_timeframe || []).map(tf => `
                            <p class="mb-1"><strong class="text-blue-400">${tf.timeframe}:</strong> ${tf.analisa}</p>
                        `).join('')}
                    </div>
                     <div class="mt-3 pt-3 border-t border-gray-700 text-sm">
                        <p><strong class="text-gray-400">Kesimpulan Indikator:</strong> ${data.analisa_kondisi_saat_ini?.kesimpulan_indikator || '-'}</p>
                    </div>
                </div>

                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                    <h4 class="font-bold text-lg text-white mb-3">Analisa Struktur Pasar (SMC)</h4>
                    <div class="space-y-3 text-sm">
                        <p><strong class="text-green-400 w-36 inline-block">Bullish Order Block:</strong> ${data.analisa_smc?.order_block_bullish || '-'}</p>
                        <p><strong class="text-red-400 w-36 inline-block">Bearish Order Block:</strong> ${data.analisa_smc?.order_block_bearish || '-'}</p>
                        <p><strong class="text-yellow-400 w-36 inline-block">Fair Value Gap (FVG):</strong> ${data.analisa_smc?.fair_value_gap || '-'}</p>
                        <p><strong class="text-blue-400 w-36 inline-block">Liquidity Pools:</strong> ${data.analisa_smc?.liquidity_pools || '-'}</p>
                        <div class="pt-3 mt-3 border-t border-gray-700">
                           <p><strong class="text-gray-400">Kesimpulan SMC:</strong> ${data.analisa_smc?.kesimpulan_smc || '-'}</p>
                        </div>
                    </div>
                </div>

                <h4 class="font-bold text-lg text-white mb-2">Proyeksi Lengkap</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${data.proyeksi_lengkap.map(p => `
                        <div class="bg-gray-800 p-4 rounded-lg flex flex-col justify-between">
                            <div>
                                <h5 class="font-semibold text-blue-400">${p.periode}</h5>
                                <p class="text-lg font-bold text-white">${p.target_harga}</p>
                                <p class="text-sm text-gray-300 mt-1">${p.alasan}</p>
                            </div>
                            <button class="use-projection-btn mt-3" data-price="${(p.target_harga || '0').match(/[\d.]+/)[0]}">Gunakan di Kalkulator</button>
                        </div>
                    `).join('')}
                </div>
             `;
             proyeksiOutput.innerHTML = resultsHtml;
        }

    } catch (error) {
        console.error("Kesalahan Proyeksi Harga:", error);
        proyeksiOutput.innerHTML = `<p class="text-red-400">Gagal menganalisa proyeksi harga: ${error.message}</p>`;
    } finally {
        hideLoader();
    }
}



    function showCustomMessage(message, type = 'info') {
        const messageBox = document.createElement('div');
        const color = type === 'error' ? 'bg-red-800' : 'bg-blue-800';
        messageBox.className = `fixed top-5 right-5 ${color} text-white p-4 rounded-lg shadow-lg z-50 transition-opacity duration-300`;
        messageBox.textContent = message;
        document.body.appendChild(messageBox);
        setTimeout(() => {
            messageBox.style.opacity = '0';
            setTimeout(() => messageBox.remove(), 300);
        }, 3000);
    }

    // --- KONFLUENSI DASHBOARD LOGIC ---
    function initializeKonfluensiDashboard() {
        const konfluensi_ui = { 
            assetInput: document.getElementById('konfluensi_asset'), 
            timeframeSelect: document.getElementById('konfluensi_timeframe'), 
            runBtn: document.getElementById('konfluensi_run_btn'),
            chartDiv: document.getElementById('konfluensi_chartDiv'), 
            chartLoader: document.getElementById('konfluensi_chartLoader'), 
            verdictText: document.getElementById('konfluensi_verdictText'), 
            verdictLoader: document.getElementById('konfluensi_verdictLoader'), 
            vahValue: document.getElementById('konfluensi_vahValue'), 
            pocValue: document.getElementById('konfluensi_pocValue'), 
            valValue: document.getElementById('konfluensi_valValue'), 
            maStatusContainer: document.getElementById('konfluensi_maStatusContainer'), 
            patternDisplay: document.getElementById('konfluensi_patternDisplay'),
            // [MODIFIKASI] Tambah UI untuk oscillator
            rsiValue: document.getElementById('konfluensi_rsi_value'),
            rsiStatus: document.getElementById('konfluensi_rsi_status'),
            stochValue: document.getElementById('konfluensi_stoch_value'),
            stochStatus: document.getElementById('konfluensi_stoch_status'),
            macdCross: document.getElementById('konfluensi_macd_cross'),
            macdHist: document.getElementById('konfluensi_macd_hist'),
        };
        // [MODIFIKASI] Tambah state untuk oscillator
        let konfluensi_state = { klines: [], vpvr: {}, trendStatus: {}, pattern: {}, lastClose: 0, rsi: {}, stoch: {}, macd: {} };

        // --- [BARU] Fungsi Kalkulasi Oscillator ---
        const calculateStochasticRSI = (closes, rsiPeriod = 14, stochPeriod = 14, kPeriod = 3, dPeriod = 3) => {
            if (closes.length < rsiPeriod + stochPeriod) return { k: 0, d: 0 };
            let rsiValues = [];
            let gains = [], losses = [];
            for (let i = 1; i < closes.length; i++) {
                const diff = closes[i] - closes[i-1];
                if (diff >= 0) { gains.push(diff); losses.push(0); } else { gains.push(0); losses.push(Math.abs(diff)); }
            }
            let avgGain = gains.slice(0, rsiPeriod).reduce((a, b) => a + b, 0) / rsiPeriod;
            let avgLoss = losses.slice(0, rsiPeriod).reduce((a, b) => a + b, 0) / rsiPeriod;
            rsiValues.push(100 - (100 / (1 + (avgGain / avgLoss))));
            for (let i = rsiPeriod; i < gains.length; i++) {
                avgGain = (avgGain * (rsiPeriod - 1) + gains[i]) / rsiPeriod;
                avgLoss = (avgLoss * (rsiPeriod - 1) + losses[i]) / rsiPeriod;
                if (avgLoss === 0) rsiValues.push(100);
                else rsiValues.push(100 - (100 / (1 + (avgGain / avgLoss))));
            }
            if (rsiValues.length < stochPeriod) return { k: 0, d: 0 };
            let kValues = [];
            for (let i = stochPeriod - 1; i < rsiValues.length; i++) {
                const slice = rsiValues.slice(i - stochPeriod + 1, i + 1);
                const lowestRSI = Math.min(...slice);
                const highestRSI = Math.max(...slice);
                const currentRSI = rsiValues[i];
                const k = highestRSI === lowestRSI ? 100 : ((currentRSI - lowestRSI) / (highestRSI - lowestRSI)) * 100;
                kValues.push(k);
            }
            if (kValues.length < dPeriod) return { k: kValues.pop() || 0, d: 0 };
            const lastK = kValues.pop() || 0;
            const dSlice = kValues.slice(-dPeriod + 1);
            dSlice.push(lastK);
            const lastD = dSlice.reduce((a, b) => a + b, 0) / dPeriod;
            return { k: lastK, d: lastD };
        };
        const calculateMACD = (closes, fastPeriod = 12, slowPeriod = 26, signalPeriod = 9) => {
            if (closes.length < slowPeriod + signalPeriod) return { macdLine: 0, signalLine: 0, histogram: 0 };
            const emaFast = calculateEMA(closes, fastPeriod);
            const emaSlow = calculateEMA(closes, slowPeriod);
            const macdLineValues = emaFast.slice(slowPeriod - fastPeriod).map((val, i) => val - emaSlow[i]);
            if (macdLineValues.length < signalPeriod) return { macdLine: 0, signalLine: 0, histogram: 0 };
            const signalLineValues = calculateEMA(macdLineValues, signalPeriod);
            const macdLine = macdLineValues.pop() || 0;
            const signalLine = signalLineValues.pop() || 0;
            const histogram = macdLine - signalLine;
            return { macdLine, signalLine, histogram };
        };

        async function konfluensi_fetchRealData(symbol, interval) { try { return await fetchBinanceAPIData('klines', { symbol, interval, limit: 1000 }); } catch (error) { console.error("Fetch Error:", error); konfluensi_ui.chartLoader.innerHTML = `<p class="text-red-400">Error: ${error.message}.</p>`; return null; } }
        function getPrecisionForAsset(price) { if (price > 1000) return 2; if (price > 1) return 4; if (price > 0.001) return 7; return 8; }
        function konfluensi_calculateVPVR(klines) { if (!klines || klines.length === 0) return { poc: 0, vah: 0, val: 0 }; let volumeProfile = {}; let minPrice = Infinity, maxPrice = -Infinity; klines.forEach(kline => { minPrice = Math.min(minPrice, parseFloat(kline[3])); maxPrice = Math.max(maxPrice, parseFloat(kline[2])); }); const priceRange = maxPrice - minPrice; const tickSize = 0.01; const numLevels = Math.min(50, Math.floor(priceRange / tickSize)); const levelSize = priceRange / numLevels; if (levelSize <= 0) return { poc: parseFloat(klines[klines.length-1][4]), vah: parseFloat(klines[klines.length-1][4])*1.01, val: parseFloat(klines[klines.length-1][4])*0.99 }; for (let i = 0; i <= numLevels; i++) { const levelPrice = minPrice + i * levelSize; volumeProfile[levelPrice] = 0; } klines.forEach(kline => { const closePrice = parseFloat(kline[4]); const volume = parseFloat(kline[5]); const priceLevel = minPrice + Math.floor((closePrice - minPrice) / levelSize) * levelSize; if(volumeProfile[priceLevel] !== undefined) { volumeProfile[priceLevel] += volume; } }); let totalVolume = 0; let pocPrice = 0, maxVolume = 0; for (const price in volumeProfile) { totalVolume += volumeProfile[price]; if (volumeProfile[price] > maxVolume) { maxVolume = volumeProfile[price]; pocPrice = parseFloat(price); } } const targetVolume = totalVolume * 0.70; let currentVolume = 0; let sortedLevels = Object.entries(volumeProfile).sort((a,b) => b[1] - a[1]); let valueAreaLevels = []; for (const [price, volume] of sortedLevels) { currentVolume += volume; valueAreaLevels.push(parseFloat(price)); if(currentVolume >= targetVolume) break; } const vah = Math.max(...valueAreaLevels); const val = Math.min(...valueAreaLevels); return { poc: pocPrice, vah, val }; }
        function konfluensi_calculateSMA(closes, period) { if (closes.length < period) return 0; const slice = closes.slice(-period); return slice.reduce((a, b) => a + b, 0) / period; }
        function konfluensi_calculateTrendStatus(klines) { if (klines.length < 50) return { status: 'CHOP', sma20: 0, sma50: 0 }; const closes = klines.map(k => parseFloat(k[4])); const sma20 = konfluensi_calculateSMA(closes, 20); const sma50 = konfluensi_calculateSMA(closes, 50); const status = sma20 > sma50 ? 'UPTREND' : (sma20 < sma50 ? 'DOWNTREND' : 'CHOP'); return { status, sma20, sma50 }; }
        function konfluensi_findEngulfingPattern(klines) { if (!klines || klines.length < 2) return { pattern: 'BELUM DITEMUKAN' }; const last = klines[klines.length - 1].map(parseFloat); const prev = klines[klines.length - 2].map(parseFloat); const [lastOpen, lastClose] = [last[1], last[4]]; const [prevOpen, prevClose] = [prev[1], prev[4]]; const isLastBullish = lastClose > lastOpen; const isPrevBullish = prevClose > prevOpen; const lastBody = Math.abs(lastClose - lastOpen); const prevBody = Math.abs(prevClose - prevOpen); if (isPrevBullish && !isLastBullish && lastBody > prevBody && lastClose < prevOpen && lastOpen > prevClose) { return { pattern: 'BEARISH ENGULFING' }; } if (!isPrevBullish && isLastBullish && lastBody > prevBody && lastClose > prevOpen && lastOpen < prevClose) { return { pattern: 'BULLISH ENGULFING' }; } return { pattern: 'BELUM DITEMUKAN' }; }
        function konfluensi_renderChart(symbol, interval) { const trace = { x: konfluensi_state.klines.map(k => new Date(parseInt(k[0]))), open: konfluensi_state.klines.map(k => parseFloat(k[1])), high: konfluensi_state.klines.map(k => parseFloat(k[2])), low: konfluensi_state.klines.map(k => parseFloat(k[3])), close: konfluensi_state.klines.map(k => parseFloat(k[4])), type: 'candlestick', name: symbol, increasing: { line: { color: '#34d399' } }, decreasing: { line: { color: '#ef4444' } } }; const layout = { title: { text: `${symbol} - ${interval.toUpperCase()}`, font: { color: '#d1d5db' } }, xaxis: { rangeslider: { visible: false }, gridcolor: '#374151' }, yaxis: { title: 'Harga', gridcolor: '#374151' }, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: '#1f2937', font: { color: '#d1d5db', family: 'Inter' }, shapes: [ { type: 'line', x0: new Date(parseInt(konfluensi_state.klines[0][0])), y0: konfluensi_state.vpvr.vah, x1: new Date(parseInt(konfluensi_state.klines[konfluensi_state.klines.length - 1][0])), y1: konfluensi_state.vpvr.vah, line: { color: '#ef4444', width: 2, dash: 'dash' } }, { type: 'line', x0: new Date(parseInt(konfluensi_state.klines[0][0])), y0: konfluensi_state.vpvr.poc, x1: new Date(parseInt(konfluensi_state.klines[konfluensi_state.klines.length - 1][0])), y1: konfluensi_state.vpvr.poc, line: { color: '#3b82f6', width: 3 } }, { type: 'line', x0: new Date(parseInt(konfluensi_state.klines[0][0])), y0: konfluensi_state.vpvr.val, x1: new Date(parseInt(konfluensi_state.klines[konfluensi_state.klines.length - 1][0])), y1: konfluensi_state.vpvr.val, line: { color: '#22c55e', width: 2, dash: 'dash' } }, ] }; Plotly.react(konfluensi_ui.chartDiv, [trace], layout, { responsive: true, displaylogo: false }); }
        function konfluensi_renderVPVR() { const precision = getPrecisionForAsset(konfluensi_state.lastClose); konfluensi_ui.vahValue.textContent = konfluensi_state.vpvr.vah.toFixed(precision); konfluensi_ui.pocValue.textContent = konfluensi_state.vpvr.poc.toFixed(precision); konfluensi_ui.valValue.textContent = konfluensi_state.vpvr.val.toFixed(precision); }
        function konfluensi_renderMATable() { konfluensi_ui.maStatusContainer.innerHTML = ''; const { status } = konfluensi_state.trendStatus; const colorClass = status === 'UPTREND' ? 'status-uptrend' : (status === 'DOWNTREND' ? 'status-downtrend' : 'status-chop'); const icon = status === 'UPTREND' ? '‚ñ≤' : (status === 'DOWNTREND' ? '‚ñº' : '‚ñ¨'); const row = document.createElement('div'); row.className = 'flex justify-between items-center'; row.innerHTML = `<span class="text-gray-400">Tren</span><span class="font-mono font-bold ${colorClass}">${icon} ${status}</span>`; konfluensi_ui.maStatusContainer.appendChild(row); }
        function konfluensi_renderPattern() { const { pattern } = konfluensi_state.pattern; konfluensi_ui.patternDisplay.innerHTML = ''; const p = document.createElement('p'); p.className = 'font-bold'; if (pattern !== 'BELUM DITEMUKAN') { p.textContent = pattern; p.classList.add('blinking-text-animation'); if (pattern === 'BULLISH ENGULFING') p.classList.add('text-green-400'); if (pattern === 'BEARISH ENGULFING') p.classList.add('text-red-400'); } else { p.textContent = 'TIDAK ADA'; p.classList.add('text-gray-500'); } konfluensi_ui.patternDisplay.appendChild(p); }
        
        // [MODIFIKASI] Render function baru untuk oscillator
        function konfluensi_renderOscillators() {
            const { rsi, stoch, macd } = konfluensi_state;
            konfluensi_ui.rsiValue.textContent = rsi.value.toFixed(2);
            konfluensi_ui.rsiStatus.textContent = rsi.status;
            konfluensi_ui.rsiStatus.className = `text-xs font-bold ml-2 ${rsi.class}`;
            konfluensi_ui.stochValue.textContent = `${stoch.k.toFixed(1)}/${stoch.d.toFixed(1)}`;
            konfluensi_ui.stochStatus.textContent = stoch.status;
            konfluensi_ui.stochStatus.className = `text-xs font-bold ml-2 ${stoch.class}`;
            konfluensi_ui.macdCross.textContent = macd.cross;
            konfluensi_ui.macdCross.className = `font-mono font-bold ${macd.crossClass}`;
            konfluensi_ui.macdHist.textContent = macd.histStatus;
            konfluensi_ui.macdHist.className = `font-mono font-medium ${macd.histClass}`;
        }
        
        // [MODIFIKASI] Logika verdict diperbarui
        function konfluensi_renderVerdict() {
            const { vpvr, pattern, trendStatus, lastClose, rsi, stoch, macd } = konfluensi_state;
            let bullishScore = 0, bearishScore = 0;
            if (lastClose < vpvr.val * 1.005) bullishScore += 2;
            if (lastClose > vpvr.vah * 0.995) bearishScore += 2;
            if (Math.abs(lastClose - vpvr.poc) / vpvr.poc < 0.005) { bullishScore++; bearishScore++; }
            if (trendStatus.status === 'UPTREND') bullishScore += 2;
            if (trendStatus.status === 'DOWNTREND') bearishScore += 2;
            if (pattern.pattern === 'BULLISH ENGULFING') bullishScore += 3;
            if (pattern.pattern === 'BEARISH ENGULFING') bearishScore += 3;
            if (rsi.status === 'Oversold') bullishScore += 2;
            if (rsi.status === 'Overbought') bearishScore += 2;
            if (stoch.status === 'Oversold') bullishScore++;
            if (stoch.status === 'Overbought') bearishScore++;
            if (macd.cross === 'BULLISH') bullishScore += 2;
            if (macd.cross === 'BEARISH') bearishScore += 2;
            if (macd.histStatus === 'NAIK') bullishScore++;
            if (macd.histStatus === 'TURUN') bearishScore++;
            let verdict = '';
            if (bullishScore >= 8 && bullishScore > bearishScore * 2) {
                verdict = `<strong class="text-green-400">SINYAL BELI KUAT.</strong> Konfluensi dari ${bullishScore} poin bullish terdeteksi.`;
            } else if (bearishScore >= 8 && bearishScore > bullishScore * 2) {
                verdict = `<strong class="text-red-400">SINYAL JUAL KUAT.</strong> Konfluensi dari ${bearishScore} poin bearish terdeteksi.`;
            } else if (bullishScore > bearishScore + 2) {
                verdict = `<strong class="text-blue-400">SIAGA BELI.</strong> Ada bias bullish (${bullishScore} vs ${bearishScore}), tapi tunggu konfirmasi lebih lanjut.`;
            } else if (bearishScore > bullishScore + 2) {
                verdict = `<strong class="text-yellow-400">SIAGA JUAL.</strong> Ada bias bearish (${bearishScore} vs ${bullishScore}), tapi tunggu konfirmasi lebih lanjut.`;
            } else {
                verdict = `<strong>STANDBY.</strong> Pasar netral atau sinyal bercampur. Jangan paksakan trading.`;
            }
            konfluensi_ui.verdictText.innerHTML = verdict;
            konfluensi_ui.verdictText.style.display = 'block';
            konfluensi_ui.verdictLoader.style.display = 'none';
        }

        async function konfluensi_updateDashboard() { 
            const symbol = konfluensi_ui.assetInput.value.trim().toUpperCase();
            if (!symbol) { showCustomMessage("Harap pilih atau ketik simbol aset.", "error"); return; }
            konfluensi_ui.chartDiv.style.visibility = 'hidden'; 
            konfluensi_ui.chartLoader.style.display = 'flex'; 
            konfluensi_ui.chartLoader.innerHTML = `<div class="loader mx-auto"></div><p class="mt-4 text-gray-400">Memuat data pasar...</p>`;
            konfluensi_ui.verdictLoader.style.display = 'block'; 
            konfluensi_ui.verdictText.style.display = 'none'; 
            const interval = konfluensi_ui.timeframeSelect.value; 
            konfluensi_state.klines = await konfluensi_fetchRealData(symbol, interval); 
            if (!konfluensi_state.klines) { konfluensi_ui.verdictText.textContent = "Gagal memuat data."; konfluensi_ui.verdictText.style.display = 'block'; konfluensi_ui.verdictLoader.style.display = 'none'; return; } 
            
            const closes = konfluensi_state.klines.map(k => parseFloat(k[4]));
            konfluensi_state.lastClose = closes[closes.length - 1];
            
            // Calculate all indicators
            konfluensi_state.vpvr = konfluensi_calculateVPVR(konfluensi_state.klines); 
            konfluensi_state.trendStatus = konfluensi_calculateTrendStatus(konfluensi_state.klines); 
            konfluensi_state.pattern = konfluensi_findEngulfingPattern(konfluensi_state.klines); 
            
            const rsiValue = parseFloat(calculateRSI(closes));
            konfluensi_state.rsi = { value: rsiValue, status: rsiValue > 70 ? 'Overbought' : (rsiValue < 30 ? 'Oversold' : 'Netral'), class: rsiValue > 70 ? 'text-red-400' : (rsiValue < 30 ? 'text-green-400' : 'text-gray-400') };
            
            const stochValues = calculateStochasticRSI(closes);
            konfluensi_state.stoch = { k: stochValues.k, d: stochValues.d, status: stochValues.k > 80 ? 'Overbought' : (stochValues.k < 20 ? 'Oversold' : 'Netral'), class: stochValues.k > 80 ? 'text-red-400' : (stochValues.k < 20 ? 'text-green-400' : 'text-gray-400') };

            const macdValues = calculateMACD(closes);
            const prevMacd = calculateMACD(closes.slice(0, -1));
            let crossStatus = "TIDAK ADA";
            let crossClass = "text-gray-400";
            if(prevMacd.macdLine < prevMacd.signalLine && macdValues.macdLine > macdValues.signalLine) { crossStatus = "BULLISH"; crossClass = "text-green-400"; }
            if(prevMacd.macdLine > prevMacd.signalLine && macdValues.macdLine < macdValues.signalLine) { crossStatus = "BEARISH"; crossClass = "text-red-400"; }
            konfluensi_state.macd = { ...macdValues, cross: crossStatus, crossClass, histStatus: macdValues.histogram > 0 ? 'NAIK' : 'TURUN', histClass: macdValues.histogram > 0 ? 'text-green-400' : 'text-red-400' };

            // Render everything
            konfluensi_renderChart(symbol, interval); 
            konfluensi_renderVPVR(); 
            konfluensi_renderMATable(); 
            konfluensi_renderPattern(); 
            konfluensi_renderOscillators();
            konfluensi_renderVerdict(); 
            
            konfluensi_ui.chartLoader.style.display = 'none'; 
            konfluensi_ui.chartDiv.style.visibility = 'visible'; 
        }
        
        konfluensi_ui.runBtn.addEventListener('click', konfluensi_updateDashboard);
    }

    // --- INISIALISASI EVENT LISTENERS ---
    apiKeyInput.addEventListener('input', () => {
        localStorage.setItem('valhallaUltimateApiKey', apiKeyInput.value);
        checkEnableAnalyzeButton();
    });
    setupDropZone(htfDropZone, htfUploadInput, htfChartPreview, htfChartPlaceholder, (val) => htfImageBase64 = val, checkEnableAnalyzeButton);
    setupDropZone(ltfDropZone, ltfUploadInput, ltfChartPreview, ltfChartPlaceholder, (val) => ltfImageBase64 = val, checkEnableAnalyzeButton);
    analyzeBtn.addEventListener('click', startAnalysis);
    exportBtn.addEventListener('click', exportReport);
    analysisWrapper.addEventListener('click', (e) => {
        if (e.target.classList.contains('use-data-btn')) useAnalysisData(e);
    });
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
            button.classList.add('active');
            const tabId = button.getAttribute('data-tab');
            document.getElementById(tabId).classList.remove('hidden');

            // [MODIFIKASI] Panggil fungsi konfluensi saat tab diklik pertama kali
            if (tabId === 'konfluensi' && !isKonfluensiInitialized) {
                initializeKonfluensiDashboard();
                isKonfluensiInitialized = true;
            }
        });
    });
    btnPosisiLong.addEventListener('click', () => {
        btnPosisiLong.classList.add('active', 'long');
        btnPosisiShort.classList.remove('active', 'short');
        populateCalculatorFromAnalysis('long');
    });
    btnPosisiShort.addEventListener('click', () => {
        btnPosisiShort.classList.add('active', 'short');
        btnPosisiLong.classList.remove('active', 'long');
        populateCalculatorFromAnalysis('short');
    });
    hitungRencanaBtn.addEventListener('click', hitungRencana);
    optimizePlanBtn.addEventListener('click', optimizeTradePlan);
    
    generateProyeksiBtn.addEventListener('click', startPriceProjection);
    
    proyeksiOutput.addEventListener('click', (e) => {
        if (e.target.classList.contains('use-projection-btn')) {
            const price = e.target.dataset.price;
            if (price) {
                document.querySelector('.tab-button[data-tab="kalkulator"]').click();
                document.getElementById('calc-tp1').value = parseFloat(price).toFixed(pricePrecision);
                showCustomMessage(`Harga Proyeksi ${price} dimasukkan ke TP1.`, 'info');
            }
        }
    });

    // --- SETUP AWAL ---
    const savedApiKey = localStorage.getItem('valhallaUltimateApiKey');
    if (savedApiKey) apiKeyInput.value = savedApiKey;
    checkEnableAnalyzeButton();
    const activeTab = document.querySelector('.tab-button.active');
    if (!activeTab) {
        document.querySelector('.tab-button[data-tab="analisa"]').click();
    }
});
</script>
</body>
</html>
