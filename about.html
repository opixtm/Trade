<!DOCTYPE html>
<html lang="id" class=""> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Analisa Kripto Cerdas</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Base Styles - Light Mode */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF7;
            color: #3D352E;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .card {
            background-color: #FFFFFF;
            border: 1px solid #EAE5E0;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: all 0.3s ease-in-out;
        }
        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
            transform: translateY(-2px);
        }
        .btn-primary {
            background-color: #4A7C59;
            color: #FFFFFF;
            font-weight: 600;
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #3B6347;
        }
        .input-primary {
            background-color: #F8F5F1;
            border: 1px solid #DCD6CF;
            border-radius: 0.5rem;
            padding: 0.625rem 1rem;
            width: 100%;
            color: #3D352E;
        }
        .input-primary:focus {
            outline: none;
            border-color: #4A7C59;
            box-shadow: 0 0 0 2px rgba(74, 124, 89, 0.2);
        }
        .tag-green { background-color: #E6F4EA; color: #4A7C59; }
        .tag-red { background-color: #FCE8E8; color: #A83A3A; }
        .tag-yellow { background-color: #FFF8E1; color: #B5840F; }
        .tag-gray { background-color: #F1F3F4; color: #5F6368; }

        /* Dark Mode Styles */
        .dark body {
            background-color: #121212;
            color: #E0E0E0;
        }
        .dark .card {
            background-color: #1E1E1E;
            border-color: #333;
        }
        .dark .input-primary {
            background-color: #2a2a2a;
            border-color: #444;
            color: #E0E0E0;
        }
        .dark .input-primary:focus {
            border-color: #4A7C59;
            box-shadow: 0 0 0 2px rgba(74, 124, 89, 0.3);
        }
        .dark .tag-green { background-color: rgba(74, 124, 89, 0.2); color: #69b37f; }
        .dark .tag-red { background-color: rgba(168, 58, 58, 0.2); color: #d17474; }
        .dark .tag-yellow { background-color: rgba(181, 132, 15, 0.2); color: #e0c273; }
        .dark .tag-gray { background-color: rgba(95, 99, 104, 0.2); color: #9aa0a6; }
        .dark .text-gray-800 { color: #E0E0E0; }
        .dark .text-gray-500 { color: #9E9E9E; }
        .dark .text-gray-600 { color: #BDBDBD; }
        .dark .text-gray-700 { color: #E0E0E0; }
        .dark .text-green-700 { color: #69b37f; }
        .dark .text-red-700 { color: #d17474; }
        .dark .text-blue-700 { color: #8ab4f8; }
        .dark #mainChart { border-color: #333; }
        .dark hr { border-color: #333; }
        .dark .p-3.bg-gray-50 { background-color: #2a2a2a; border-color: #3a3a3a !important; }

        .chart-container {
            position: relative;
            width: 100%;
            height: 400px;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4A7C59;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased">
    <div class="absolute left-4 top-1/2 -translate-y-1/2">
        <a href="https://opixtm.github.io/Trade/" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white font-regular py-2 px-4 rounded transition-colors duration-300">
            PROJECTOR
        </a>
    </div>
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <header class="mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Dasbor Analisa Kripto</h1>
                <p class="text-gray-500 mt-1">Ditenagai oleh AI untuk keputusan yang lebih cerdas.</p>
            </div>
            <button id="theme-toggle" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 focus:outline-none">
                <svg id="theme-toggle-dark-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                <svg id="theme-toggle-light-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 7.072l.707-.707a1 1 0 10-1.414-1.414l-.707.707a1 1 0 001.414 1.414zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z"></path></svg>
            </button>
            <div class="absolute right-4 top-1/2 -translate-y-1/2">
        <a href="https://opixtm.github.io/Trade/services" target="_blank" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded transition-colors duration-300">
            USTADZ AI
        </a>
    </div>
        </header>

        <main>
            <div class="space-y-6 mb-8">
                <section class="card p-4">
                     <label for="gemini-api-key" class="block text-xs font-semibold mb-2 text-gray-500">ðŸ”‘ GOOGLE AI API KEY</label>
                     <input type="password" id="gemini-api-key" class="input-primary !text-xs !py-1.5" placeholder="Tempel API Key dari Google AI Studio di sini...">
                </section>
                
                <section id="asset-selector" class="card p-6">
                    <label for="asset-input" class="block text-lg font-semibold mb-2">Pilih Aset untuk Dianalisa</label>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="asset-input" list="asset-list" class="input-primary flex-grow" placeholder="Ketik simbol aset, contoh: BTCUSDT">
                        <datalist id="asset-list">
                            <option value="BTCUSDT">
                            <option value="ETHUSDT">
                            <option value="SOLUSDT">
                        </datalist>
                        <button id="analyze-asset-btn" class="btn-primary">Analisa</button>
                    </div>
                    <p id="asset-error" class="text-red-600 text-sm mt-2 hidden"></p>
                </section>
            </div>

            <div id="dashboard-content" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-8">
                        <section id="main-chart-section" class="card p-4 sm:p-6">
                             <h2 class="text-xl font-bold mb-4">Visualisasi Harga & Level Kunci</h2>
                             <div class="chart-container">
                                <canvas id="mainChart"></canvas>
                             </div>
                        </section>

                        <section id="smc-section" class="card p-6">
                            <h2 class="text-xl font-bold mb-4">Wawasan Smart Money Concepts (SMC)</h2>
                            <div class="space-y-4">
                                <div>
                                    <h3 class="font-semibold text-gray-700">Narasi Struktur Pasar</h3>
                                    <p id="smc-narrative" class="text-gray-600 text-sm mt-1">-</p>
                                </div>
                                <hr class="dark:border-gray-700"/>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <h3 class="font-semibold text-green-700">POI Bullish Potensial</h3>
                                        <p id="smc-poi-bullish" class="text-gray-600 text-sm mt-1">-</p>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-red-700">POI Bearish Potensial</h3>
                                        <p id="smc-poi-bearish" class="text-gray-600 text-sm mt-1">-</p>
                                    </div>
                                </div>
                                <hr class="dark:border-gray-700"/>
                                <div>
                                    <h3 class="font-semibold text-blue-700">Kesimpulan SMC</h3>
                                    <p id="smc-conclusion" class="text-gray-600 text-sm mt-1">-</p>
                                </div>
                            </div>
                        </section>
                    </div>

                    <aside class="space-y-8">
                        <section id="current-state-section" class="card p-6">
                            <h2 class="text-xl font-bold mb-4">Kondisi Pasar Saat Ini</h2>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-500">Harga Terkini</span>
                                    <span id="current-price" class="font-bold text-lg">-</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-500">Perubahan 24j</span>
                                    <span id="price-change-24h" class="font-semibold">-</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-500">Sentimen</span>
                                    <span id="market-sentiment" class="tag tag-gray">-</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-500">Volatilitas</span>
                                    <span id="market-volatility" class="tag tag-gray">-</span>
                                </div>
                            </div>
                        </section>
                        
                        <section id="confluence-signal-section" class="card p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold">Sinyal Konfluensi</h2>
                                <select id="confluence-timeframe" class="input-primary !w-auto text-sm !py-1 !px-2">
                                    <option value="1m">1 Menit</option>
                                            <option value="3m">3 Menit</option>
                                            <option value="5m">5 Menit</option>
                                            <option value="15m">15 Menit</option>
                                            <option value="1h" selected>1 Jam</option>
                                            <option value="2h">2 Jam</option>
                                            <option value="4h">4 Jam</option>
                                            <option value="6h">6 Jam</option>
                                            <option value="12h">12 Jam</option>
                                            <option value="1d">1 Hari</option>
                                            <option value="3d">3 Hari</option>
                                            <option value="1w">1 Minggu</option>
                                </select>
                            </div>
                            <div id="confluence-verdict" class="text-center p-4 rounded-lg">
                                <p class="text-2xl font-bold">-</p>
                                <p class="text-sm text-gray-500 mt-1">-</p>
                            </div>
                        </section>

                        <section id="projection-section" class="card p-6">
                            <h2 class="text-xl font-bold mb-4">Proyeksi Harga AI</h2>
                            <div class="space-y-3" id="projection-list">
                                </div>
                        </section>

                        <section id="ai-verdict-section" class="card p-6">
                            <h2 class="text-xl font-bold mb-4">Keputusan Akhir AI</h2>
                            <div class="grid grid-cols-1 gap-4">
                                <div>
                                    <h3 class="font-semibold text-green-700">Untuk Calon Pembeli</h3>
                                    <p id="verdict-buyer-action" class="text-lg font-bold">-</p>
                                    <p id="verdict-buyer-reason" class="text-sm text-gray-600 mt-1">-</p>
                                </div>
                                <hr class="dark:border-gray-700"/>
                                <div>
                                    <h3 class="font-semibold text-blue-700">Untuk Pemilik Aset</h3>
                                    <p id="verdict-holder-action" class="text-lg font-bold">-</p>
                                    <p id="verdict-holder-reason" class="text-sm text-gray-600 mt-1">-</p>
                                </div>
                            </div>
                        </section>

                    </aside>
                </div>
            </div>
            
            <div id="initial-placeholder" class="text-center py-20">
                <p class="text-xl text-gray-500">Silakan masukkan simbol aset dan API Key untuk memulai analisa.</p>
            </div>
            
            <div id="loader-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex-col items-center justify-center hidden z-50">
                 <div class="loader"></div>
                 <p id="loader-text" class="text-white font-semibold mt-4">Memulai Analisa...</p>
            </div>
        </main>

    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- THEME TOGGLE LOGIC (Tetap sama) ---
    const themeToggleBtn = document.getElementById('theme-toggle');
    const darkIcon = document.getElementById('theme-toggle-dark-icon');
    const lightIcon = document.getElementById('theme-toggle-light-icon');

    if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
        darkIcon.classList.remove('hidden');
    } else {
        document.documentElement.classList.remove('dark');
        lightIcon.classList.remove('hidden');
    }

    themeToggleBtn.addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
        darkIcon.classList.toggle('hidden');
        lightIcon.classList.toggle('hidden');
        if (document.documentElement.classList.contains('dark')) {
            localStorage.setItem('theme', 'dark');
        } else {
            localStorage.setItem('theme', 'light');
        }
        if (mainChartInstance) mainChartInstance.update();
    });

    // --- DOM ELEMENT SELECTORS (Tetap sama) ---
    const assetInput = document.getElementById('asset-input');
    const apiKeyInput = document.getElementById('gemini-api-key');
    const analyzeBtn = document.getElementById('analyze-asset-btn');
    const assetError = document.getElementById('asset-error');
    const dashboardContent = document.getElementById('dashboard-content');
    const initialPlaceholder = document.getElementById('initial-placeholder');
    const loaderOverlay = document.getElementById('loader-overlay');
    const loaderText = document.getElementById('loader-text');
    const confluenceTimeframeSelect = document.getElementById('confluence-timeframe');
    let mainChartInstance = null;
    let analysisCache = {}; 

    apiKeyInput.value = localStorage.getItem('geminiApiKey') || '';
    apiKeyInput.addEventListener('change', () => {
        localStorage.setItem('geminiApiKey', apiKeyInput.value);
    });

    analyzeBtn.addEventListener('click', runFullAnalysis);
    assetInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') runFullAnalysis();
    });
    
    // =======================================================================
    // === PERUBAHAN UTAMA: Event listener untuk Sinyal Konfluensi ==========
    // =======================================================================
    confluenceTimeframeSelect.addEventListener('change', handleTimeframeChange);


    // --- API & CALCULATION ENGINE (Tetap sama) ---
    async function fetchBinanceAPIData(endpoint, params = {}) {
        const baseUrl = 'https://api.binance.com/api/v3';
        const query = new URLSearchParams(params).toString();
        const url = `${baseUrl}/${endpoint}?${query}`;
        try {
            const response = await fetch(url);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Binance API error: ${errorData.msg || response.statusText}`);
            }
            return response.json();
        } catch (error) {
            console.error(`Network Error fetching from Binance: ${error.message}`);
            throw new Error(`Gagal mengambil data dari Binance. Periksa koneksi atau simbol aset.`);
        }
    }

    async function callGemini(parts) {
        const apiKey = apiKeyInput.value.trim();
        if (!apiKey) throw new Error("API Key Google AI belum dimasukkan.");

        const model = 'gemini-1.5-flash';
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
        const payload = {
            contents: [{ role: "user", parts }],
            generationConfig: {
                "response_mime_type": "application/json",
                "max_output_tokens": 8192,
                "temperature": 0.7
            }
        };

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorBody = await response.json();
            throw new Error(`Google AI API error: ${errorBody?.error?.message || response.statusText}`);
        }
        const result = await response.json();
        if (result.candidates && result.candidates[0] && result.candidates[0].content.parts[0]) {
            return JSON.parse(result.candidates[0].content.parts[0].text.trim());
        }
        throw new Error("Respons dari AI tidak valid atau kosong.");
    }
    const calculateRSI = (closes, period = 14) => {
        if (!closes || closes.length <= period) return 50;
        let gains = [], losses = [];
        for (let i = 1; i < closes.length; i++) {
            const diff = closes[i] - closes[i - 1];
            diff >= 0 ? (gains.push(diff), losses.push(0)) : (gains.push(0), losses.push(Math.abs(diff)));
        }
        let avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
        let avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;
        for (let i = period; i < gains.length; i++) {
            avgGain = (avgGain * (period - 1) + gains[i]) / period;
            avgLoss = (avgLoss * (period - 1) + losses[i]) / period;
        }
        if (avgLoss === 0) return 100;
        const rs = avgGain / avgLoss;
        return (100 - (100 / (1 + rs)));
    };
    
    // --- MAIN APPLICATION LOGIC ---
    
    /**
     * Fungsi baru untuk menangani perubahan timeframe secara spesifik.
     */
    async function handleTimeframeChange() {
        const asset = assetInput.value.trim().toUpperCase();
        const newTimeframe = confluenceTimeframeSelect.value;
        
        // Jangan lakukan apa-apa jika belum ada analisa awal
        if (!asset || !analysisCache.currentState) {
            return;
        }

        showLoader(true, `Memperbarui data untuk timeframe ${newTimeframe}...`);
        try {
            // 1. Ambil data kline baru untuk timeframe yang dipilih
            const klines = await fetchBinanceAPIData('klines', { symbol: asset, interval: newTimeframe, limit: 200 });

            // 2. Kalkulasi ulang sinyal konfluensi
            const closes = klines.map(k => parseFloat(k[4]));
            const rsi = calculateRSI(closes);
            const newConfluenceData = getConfluenceScore(rsi);
            
            // 3. Update cache untuk sinyal konfluensi dan data chart
            analysisCache.confluence[newTimeframe] = newConfluenceData;
            analysisCache.chartData = {
                labels: klines.map(k => new Date(k[0])),
                prices: closes,
            };

            // 4. Update UI yang relevan
            displayConfluenceWidget(); // Render kartu sinyal konfluensi
            renderMainChart(analysisCache.chartData, analysisCache.keyLevels); // Render ulang chart dengan animasi

        } catch (error) {
            console.error("Timeframe update failed:", error);
            showError(`Gagal memperbarui data timeframe: ${error.message}`);
        } finally {
            showLoader(false);
        }
    }

    async function runFullAnalysis() {
        const asset = assetInput.value.trim().toUpperCase();
        if (!asset) {
            showError('Silakan masukkan simbol aset.');
            return;
        }
        if (!apiKeyInput.value.trim()) {
            showError('Silakan masukkan API Key Google AI.');
            return;
        }

        hideError();
        showLoader(true, 'Memulai Analisa...');

        try {
            // Fetch all data required for a full analysis
            showLoader(true, `Mengambil data pasar untuk ${asset}...`);
            const [tickerData, klines1d, klines4h, klines1h] = await Promise.all([
                fetchBinanceAPIData('ticker/24hr', { symbol: asset }),
                fetchBinanceAPIData('klines', { symbol: asset, interval: '1d', limit: 200 }),
                fetchBinanceAPIData('klines', { symbol: asset, interval: '4h', limit: 200 }),
                fetchBinanceAPIData('klines', { symbol: asset, interval: '1h', limit: 200 })
            ]);
            
            // Local calculations
            showLoader(true, 'Menghitung indikator teknikal...');
            const closes1d = klines1d.map(k => parseFloat(k[4]));
            const rsi1d = calculateRSI(closes1d);
            const closes4h = klines4h.map(k => parseFloat(k[4]));
            const rsi4h = calculateRSI(closes4h);
            const closes1h = klines1h.map(k => parseFloat(k[4]));
            const rsi1h = calculateRSI(closes1h);

            const calculateSimpleVPVR = (klines) => {
                const volumeProfile = {};
                klines.forEach(k => {
                    const price = parseFloat(k[4]); const volume = parseFloat(k[5]);
                    const priceLevel = Math.round(price / 100) * 100;
                    volumeProfile[priceLevel] = (volumeProfile[priceLevel] || 0) + volume;
                });
                let poc = 0, maxVolume = 0;
                Object.entries(volumeProfile).forEach(([price, volume]) => {
                    if (volume > maxVolume) { maxVolume = volume; poc = parseFloat(price); }
                });
                return { poc, vah: poc * 1.05, val: poc * 0.95 };
            };
            const vpvrLevels = calculateSimpleVPVR(klines1d);

            // AI analysis
            showLoader(true, 'Meminta analisa dari AI...');
            const prompt = `Anda adalah analis trading profesional untuk ${asset}. Diberikan data: Harga Terkini: ${tickerData.lastPrice}, Perubahan 24j: ${tickerData.priceChangePercent}%, RSI (1D): ${rsi1d.toFixed(2)}, Point of Control (POC): ${vpvrLevels.poc}. Tugas Anda adalah memberikan output HANYA dalam format JSON dengan skema berikut: {"sentiment": {"label": "string (Netral/Optimis/Pesimis)", "volatility": "string (Rendah/Sedang/Tinggi)"},"smc": {"narrative": "string", "poi_bullish": "string", "poi_bearish": "string", "conclusion": "string"},"projections": [{"period": "string", "target": "string", "reason": "string"}],"verdicts": {"buyerAction": "string", "buyerReason": "string", "holderAction": "string", "holderReason": "string"}}`;
            const aiAnalysis = await callGemini([{ text: prompt }]);

            // Combine data and update cache
            showLoader(true, 'Menyusun dasbor...');
            const price = parseFloat(tickerData.lastPrice);
            const change = parseFloat(tickerData.priceChangePercent);
            
            analysisCache = {
                currentState: {
                    price: price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
                    change: `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`,
                    changeColor: change >= 0 ? 'text-green-600' : 'text-red-600',
                    sentiment: aiAnalysis.sentiment.label,
                    sentimentColor: getSentimentColor(aiAnalysis.sentiment.label),
                    volatility: aiAnalysis.sentiment.volatility,
                    volatilityColor: getVolatilityColor(aiAnalysis.sentiment.volatility),
                },
                // Default chart view is based on the selected confluence timeframe
                chartData: {
                    labels: klines1h.map(k => new Date(k[0])),
                    prices: klines1h.map(k => parseFloat(k[4])),
                },
                keyLevels: {
                    poc: vpvrLevels.poc, vah: vpvrLevels.vah, val: vpvrLevels.val,
                    poi_bullish: parseFloat(aiAnalysis.smc.poi_bullish.match(/[\d,.]+/)?.[0]?.replace(/,/g, '')) || vpvrLevels.val,
                    poi_bearish: parseFloat(aiAnalysis.smc.poi_bearish.match(/[\d,.]+/)?.[0]?.replace(/,/g, '')) || vpvrLevels.vah,
                },
                smc: aiAnalysis.smc,
                projections: aiAnalysis.projections,
                verdicts: aiAnalysis.verdicts,
                confluence: {
                    "1h": getConfluenceScore(rsi1h),
                    "4h": getConfluenceScore(rsi4h),
                    "1d": getConfluenceScore(rsi1d),
                }
            };
            
            updateDashboardUI(analysisCache);

        } catch (error) {
            console.error("Analysis failed:", error);
            showError(error.message);
        } finally {
            showLoader(false);
        }
    }

    // --- UI POPULATION FUNCTIONS (Fungsi-fungsi ini tetap sama) ---
    function updateDashboardUI(data) {
        initialPlaceholder.classList.add('hidden');
        dashboardContent.classList.remove('hidden');
        populateCurrentState(data.currentState);
        populateSMC(data.smc);
        populateProjections(data.projections);
        populateVerdicts(data.verdicts);
        displayConfluenceWidget(); 
        renderMainChart(data.chartData, data.keyLevels);
    }
    function showError(message) { assetError.textContent = message; assetError.classList.remove('hidden'); }
    function hideError() { assetError.classList.add('hidden'); }
    function showLoader(show, text = '') {
        if (show) { loaderText.textContent = text; loaderOverlay.classList.remove('hidden'); loaderOverlay.classList.add('flex'); } 
        else { loaderOverlay.classList.add('hidden'); loaderOverlay.classList.remove('flex'); }
    }
    function populateCurrentState(data) {
        document.getElementById('current-price').textContent = `$${data.price}`;
        const changeEl = document.getElementById('price-change-24h');
        changeEl.textContent = data.change; changeEl.className = `font-semibold ${data.changeColor}`;
        const sentimentEl = document.getElementById('market-sentiment');
        sentimentEl.textContent = data.sentiment; sentimentEl.className = `tag ${data.sentimentColor}`;
        const volatilityEl = document.getElementById('market-volatility');
        volatilityEl.textContent = data.volatility; volatilityEl.className = `tag ${data.volatilityColor}`;
    }
    function populateSMC(data) {
        document.getElementById('smc-narrative').textContent = data.narrative;
        document.getElementById('smc-poi-bullish').textContent = data.poi_bullish;
        document.getElementById('smc-poi-bearish').textContent = data.poi_bearish;
        document.getElementById('smc-conclusion').textContent = data.conclusion;
    }
    function populateProjections(data) {
        const listEl = document.getElementById('projection-list'); listEl.innerHTML = '';
        data.forEach(proj => {
            const div = document.createElement('div');
            div.className = "p-3 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700";
            div.innerHTML = `<p class="font-semibold text-sm text-gray-800">${proj.period}</p><p class="font-bold text-lg text-green-700">${proj.target}</p><p class="text-xs text-gray-500 mt-1">${proj.reason}</p>`;
            listEl.appendChild(div);
        });
    }
    function populateVerdicts(data) {
        document.getElementById('verdict-buyer-action').textContent = data.buyerAction;
        document.getElementById('verdict-buyer-reason').textContent = data.buyerReason;
        document.getElementById('verdict-holder-action').textContent = data.holderAction;
        document.getElementById('verdict-holder-reason').textContent = data.holderReason;
    }
    const getSentimentColor = (sentiment) => {
        const s = sentiment.toLowerCase();
        if (s.includes('optimis')) return 'tag-green'; if (s.includes('pesimis')) return 'tag-red'; return 'tag-yellow';
    };
    const getVolatilityColor = (volatility) => {
        const v = volatility.toLowerCase();
        if (v.includes('tinggi')) return 'tag-red'; if (v.includes('rendah')) return 'tag-green'; return 'tag-yellow';
    };
    const getConfluenceScore = (rsi) => {
        let bullishScore = 5, bearishScore = 5;
        if (rsi > 50) bullishScore += Math.min(4, Math.floor((rsi - 50) / 5));
        if (rsi < 50) bearishScore += Math.min(4, Math.floor((50 - rsi) / 5));
        if (rsi > 70) bearishScore += 2; if (rsi < 30) bullishScore += 2;
        const total = bullishScore + bearishScore;
        bullishScore = Math.round((bullishScore / total) * 10); bearishScore = 10 - bullishScore;
        let verdict = "STANDBY";
        if (bullishScore >= 7) verdict = "SINYAL BELI KUAT";
        else if (bullishScore >= 6) verdict = "SIAGA BELI";
        else if (bearishScore >= 7) verdict = "SINYAL JUAL KUAT";
        else if (bearishScore >= 6) verdict = "SIAGA JUAL";
        return { verdict, score: `Konfluensi Bullish (${bullishScore} vs ${bearishScore})` };
    };
    function displayConfluenceWidget() {
        if (!analysisCache.confluence) return;
        const timeframe = confluenceTimeframeSelect.value;
        const data = analysisCache.confluence[timeframe];
        const verdictEl = document.getElementById('confluence-verdict');
        const verdictTextEl = verdictEl.querySelector('p:first-child');
        const scoreTextEl = verdictEl.querySelector('p:last-child');
        verdictTextEl.textContent = data.verdict; scoreTextEl.textContent = data.score;
        verdictEl.className = 'text-center p-4 rounded-lg'; verdictTextEl.className = 'text-2xl font-bold';
        if (data.verdict.includes('BELI')) { verdictEl.classList.add('bg-green-100', 'dark:bg-green-900/50'); verdictTextEl.classList.add('text-green-800', 'dark:text-green-300'); } 
        else if (data.verdict.includes('JUAL')) { verdictEl.classList.add('bg-red-100', 'dark:bg-red-900/50'); verdictTextEl.classList.add('text-red-800', 'dark:text-red-300'); } 
        else if (data.verdict.includes('SIAGA')) { verdictEl.classList.add('bg-yellow-100', 'dark:bg-yellow-900/50'); verdictTextEl.classList.add('text-yellow-800', 'dark:text-yellow-300'); } 
        else { verdictEl.classList.add('bg-gray-100', 'dark:bg-gray-700/50'); verdictTextEl.classList.add('text-gray-800', 'dark:text-gray-300'); }
    }
    function renderMainChart(chartData, keyLevels) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (mainChartInstance) { mainChartInstance.destroy(); }
        const isDarkMode = document.documentElement.classList.contains('dark');
        const keyLevelsPlugin = {
            id: 'keyLevelsPlugin',
            afterDraw: (chart) => {
                const yAxis = chart.scales.y; const ctx = chart.ctx;
                const drawLine = (value, color, text, dash = []) => {
                    if (isNaN(value)) return; const y = yAxis.getPixelForValue(value);
                    ctx.save(); ctx.beginPath(); ctx.moveTo(chart.chartArea.left, y);
                    ctx.lineTo(chart.chartArea.right, y); ctx.lineWidth = 1.5;
                    ctx.strokeStyle = color; ctx.setLineDash(dash); ctx.stroke();
                    ctx.fillStyle = color; ctx.font = '600 10px Inter'; ctx.textAlign = 'left';
                    ctx.textBaseline = 'bottom';
                    ctx.fillText(`${text}: ${value.toLocaleString()}`, chart.chartArea.left + 5, y - 2);
                    ctx.restore();
                };
                const colors = isDarkMode ? 
                    { poc: '#8ab4f8', vah: '#c58af9', val: '#c58af9', bullish: '#69b37f', bearish: '#d17474' } :
                    { poc: 'rgba(67, 56, 202, 0.8)', vah: 'rgba(217, 70, 239, 0.7)', val: 'rgba(217, 70, 239, 0.7)', bullish: 'rgba(5, 150, 105, 0.8)', bearish: 'rgba(220, 38, 38, 0.8)' };
                drawLine(keyLevels.poc, colors.poc, `POC`); drawLine(keyLevels.vah, colors.vah, `VAH`, [5, 5]);
                drawLine(keyLevels.val, colors.val, `VAL`, [5, 5]); drawLine(keyLevels.poi_bullish, colors.bullish, `POI Bullish`, [3, 3]);
                drawLine(keyLevels.poi_bearish, colors.bearish, `POI Bearish`, [3, 3]);
            }
        };
        mainChartInstance = new Chart(ctx, {
            type: 'line', data: { labels: chartData.labels, datasets: [{
                    label: 'Harga', data: chartData.prices, borderColor: '#4A7C59',
                    backgroundColor: 'rgba(74, 124, 89, 0.1)', fill: true, tension: 0.1,
                    pointRadius: 0, pointHoverRadius: 5, borderWidth: 2,
                }] },
            options: {
                responsive: true, maintainAspectRatio: false, animation: { duration: 1000, easing: 'easeInOutQuad' },
                scales: {
                    x: { type: 'time', time: { unit: 'day', tooltipFormat: 'MMM dd, yyyy' }, grid: { display: false },
                        ticks: { color: isDarkMode ? '#9E9E9E' : '#5F6368', maxRotation: 0, autoSkip: true, maxTicksLimit: 7 } },
                    y: { grid: { color: isDarkMode ? '#333' : '#EAE5E0' },
                        ticks: { color: isDarkMode ? '#9E9E9E' : '#5F6368', callback: value => '$' + value.toLocaleString() } }
                },
                plugins: { legend: { display: false },
                    tooltip: { enabled: true, mode: 'index', intersect: false,
                        callbacks: { label: context => `Harga: ${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed.y)}` } },
                    keyLevelsPlugin },
                interaction: { mode: 'index', intersect: false }
            },
            plugins: [keyLevelsPlugin]
        });
    }
});
</script>
</body>
</html>