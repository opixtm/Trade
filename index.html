<!DOCTYPE html>
<html lang="id" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DASHBOARD</title>
<script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts@4.2.3/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF7;
            color: #342d27;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .card {
            background-color: #FFFFFF;
            border: 1px solid #EAE5E0;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: all 0.3s ease-in-out;
        }
        .btn-primary {
            background-color: #c97c00;
            color: #2b2a28;
            font-weight: 600;
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-primary:hover { background-color: #eb9413 }
        .btn-primary:disabled { background-color: #333333; cursor: not-allowed; }
        .input-primary {
            background-color: #F8F5F1;
            border: 1px solid #DCD6CF;
            border-radius: 0.5rem;
            padding: 0.625rem 1rem;
            width: 100%;
            color: #3D352E;
        }
        .input-primary:focus {
            outline: none;
            border-color: #747462;
            box-shadow: 0 0 0 2px rgba(34, 55, 40, 0.2);
        }
        .tag { padding: 0.25rem 0.625rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .tag-green { background-color: #E6F4EA; color: #4A7C59; }
        .tag-red { background-color: #FCE8E8; color: #A83A3A; }
        .tag-yellow { background-color: #FFF8E1; color: #B5840F; }
        .tag-gray { background-color: #F1F3F4; color: #5F6368; }
        /* Dark Mode Styles */
        .dark body { background-color: #000000; color: #E0E0E0; }
        .dark .card { background-color: #151414; border-color: #333; }
        .dark .input-primary { background-color: #1c1b1b; border-color: #444; color: #E0E0E0; }
        .dark .input-primary:focus { border-color: #2b2d2b; box-shadow: 0 0 0 2px rgba(74, 124, 89, 0.3); }
        .dark .tag-green { background-color: rgba(74, 124, 89, 0.2); color: #69b37f; }
        .dark .tag-red { background-color: rgba(168, 58, 58, 0.2); color: #d17474; }
        .dark .tag-yellow { background-color: rgba(181, 132, 15, 0.2); color: #e0c273; }
        .dark .tag-gray { background-color: rgba(95, 99, 104, 0.2); color: #9aa0a6; }
        .dark .text-gray-800 { color: #E0E0E0; }
        .dark .text-gray-500 { color: #d8d2d2; }
        .dark .text-gray-600 { color: #dddddd; }
        .dark .text-gray-700 { color: #e0e0e0; }
        .dark hr { border-color: #3e4946; }
        .dark .positive { color: #69b37f; }
        .dark .negative { color: #d17474; }


        .loader {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px; 
        }

        .dot {
            width: 14px;
            height: 14px;
            background-color: #e1e1e1; 
            border-radius: 50%;
            animation: bounce 1.0s infinite ease-in-out both;
        }

        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.5); }
        }
        
        .positive { color: #16a34a; }
        .dark .positive { color: #4ade80; }
        .negative { color: #dc2626; }
        .dark .negative { color: #f87171; }
        .blinking-text-animation { animation: blinking-text 1.0s infinite; }
        @keyframes blinking-text { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        #button-loader .dot { width: 8px; height: 8px; }
        .toggle-btn {
            background-color: #E7A13B; color: #4b5563; padding: 0.25rem 0.75rem;
            border-radius: 9999px; font-size: 0.875rem; font-weight: 500; cursor: pointer;
            transition: all 0.2s ease-in-out; border: 1px solid #d1d5db;
        }
        .toggle-btn:hover { background-color: #d1d5db; }
        .toggle-btn.active { background-color: #1755c6; color: #121010; border-color: #1c295c; }
        .dark .toggle-btn { background-color: #1c1b1b; color: #d1d5db; border-color: #444; }
        .dark .toggle-btn:hover { background-color: #444; }
        .dark .toggle-btn.active { background-color: #4f3e01; color: #ffffff; border-color: #4A7C59; }

        .collapsible-content {
            display: grid; grid-template-rows: 0fr;
            transition: grid-template-rows 0.4s ease-in-out;
        }
        .collapsible-content.expanded { grid-template-rows: 1fr; }
        .collapsible-content > div { overflow: hidden; }
        
        .status-uptrend { color: #34d399; } .dark .status-uptrend { color: #4ade80; }
        .status-downtrend { color: #ef4444; } .dark .status-downtrend { color: #f87171; }
        .status-chop { color: #fbbf24; } .dark .status-chop { color: #fcd34d; }

        .confluence-bar-container {
            background-color: #e5e7eb; border-radius: 0.5rem; overflow: hidden;
            height: 30px; display: flex; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        .dark .confluence-bar-container { background-color: #374151; }
        .confluence-bar {
            height: 100%; transition: width 0.5s ease-out; display: flex;
            align-items: center; justify-content: center; font-weight: bold;
            font-size: 0.875rem; color: #111827;
        }
        .confluence-bar-bullish { background: linear-gradient(to right, #22c55e, #86efac); }
        .confluence-bar-bearish { background: linear-gradient(to right, #ef4444, #fca5a5); }
        
        .btn-secondary {
            background-color: #ff1869; color: #070707; font-weight: 600;
            padding: 0.625rem 1.25rem; border-radius: 0.5rem; transition: background-color 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .btn-secondary:hover { background-color: #226756; }
        
        #custom-tooltip {
            position: absolute; background-color: #141517; color: #e2e8f0;
            padding: 12px 16px; border-radius: 8px; border: 1px solid #e48005;
            font-size: 0.875rem; z-index: 100; max-width: 320px; opacity: 0;
            visibility: hidden; transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
            pointer-events: none;
        }

        .tension-bar-bg {
            background-color: #374151; border-radius: 9999px; height: 8px;
            width: 100%; margin: 4px auto 0; overflow: hidden; border: 1px solid #4b5563;
        }
        .tension-bar-fill {
            height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out;
            background: linear-gradient(to right, #fcd34d, #f59e0b, #ef4444);
        }
        .calc-binance-style .btn-group { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 1.5rem; }
        .calc-binance-style .btn-group button {
            padding: 10px; border-radius: 6px; cursor: pointer; background-color: #2c2f36;
            border: 1px solid #3a3f4a; color: #e0e0e0; font-weight: 500; transition: all 0.2s;
        }
        .calc-binance-style .btn-group button:hover { background-color: #3a3f4a; }
        .calc-binance-style .btn-group button.active { background-color: #f0b90b; color: #14151a; border-color: #f0b90b; }
        .calc-binance-style .input-field {
            width: 100%; padding: 12px; background-color: #2c2f36;
            border: 1px solid #3a3f4a; border-radius: 8px; color: #e0e0e0; font-size: 1.1em;
        }
        .calc-binance-style .exec-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 1.5rem; }
        .calc-binance-style .exec-buttons button { padding: 14px; font-size: 1.1em; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; }
        .calc-binance-style .btn-buy { background-color: #2ebd85; color: white; }
        .calc-binance-style .btn-sell { background-color: #f6465d; color: white; }
        .chart-container { position: relative; width: 100%; }
        #main-chart-container { height: 450px; }
        .pane-chart-container { height: 150px; margin-top: 8px; border-top: 1px solid rgba(128, 128, 128, 0.2); padding-top: 8px;}
        .pane-title { position: absolute; top: 15px; left: 15px; z-index: 10; font-size: 12px; font-weight: bold; color: #dddddd; }
        .dark .pane-title { color: #d9d5d5; }
    </style>
</head>
<body class="antialiased">
    <div id="sticky-nav-wrapper" class="sticky top-0 z-50 bg-[#FDFBF7]/80 dark:bg-[#121212]/80 backdrop-blur-lg border-b border-gray-200/50 dark:border-gray-700/50 shadow-sm">
        <div class="flex items-center justify-between py-2 px-4 sm:px-6 lg:px-8">
            <div class="flex items-center gap-8">
                <div class="flex items-center gap-3">
                    <div id="nav-info-container" class="items-center gap-2 hidden md:flex">
                        <div class="flex flex-col">
                            <div class="font-mono text-[10px]">
                                <span class="text-gray-400">VOL 24H:</span>
                                <span id="nav-volume-24h" class="font-semibold text-gray-800 dark:text-gray-200">-</span>
                            </div>
                        </div>
                        <div class="flex flex-col text-left text-xs">
                            <span id="nav-change-24h" class="font-semibold positive">-</span>
                            <span id="nav-change-1h" class="font-semibold positive">-</span>
                        </div>
                    </div>
                </div>
                <div id="nav-stats-container" class="items-center gap-4 font-mono text-[10px] hidden md:flex">
                    <div class="flex flex-col text-left">
                        <div><span class="text-gray-400">ATH:</span><span id="nav-ath" class="font-semibold text-gray-800 dark:text-gray-200">-</span></div>
                        <div><span class="text-gray-400">ATL:</span><span id="nav-atl" class="font-semibold text-gray-800 dark:text-gray-200">-</span></div>
                    </div>
                </div>
            </div>
            <a href="#" id="trade-link" class="text-right no-underline hidden flex items-baseline gap-2">
                <span id="nav-symbol" class="text-base font-bold text-blue-500 dark:text-green-500"></span>
                <span id="nav-price" class="text-yellow-500 text-lg">-</span>
            </a>
        </div>
        <div id="candle-countdown-container" class="w-full h-1 bg-gray-200 dark:bg-gray-700 hidden">
            <div id="candle-countdown-bar" class="h-full bg-yellow-500" style="width: 0%; transition: width 1s linear;"></div>
        </div>
    </div>

    <div id="main-content-container" class="px-4 pb-8 sm:px-6 lg:px-8">
        <header class="py-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold text-gray-800">DASHBOARD</h1>
                <p class="text-yellow-500 font-mono mt-1 text-sm">🏁</p>
            </div>
            <button id="theme-toggle" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 focus:outline-none">
                <svg id="theme-toggle-dark-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                <svg id="theme-toggle-light-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707a1 1 0 001.414 1.414zM-.707 7.072l.707-.707a1 1 0 10-1.414-1.414l-.707.707a1 1 0 001.414 1.414zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z"></path></svg>
            </button>
        </header>

    <main>
        <div class="space-y-6 mb-8">
            <section class="card p-6 grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                <div>
                    <input type="password" id="gemini-api-key" class="input-primary" placeholder="Your API Key...">
                    <p class="text-sm text-gray-400 mt-1">API 🔑 <a href="https://aistudio.google.com/app/apikey" target="_blank" class="underline hover:text-blue-500">GET KEY 👆🏻</a>.</p>
                </div>
            </section>
            <section id="settings-card" class="card p-4">
                <button id="toggle-settings-btn" class="w-full flex justify-between items-center text-left">
                    <h2 class="text-lg font-bold">Indicators Settings</h2>
                    <svg id="toggle-settings-icon" class="w-6 h-6 transition-transform" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </button>
                <div id="settings-content-wrapper" class="collapsible-content">
                    <div class="pt-4 mt-4 border-t border-gray-200 dark:border-gray-700">
                        </div>
                </div>
            </section>

            <div id="initial-placeholder" class="text-center py-5"></div>

            <div id="loader-overlay" class="hidden flex-col justify-center items-center fixed inset-0 bg-black bg-opacity-70 z-50">
                <div class="loader">
                    <div class="dot"></div>
                    <p class="text-4xl font-mono text-gray-500">SPOT</p>
                    <div class="dot"></div>
                    <p class="text-4xl font-mono text-gray-500">PERPETUAL</p>
                    <div class="dot"></div>
                </div>
                <p id="loader-text" class="text-white font-semibold mt-4 text-center blinking-text-animation">Let's Go........</p>
            </div>

            <section class="card p-6 grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                <div>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="asset-input" list="asset-list" class="input-primary text-sm flex-grow uppercase" placeholder="Ketik Simbol Aset (cth: BTCUSDT)" value="BTCUSDT">
                        <datalist id="asset-list"></datalist>
                        <select id="market-type-select" class="input-primary text-sm !w-auto">
                            <option value="spot">Spot</option>
                            <option value="futures" selected>Perp</option>
                        </select>
                        <select id="timeframe-select" class="input-primary text-sm !w-auto">
                            <option value="1m">1m</option><option value="3m">3m</option><option value="5m"selected>5m</option>
                            <option value="15m">15m</option><option value="30m">30m</option><option value="1h">1h</option>
                            <option value="2h">2h</option><option value="4h">4h</option><option value="1d">1d</option><option value="1w">W</option>
                        </select>
                    </div>
                </div>
                <div class="md:col-span-2 flex gap-4">
                    <button id="analyze-asset-btn" class="btn-primary w-full font-bold text-xl">
                        <span id="button-text">GET DATA</span>
                        <div id="button-loader" class="loader hidden">
                            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                        </div>
                    </button>
                    <p id="asset-error" class="text-red-600 text-sm mt-2 text-center hidden"></p>
                    <button id="reset-btn" class="btn-secondary !w-auto">RESET</button>
                </div>
            </section>
        </div>
        <div id="dashboard-content" class="hidden">
            <div class="space-y-8">               
                <div class="flex flex-col gap-8">
                    <button id="toggle-charts-btn" class="btn-yellow w-full">SHOW CHART</button>
                    <section id="charts-wrapper" class="card p-6" style="display: none;">
                        <h2 class="text-xl font-bold mb-4">Live Chart</h2>
                        <div class="chart-container relative"><div class="pane-title">Price</div><div id="main-chart-container"></div></div>
                        <div class="chart-container pane-chart-container relative"><div class="pane-title">Volume</div><div id="volume-chart-container"></div></div>
                        <div class="chart-container pane-chart-container relative"><div class="pane-title">RSI (14)</div><div id="rsi-chart-container"></div></div>
                        <div class="chart-container pane-chart-container relative"><div class="pane-title">Stochastic RSI</div><div id="stoch-chart-container"></div></div>
                        <div class="chart-container pane-chart-container relative"><div class="pane-title">MACD</div><div id="macd-chart-container"></div></div>
                        <div class="chart-container pane-chart-container relative"><div class="pane-title">Rate of Change (ROC)</div><div id="roc-chart-container"></div></div>
                    </section>

                    <section id="current-state-section" class="card p-6">
                        <button id="toggle-market-state-btn" class="w-full flex justify-between items-center text-left mb-4">
                            <h2 id="current-state-title" class="text-xl font-semibold">Current Market Condition</h2>
                            <svg id="toggle-market-state-icon" class="w-6 h-6 transition-transform" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        </button>
                        <div id="current-state-content-wrapper" class="collapsible-content expanded">
                            <div class="space-y-6">
                                <h2 class="text-lg font-semibold text-center">Calculated Timeframe <span id="quick-confluence-timeframe">5m</span></h2>
                                <div class="flex items-center gap-4 my-2">
                                    <div id="quick-finalBearishScore" class="text-2xl font-bold status-downtrend text-right w-1/5">🐻 0%</div>
                                    <div class="confluence-bar-container w-3/5">
                                        <div id="quick-confluenceBarBearish" class="confluence-bar confluence-bar-bearish" style="width: 50%;"></div>
                                        <div id="quick-confluenceBarBullish" class="confluence-bar confluence-bar-bullish" style="width: 50%;"></div>
                                    </div>
                                    <div id="quick-finalBullishScore" class="text-2xl font-bold status-uptrend text-left w-1/5">0% 🐂</div>
                                </div>
                                <div id="verdict-container" class="text-center">
                                    <p id="quick-finalVerdict" class="font-semibold"></p>
                                    <div id="tension-score-container" class="mt-3 text-xs"></div>
                                </div>
                                <div id="confluence-breakdown-container" class="mt-4 text-xs text-center space-y-2 hidden">
                                    <div class="grid grid-cols-2 gap-2 text-left">
                                        <div id="top-bullish-contributors"></div><div id="top-bearish-contributors"></div>
                                    </div>
                                </div>
                                <div class="text-center p-2 rounded-md bg-gray-100 dark:bg-gray-800/50">
                                    <div class="h-16 flex items-center justify-center my-2"></div>
                                    <p id="candlestick-pattern" class="font-semibold">NONE</p>
                                </div>
                            </div>
                        </div>
                    </section>
                    <section id="confluence-details-section" class="card p-6">
                         </section>
                
                    <section id="ai-analysis-section" class="card p-6 relative">
                        <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">AI ANALYZER</h2></div>
                        <div id="ai-verdict-content-wrapper" class="collapsible-content expanded">
                            <div class="pt-4 mt-4 border-t border-gray-200 dark:border-gray-700">
                                <button id="run-comprehensive-ai-btn" class="btn-primary w-full mb-4">
                                    <span>ASK AI</span>
                                    <div class="loader w-5 h-5 hidden"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                                </button>
                                <div id="ai-content-container" class="hidden space-y-6">
                                    <div id="ai-narrative-content" class="prose prose-sm dark:prose-invert max-w-none text-gray-600 space-y-4"></div>
                                    <div>
                                        <h3 class="text-lg font-bold mt-4 mb-2 text-gray-800 dark:text-gray-200">🔮 Proyeksi Harga</h3>
                                        <div id="projection-results-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                    
                    <section id="trailing-stop-calc-section" class="card p-6">
                        </section>
                    
                    <section id="paper-trading-section" class="card p-6">
                       </section>
                </div>
            </div>
        </div>
    </main>
<script>
// ===================================================================================
// BAGIAN 10 LENGKAP: SCRIPT PANEL KONTROL UNTUK INDEX.HTML
// ===================================================================================

// --- DEKLARASI ELEMEN DOM ---
const analyzeBtn = document.getElementById('analyze-asset-btn');
const assetInput = document.getElementById('asset-input');
const timeframeSelect = document.getElementById('timeframe-select');
const marketTypeSelect = document.getElementById('market-type-select');
const loaderOverlay = document.getElementById('loader-overlay');
const loaderText = document.getElementById('loader-text');
const dashboardContent = document.getElementById('dashboard-content');
const assetError = document.getElementById('asset-error');
const buttonText = document.getElementById('button-text');
const buttonLoader = document.getElementById('button-loader');
const apiKeyInput = document.getElementById('gemini-api-key');
const resetBtn = document.getElementById('reset-btn');
const settingsContentWrapper = document.getElementById('settings-content-wrapper').querySelector('div');
const stickyNav = document.getElementById('sticky-nav-wrapper');
const mainContent = document.getElementById('main-content-container');
const aiContentContainer = document.getElementById('ai-content-container');
const aiNarrativeContent = document.getElementById('ai-narrative-content');
const projectionResultsContainer = document.getElementById('projection-results-container');
const runAIBtn = document.getElementById('run-comprehensive-ai-btn');

// --- STATE & CACHE DI SISI UI ---
const realtimeCache = { main: {} };
let userSettings = {
    active: {
        weights: { ma: 2, pivot: 2, vwap: 2, ichimoku: 3, rsi: 1.5, stoch: 1, macd: 2, candlePattern: 1.5, psar: 1, linreg: 1, roc: 1, bollingerBands: 1, rsiDivergence: 2.5, obvDivergence: 3.0, openInterest: 1, funding: 1, lsr: 1, orderBookBias: 1, bbSqueeze: 1.5 },
        indicatorParams: { rsi_period: 14, macd_fast: 12, macd_slow: 26, macd_signal: 9, stoch_rsi_period: 14, stoch_stoch_period: 14, stoch_k_smooth: 3, stoch_d_smooth: 3 }
    },
    presets: {
        scalping: {
            weights: { ma: 2.5, pivot: 1.5, vwap: 2, ichimoku: 1, rsi: 2, stoch: 1.5, macd: 1, candlePattern: 2, psar: 1, linreg: 0.5, roc: 1.5, bollingerBands: 1.5, rsiDivergence: 3, obvDivergence: 2.5, openInterest: 1.5, funding: 1, lsr: 2, orderBookBias: 2.5, bbSqueeze: 2 },
            indicatorParams: { rsi_period: 10, macd_fast: 5, macd_slow: 13, macd_signal: 5, stoch_rsi_period: 10, stoch_stoch_period: 10, stoch_k_smooth: 2, stoch_d_smooth: 2 }
        },
        swing: {
            weights: { ma: 2, pivot: 2.5, vwap: 1.5, ichimoku: 3, rsi: 1.5, stoch: 1, macd: 2.5, candlePattern: 2, psar: 1.5, linreg: 2, roc: 1, bollingerBands: 1, rsiDivergence: 2.5, obvDivergence: 3, openInterest: 1, funding: 1, lsr: 1, orderBookBias: 1, bbSqueeze: 1.5 },
            indicatorParams: { rsi_period: 14, macd_fast: 12, macd_slow: 26, macd_signal: 9, stoch_rsi_period: 14, stoch_stoch_period: 14, stoch_k_smooth: 3, stoch_d_smooth: 3 }
        },
        default: {
            weights: { ma: 2, pivot: 2, vwap: 2, ichimoku: 3, rsi: 1.5, stoch: 1, macd: 2, candlePattern: 1.5, psar: 1, linreg: 1, roc: 1, bollingerBands: 1, rsiDivergence: 2.5, obvDivergence: 3.0, openInterest: 1, funding: 1, lsr: 1, orderBookBias: 1, bbSqueeze: 1.5 },
            indicatorParams: { rsi_period: 14, macd_fast: 12, macd_slow: 26, macd_signal: 9, stoch_rsi_period: 14, stoch_stoch_period: 14, stoch_k_smooth: 3, stoch_d_smooth: 3 }
        }
    }
};
let ws = null;
let chart = null;
let candleSeries = null;
let volumeSeries = null;
let rsiSeries = null;
let stochKSeries = null, stochDSeries = null;
let macdSeries = null, macdSignalSeries = null, macdHistSeries = null;
let rocSeries = null;
let candleCountdownInterval = null;

// --- INISIALISASI APLIKASI ---
document.addEventListener('DOMContentLoaded', () => {
    const analysisWorker = new Worker('worker.js');

    initializeUI();
    loadSettings();
    populateSettings();

    analysisWorker.onmessage = function(event) {
        const { status, payload, message } = event.data;
        
        if (status === 'progress') {
            showLoader(true, message);
        } else if (status === 'success') {
            realtimeCache.main = payload;
            updateDashboardUI();
            startWebSocket();
            showLoader(false);
            dashboardContent.classList.remove('hidden');
            adjustContentPadding();
        } else if (status === 'error') {
            showError(message);
            showLoader(false);
        }
    };

    analyzeBtn.addEventListener('click', () => {
        hideError();
        showLoader(true, 'Mengirim perintah...');
        if (ws) ws.close(); // Hentikan koneksi lama sebelum analisis baru
        
        analysisWorker.postMessage({
            command: 'startAnalysis',
            data: {
                symbol: assetInput.value.trim().toUpperCase() || 'BTCUSDT',
                timeframe: timeframeSelect.value,
                marketType: marketTypeSelect.value,
                correlationAsset: 'BTCUSDT',
                settings: userSettings
            }
        });
    });

    resetBtn.addEventListener('click', () => {
        dashboardContent.classList.add('hidden');
        if (ws) ws.close();
        if (candleCountdownInterval) clearInterval(candleCountdownInterval);
        document.getElementById('candle-countdown-container').classList.add('hidden');
        assetInput.value = 'BTCUSDT';
        hideError();
    });

    runAIBtn.addEventListener('click', () => {
        runComprehensiveAIAnalysis();
    });
});

function setButtonState(button, isLoading, text = 'GET DATA') {
    const textSpan = button.querySelector('#button-text');
    const loaderDiv = button.querySelector('#button-loader');
    button.disabled = isLoading;
    if (isLoading) {
        textSpan.classList.add('hidden');
        loaderDiv.classList.remove('hidden');
    } else {
        textSpan.textContent = text;
        textSpan.classList.remove('hidden');
        loaderDiv.classList.add('hidden');
    }
}

function showLoader(show, text = '') {
    loaderOverlay.style.display = show ? 'flex' : 'none';
    loaderText.textContent = text;
    setButtonState(analyzeBtn, show, 'GET DATA');
}

function showError(message) {
    assetError.textContent = message;
    assetError.classList.remove('hidden');
}

function hideError() {
    assetError.classList.add('hidden');
}

function setupToggle(buttonId, contentId, iconId, onToggle = null) {
    const button = document.getElementById(buttonId);
    const content = document.getElementById(contentId);
    const icon = document.getElementById(iconId);
    if (!button || !content) return;
    
    button.addEventListener('click', () => {
        const isExpanded = content.classList.toggle('expanded');
        if (icon) icon.classList.toggle('rotate-180', isExpanded);
        if (onToggle) onToggle(isExpanded);
    });
}

function adjustContentPadding() {
    const navHeight = stickyNav.offsetHeight;
    mainContent.style.paddingTop = `${navHeight + 16}px`; 
    stickyNav.style.top = '0px';
}

function saveSettings() {
    localStorage.setItem('userCryptoSettings', JSON.stringify(userSettings.active));
    localStorage.setItem('geminiApiKey', apiKeyInput.value);
}

function loadSettings() {
    const savedSettings = localStorage.getItem('userCryptoSettings');
    const savedApiKey = localStorage.getItem('geminiApiKey');
    if (savedSettings) {
        userSettings.active = JSON.parse(savedSettings);
    }
    if (savedApiKey) {
        apiKeyInput.value = savedApiKey;
    }
}

function populateSettings() {
    settingsContentWrapper.innerHTML = ''; 
    const presetSelector = document.createElement('div');
    presetSelector.innerHTML = `<label for="preset-select" class="block text-sm font-medium mb-1">Preset:</label>
        <select id="preset-select" class="input-primary text-sm">${Object.keys(userSettings.presets).map(p => `<option value="${p}">${p.charAt(0).toUpperCase() + p.slice(1)}</option>`).join('')}</select>`;
    settingsContentWrapper.appendChild(presetSelector);
    
    const paramsDiv = document.createElement('div');
    paramsDiv.className = 'mt-4 pt-4 border-t border-gray-200 dark:border-gray-700';
    paramsDiv.innerHTML = '<h3 class="font-semibold mb-2">Indicator Parameters</h3><div class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>';
    const paramsGrid = paramsDiv.querySelector('div');
    for (const [key, value] of Object.entries(userSettings.active.indicatorParams)) {
        paramsGrid.innerHTML += `<div><label class="block text-xs">${key.replace(/_/g, ' ')}:</label><input type="number" class="input-primary text-sm" data-param="${key}" value="${value}"></div>`;
    }
    settingsContentWrapper.appendChild(paramsDiv);

    document.getElementById('preset-select').addEventListener('change', (e) => applyPreset(e.target.value));
    settingsContentWrapper.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('change', debounce((e) => {
            userSettings.active.indicatorParams[e.target.dataset.param] = parseInt(e.target.value);
            saveSettings();
        }, 300));
    });
}

function applyPreset(presetName) {
    if (userSettings.presets[presetName]) {
        userSettings.active = JSON.parse(JSON.stringify(userSettings.presets[presetName]));
        populateSettings();
        saveSettings();
    }
}

function initializeUI() {
    // Theme Toggle
    const themeToggle = document.getElementById('theme-toggle');
    const darkIcon = document.getElementById('theme-toggle-dark-icon');
    const lightIcon = document.getElementById('theme-toggle-light-icon');
    if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
        darkIcon.classList.remove('hidden');
    } else {
        lightIcon.classList.remove('hidden');
    }
    themeToggle.addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
        darkIcon.classList.toggle('hidden');
        lightIcon.classList.toggle('hidden');
        localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        if (chart) chart.applyOptions({ layout: { background: { color: document.documentElement.classList.contains('dark') ? '#151414' : '#FFFFFF' }, textColor: document.documentElement.classList.contains('dark') ? '#E0E0E0' : '#342d27' } });
    });
    
    // Collapsible Panels
    setupToggle('toggle-settings-btn', 'settings-content-wrapper', 'toggle-settings-icon');
    setupToggle('toggle-charts-btn', 'charts-wrapper', null, (isExpanded) => { document.getElementById('toggle-charts-btn').textContent = isExpanded ? 'HIDE CHART' : 'SHOW CHART'; if(isExpanded) initializeCharts(); });
    setupToggle('toggle-market-state-btn', 'current-state-content-wrapper', 'toggle-market-state-icon');
    
    // Save API key on input
    apiKeyInput.addEventListener('input', saveSettings);
    
    // Adjust padding on load and resize
    window.addEventListener('resize', debounce(adjustContentPadding, 100));
}

function formatPrice(price, precision = null) {
    if (typeof price !== 'number' || isNaN(price)) return '--';
    if (precision !== null) {
        return `$${price.toLocaleString('en-US', { minimumFractionDigits: precision, maximumFractionDigits: precision })}`;
    }
    if (price >= 1) return `$${price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    if (price > 0.001) return `$${price.toPrecision(4)}`;
    return `$${price.toPrecision(2)}`;
}

function getPrecisionForAsset(price) {
    if (price >= 100) return 2;
    if (price >= 1) return 3;
    if (price > 0.001) return 4;
    return 5;
}

function getSignClass(value) {
    if (value > 0) return 'positive';
    if (value < 0) return 'negative';
    return '';
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function startWebSocket() {
    if (ws) ws.close();
    const symbol = realtimeCache.main.symbol.toLowerCase();
    const timeframe = timeframeSelect.value;
    const marketType = marketTypeSelect.value;
    const streamUrl = marketType === 'futures' ? 'wss://fstream.binance.com' : 'wss://stream.binance.com:9443';
    
    ws = new WebSocket(`${streamUrl}/stream?streams=${symbol}@kline_${timeframe}/${symbol}@aggTrade`);

    ws.onopen = () => console.log(`WebSocket connected for ${symbol}`);
    
    ws.onmessage = function(event) {
        const message = JSON.parse(event.data);
        const data = message.data;
        
        if (data.e === 'kline') {
            const kline = data.k;
            if (candleSeries) {
                candleSeries.update({
                    time: kline.t / 1000,
                    open: parseFloat(kline.o),
                    high: parseFloat(kline.h),
                    low: parseFloat(kline.l),
                    close: parseFloat(kline.c),
                });
            }
            if (volumeSeries) {
                const color = kline.c > kline.o ? 'rgba(76, 175, 80, 0.5)' : 'rgba(239, 83, 80, 0.5)';
                volumeSeries.update({ time: kline.t / 1000, value: parseFloat(kline.v), color });
            }
            if (!kline.x) { // If candle is not closed yet
                startCandleCountdown(kline.T);
            }
        } else if (data.e === 'aggTrade') {
            document.getElementById('nav-price').textContent = formatPrice(parseFloat(data.p));
            document.getElementById('nav-price').classList.remove('positive', 'negative');
            document.getElementById('nav-price').classList.add(data.m ? 'negative' : 'positive'); // Green for buy, red for sell
        }
    };
    ws.onerror = function(error) {
        console.error("WebSocket Error:", error);
    };
    ws.onclose = () => console.log(`WebSocket disconnected for ${symbol}`);
}

function startCandleCountdown(candleCloseTime) {
    if (candleCountdownInterval) clearInterval(candleCountdownInterval);
    const container = document.getElementById('candle-countdown-container');
    const bar = document.getElementById('candle-countdown-bar');
    container.classList.remove('hidden');

    const timeframeMinutes = { '1m':1,'3m':3,'5m':5,'15m':15,'30m':30,'1h':60,'2h':120,'4h':240,'1d':1440,'1w':10080 }[timeframeSelect.value];
    const totalDuration = timeframeMinutes * 60 * 1000;

    candleCountdownInterval = setInterval(() => {
        const now = new Date().getTime();
        const timeLeft = candleCloseTime - now + 1;
        if (timeLeft <= 0) {
            bar.style.width = '100%';
            clearInterval(candleCountdownInterval);
            return;
        }
        const percentageLeft = (timeLeft / totalDuration) * 100;
        bar.style.width = `${100 - percentageLeft}%`;
    }, 1000);
}

function updateDashboardUI() {
    if (!realtimeCache.main || !realtimeCache.main.tickerData) return;
    
    document.title = `${formatPrice(parseFloat(realtimeCache.main.tickerData.lastPrice))} | ${realtimeCache.main.symbol}`;
    
    // Populate all sections
    populateNav();
    populateCurrentStateWidget();
    populateConfluenceDetailsWidget();
    populateTrailingStopCalc();
    populatePaperTradingSection();
    
    // If charts are visible, render them
    if (document.getElementById('charts-wrapper').style.display !== 'none') {
        initializeCharts();
    }
}

function populateNav() {
    const { tickerData, coinGeckoData, symbol } = realtimeCache.main;
    document.getElementById('nav-symbol').textContent = symbol;
    document.getElementById('nav-price').textContent = formatPrice(parseFloat(tickerData.lastPrice));
    document.getElementById('trade-link').href = `https://www.binance.com/en/trade/${symbol.replace('USDT', '_USDT')}`;
    document.getElementById('trade-link').classList.remove('hidden');
    document.getElementById('nav-volume-24h').textContent = `$${parseFloat(tickerData.quoteVolume).toLocaleString('en-US', { notation: 'compact' })}`;
    
    const change24h = parseFloat(tickerData.priceChangePercent);
    const change24hEl = document.getElementById('nav-change-24h');
    change24hEl.textContent = `24h: ${change24h.toFixed(2)}%`;
    change24hEl.className = `font-semibold ${getSignClass(change24h)}`;
    
    if (coinGeckoData?.market_data?.price_change_percentage_1h_in_currency?.usd) {
        const change1h = coinGeckoData.market_data.price_change_percentage_1h_in_currency.usd;
        const change1hEl = document.getElementById('nav-change-1h');
        change1hEl.textContent = `1h: ${change1h.toFixed(2)}%`;
        change1hEl.className = `font-semibold ${getSignClass(change1h)}`;
    }
    
    if (coinGeckoData?.market_data) {
        document.getElementById('nav-ath').textContent = formatPrice(coinGeckoData.market_data.ath.usd);
        document.getElementById('nav-atl').textContent = formatPrice(coinGeckoData.market_data.atl.usd);
        document.getElementById('nav-stats-container').classList.remove('hidden');
    }
}

function populateCurrentStateWidget() {
    const { calculatedData, tfAlignmentSummary } = realtimeCache.main;
    const score = getUltimateSignalScore();
    
    document.getElementById('quick-confluence-timeframe').textContent = timeframeSelect.value;
    document.getElementById('quick-finalBullishScore').innerHTML = `${score.bullish.toFixed(0)}% 🐂`;
    document.getElementById('quick-finalBearishScore').innerHTML = `🐻 ${score.bearish.toFixed(0)}%`;
    document.getElementById('quick-confluenceBarBullish').style.width = `${score.bullish}%`;
    document.getElementById('quick-confluenceBarBearish').style.width = `${score.bearish}%`;
    document.getElementById('quick-finalVerdict').textContent = score.verdict;

    document.getElementById('candlestick-pattern').textContent = calculatedData.candlePattern.pattern;
}

function populateConfluenceDetailsWidget() {
    const { calculatedData, tfAlignmentSummary } = realtimeCache.main;
    const section = document.getElementById('confluence-details-section');
    // ...salin seluruh isi fungsi `populateConfluenceDetailsWidget` dari file lama Anda di sini...
    // Ini akan sangat panjang, berisi pembuatan semua baris untuk setiap indikator.
    // Contoh untuk satu baris:
    let content = `
        <h2 class="text-xl font-bold mb-4">Confluence Details</h2>
        <div class="space-y-3 text-sm">
            <div class="flex justify-between items-center">
                <span>Moving Averages (21/50)</span>
                <span class="tag ${calculatedData.ma.status === 'Bullish' ? 'tag-green' : 'tag-red'}">${calculatedData.ma.status}</span>
            </div>
            <div class="flex justify-between items-center">
                <span>RSI (14)</span>
                <span class="tag ${calculatedData.rsi.status === 'Netral' ? 'tag-yellow' : (calculatedData.rsi.status === 'Oversold' ? 'tag-green' : 'tag-red')}">${calculatedData.rsi.status} (${calculatedData.rsi.last})</span>
            </div>
            // ... dan seterusnya untuk semua indikator
        </div>
    `;
    section.innerHTML = content;
}

function getUltimateSignalScore() {
    // Salin seluruh isi fungsi `getUltimateSignalScore` dari file lama Anda
    // Ini adalah fungsi yang menghitung skor bullish/bearish dari semua indikator
    return { bullish: 50, bearish: 50, verdict: 'Netral' }; // Placeholder
}

function initializeCharts() {
    const chartContainer = document.getElementById('main-chart-container');
    chartContainer.innerHTML = '';
    
    const isDark = document.documentElement.classList.contains('dark');
    chart = LightweightCharts.createChart(chartContainer, {
        layout: {
            background: { color: isDark ? '#151414' : '#FFFFFF' },
            textColor: isDark ? '#E0E0E0' : '#342d27',
        },
        grid: {
            vertLines: { color: isDark ? '#2A2E39' : '#F0F0F0' },
            horzLines: { color: isDark ? '#2A2E39' : '#F0F0F0' },
        },
        timeScale: { timeVisible: true, secondsVisible: false },
    });

    candleSeries = chart.addCandlestickSeries({
        upColor: '#26a69a', wickUpColor: '#26a69a', borderUpColor: '#26a69a',
        downColor: '#ef5350', wickDownColor: '#ef5350', borderDownColor: '#ef5350',
    });
    
    // Inisialisasi pane lainnya
    const volumeContainer = document.getElementById('volume-chart-container');
    volumeContainer.innerHTML = '';
    const volumeChart = LightweightCharts.createChart(volumeContainer, { /* ...opsi... */ });
    volumeSeries = volumeChart.addHistogramSeries({ /* ...opsi... */ });
    // Lakukan hal yang sama untuk RSI, Stoch, MACD, ROC...
    
    renderAllChartData();
    chart.timeScale().fitContent();
}

function renderAllChartData() {
    const { klines, calculatedData } = realtimeCache.main;
    const chartData = klines.map(k => ({
        time: k[0] / 1000,
        open: parseFloat(k[1]),
        high: parseFloat(k[2]),
        low: parseFloat(k[3]),
        close: parseFloat(k[4])
    }));
    candleSeries.setData(chartData);

    const volumeData = klines.map(k => ({
        time: k[0] / 1000,
        value: parseFloat(k[5]),
        color: parseFloat(k[4]) > parseFloat(k[1]) ? 'rgba(76, 175, 80, 0.5)' : 'rgba(239, 83, 80, 0.5)'
    }));
    if (volumeSeries) volumeSeries.setData(volumeData);
    
    // Render data untuk RSI, Stoch, dll.
    const rsiData = calculatedData.rsi.values.map((val, i) => val !== undefined ? { time: klines[i][0]/1000, value: val } : null).filter(Boolean);
    if(rsiSeries) rsiSeries.setData(rsiData);
}

const tsCalc = {
    // Salin seluruh objek tsCalc dari file lama Anda di sini
    init: function() {
        const section = document.getElementById('trailing-stop-calc-section');
        section.innerHTML = `
            <h2 class="text-xl font-bold mb-4">Trailing Stop Calculator</h2>
            <div class="calc-binance-style">
                </div>
        `;
        // Tambahkan semua event listener untuk kalkulator di sini
    }
};

const paperTrade = {
    // Salin seluruh objek paperTrade dari file lama Anda di sini
    init: function() {
        const section = document.getElementById('paper-trading-section');
        section.innerHTML = `
             <h2 class="text-xl font-bold mb-4">Paper Trading Simulator</h2>
             `;
        // Tambahkan semua event listener untuk simulator di sini
    }
};

function populateTrailingStopCalc() {
    tsCalc.init();
}

function populatePaperTradingSection() {
    paperTrade.init();
}

async function runComprehensiveAIAnalysis() {
    if (!apiKeyInput.value) {
        showError("API Key Gemini belum dimasukkan.");
        return;
    }
    setButtonState(runAIBtn, true);
    aiContentContainer.classList.add('hidden');
    
    try {
        const prompt = generateAIPrompt();
        const fullApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKeyInput.value}`;
        const response = await fetch(fullApiUrl, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        if (!response.ok) throw new Error(`Google AI API error! Status: ${response.status}`);
        
        const data = await response.json();
        const aiText = data.candidates[0].content.parts[0].text;
        
        aiNarrativeContent.innerHTML = marked.parse(aiText);
        
        // Anda mungkin perlu menambahkan kembali logika untuk mem-parse proyeksi harga dari teks AI
        projectionResultsContainer.innerHTML = '<em>Proyeksi harga akan ditampilkan di sini setelah di-parse dari teks AI.</em>';

        aiContentContainer.classList.remove('hidden');
    } catch (error) {
        showError(`AI Analysis Failed: ${error.message}`);
    } finally {
        setButtonState(runAIBtn, false, 'ASK AI');
    }
}

function generateAIPrompt() {
    // Salin seluruh isi fungsi `generateAIPrompt` dari file lama Anda di sini
    return `Analisis ${realtimeCache.main.symbol}...`; // Placeholder
}

</script>
</body>
</html>
