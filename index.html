<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRICE PROJECTOR</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js" charset="utf-8"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* CSS Kustom untuk menyempurnakan tampilan */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #111827; /* Latar belakang gelap untuk kenyamanan mata */
            color: #d1d5db; /* Warna teks abu-abu terang */
        }
        .tab-button.active { 
            background-color: #3b82f6; /* Warna biru untuk tab aktif */
            color: white; 
        }
        .loader { 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #3498db; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; /* Animasi loading berputar */
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        .kalkulator-input { 
            background-color: #374151; 
            border: 1px solid #4b5563; 
            color: white; 
            border-radius: 0.375rem; 
            padding: 0.5rem 0.75rem; 
            width: 100%; 
        }
        @keyframes pulse-bg { 
            0% { background-color: rgba(59, 130, 246, 0.1); } 
            50% { background-color: rgba(59, 130, 246, 0.35); } 
            100% { background-color: rgba(59, 130, 246, 0.1); } 
        }
        .highlight-pulse { 
            animation: pulse-bg 2s ease-in-out infinite; 
            border-radius: 0.375rem; 
        }
        /* Gaya untuk tombol 'Gunakan Data' di proyeksi */
        .use-projection-btn {
            background-color: #1e40af;
            color: white;
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
            margin-top: 8px;
        }
        .use-projection-btn:hover {
            background-color: #1d4ed8;
        }
        .status-uptrend { color: #34d399; }
        .status-downtrend { color: #f43f5e; }
        .status-chop { color: #fbbf24; }
        .blinking-text-animation { animation: blinking-text 1.8s infinite; }
        @keyframes blinking-text { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        #api-key-input {
            width: 350px; /* Atur lebar yang diinginkan di sini */
        }

        /* Gaya standar untuk tombol aksi 'Gunakan Data' */
        .btn-data-action {
            background-color: #16a34a; /* Warna hijau yang konsisten (Green 600) */
            color: white;
            font-weight: 500; /* medium */
            padding: 0.5rem 0.75rem; /* 8px 12px */
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.2s;
            width: 100%;
            text-align: center;
        }
        .btn-data-action:hover {
            background-color: #15803d; /* Green 700 */
        }
        /* Gaya untuk tombol data di Proyeksi (opsional, jika ingin warna beda) */
        .btn-data-action.projection {
            background-color: #1e40af; /* Biru */
        }
        .btn-data-action.projection:hover {
            background-color: #1d4ed8;
        }

        /* Gaya untuk tombol rentang Chart Historis (dibiarkan karena ini adalah gaya generik) */
        .chart-range-btn.active {
            background-color: #1d4ed8; /* Biru yang lebih gelap untuk tombol rentang aktif */
            font-weight: bold;
        }
    </style>
</head>
<body class="antialiased">

    <div class="min-h-screen flex flex-col">
        <header class="bg-gray-800/50 backdrop-blur-sm shadow-lg p-4 top-0 z-20 h-16 relative flex items-center justify-center">
            <div class="absolute left-4 top-1/2 -translate-y-1/2">
                <a href="https://opixtm.github.io/Trade/about" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white font-regular py-2 px-4 rounded transition-colors duration-300">
                    QUICK
                </a>
            </div>
            <h1 class="text-sm font-bold text-white">üö¨<span class="text-blue-400">AI</span>PRICE PROJECTOR</h1>
            <div class="absolute right-4 top-1/2 -translate-y-1/2">
                <a href="https://opixtm.github.io/Trade/services" target="_blank" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded transition-colors duration-300">
                    USTADZ AI
                </a>
            </div>
        </header>

        <div class="flex-grow flex flex-col md:flex-row p-4 gap-4">
            <main class="w-full bg-gray-800 rounded-lg p-2 sm:p-4 shadow-md flex flex-col relative">
                <div id="loader" class="hidden absolute inset-0 bg-gray-900/80 flex items-center justify-center flex-col gap-2 z-50 rounded-lg">
                    <div class="loader"></div>
                    <p id="loader-text" class="text-white font-regular"></p>
                </div>

                <div>
                    <div class="bg-black-500/20 border border-black-700 rounded-md mb-4">
                        <button id="toggle-apikey-btn" class="w-full flex items-center p-4 py-2">
                            <span id="toggle-apikey-icon" class="transform transition-transform text-xs font-bold text-red-600 blinking-text-animation">üì≤ KLIK UNTUK INPUT API .........üîë</span>
                        </button>
                        <div id="apikey-content" class="px-4 pb-4 transition-all duration-300 ease-in-out overflow-hidden">
                            <input type="password" id="api-key-input" class="kalkulator-input mt-2" placeholder="Tempel API Key Google AI Studio di sini...">
                            <p class="text-xs text-gray-400 mt-1">Kunci akan disimpan secara lokal di browser Anda. <a href="https://aistudio.google.com/app/apikey" target="_blank" class="underline hover:text-yellow-300 font-bold">Dapatkan Kunci di sini (Gratis)</a>.</p>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap border-b border-gray-700">
                        <button class="tab-button flex-grow py-2 px-4 font-bold text-green-300 hover:bg-green-600 transition rounded-t-lg active" data-tab="proyeksi">üèπ PRICE</button>
                    </div>
                </div>

                <div id="tab-content" class="flex-grow mt-4 overflow-y-auto">
                    <div id="proyeksi" class="tab-pane">
                        <h3 class="text-base text-white mb-4"></h3>
                        <div class="bg-gray-900 p-4 rounded-lg mb-6">
                            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                                <input type="text" id="proyeksi-asset-input" list="asset-list" class="kalkulator-input flex-grow" placeholder="Ketik atau pilih aset..">
                                <datalist id="asset-list">
                                    <option value="BTCUSDT">
                                    <option value="ETHUSDT">
                                </datalist>
                                <button id="generate-proyeksi-btn" class="w-full sm:w-auto bg-green-600 blinking-text-animation text-white font-regular py-2 px-6 rounded-lg hover:bg-green-700 transition">START</button>
                                <div id="proyeksi-error-container" class="text-red-400 mt-2"></div>
                            </div>

                            <div id="proyeksi-placeholder" class="text-center text-lg text-blue-500 blinking-text-animation p-8"><p>KLIK OR TAP START</p></div>
                            <div id="proyeksi-loader" class="hidden absolute inset-0 bg-gray-900/80 flex items-center justify-center flex-col gap-2 z-50 rounded-lg">
                                 <div class="loader"></div>
                                 <p id="proyeksi-loader-text" class="text-white font-regular"></p>
                             </div>

                            <div id="proyeksi-details-output" class="hidden">
                                <div class="mt-4 p-3 bg-gray-800 rounded-lg" id="proyeksi-live-price-container">
                                    <p class="text-sm text-gray-400">Harga Saat Analisa:</p>
                                    <p class="text-xl font-regular text-green-400" id="proyeksi-live-price-output">-</p>
                                </div>

                                <div class="mt-4 p-3 bg-gray-800 rounded-lg" id="historical-price-summary">
                                    <h4 class="text-sm text-gray-400 mb-2">Data Harga Historis</h4>
                                    <div class="grid grid-cols-2 gap-y-1 text-sm">
                                        <div><span class="text-gray-500">24j Range:</span> <span id="hist-24h-range" class="text-white">-</span></div>
                                        <div><span class="text-gray-500">7d Range:</span> <span id="hist-7d-range" class="text-white">-</span></div>
                                        <div><span class="text-gray-500">All-Time High:</span> <span id="hist-ath" class="text-white">-</span></div>
                                        <div><span class="text-gray-500">All-Time Low:</span> <span id="hist-atl" class="text-white">-</span></div>
                                    </div>
                                </div>

                                <div class="bg-gray-800 p-4 rounded-lg mt-4">
                                    <button class="w-full flex justify-between items-center text-left py-2 toggle-section-btn" data-target="kondisi-pasar-content">
                                        <h4 class="font-regular text-base text-white">NOW</h4>
                                        <span class="toggle-icon transform transition-transform">üîΩ</span>
                                    </button>
                                    <div id="kondisi-pasar-content" class="overflow-hidden transition-all duration-300" style="max-height: 0;">
                                        <div class="space-y-3 text-sm pt-2 border-t border-gray-700">
                                            <p><span class="text-blue-300 w-32 inline-block">Volatility:</span> <span id="proj-volatilitas">-</span></p>
                                            <p><span class="text-blue-300 w-32 inline-block">Market Sentiment:</span> <span id="proj-sentimen">-</span></p>
                                        </div>
                                        <div class="mt-4 pt-4 border-t border-gray-700 grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-5 text-sm">
                                            <div>
                                                <span class="text-gray-400 block">Volume 24j</span>
                                                <span class="text-white" id="proj-volume-24h"></span>
                                                <span class="text-sm" id="proj-volume-pct"></span>
                                            </div>
                                            <div>
                                                <span class="text-gray-400 block">Open Interest</span>
                                                <span class="text-white" id="proj-open-interest"></span>
                                            </div>
                                            <div>
                                                <span class="text-gray-400 block">Funding Rate</span>
                                                <span class="text-white" id="proj-funding-rate"></span>
                                            </div>
                                            <div>
                                                <span class="text-gray-400 block">L/S Ratio (Umum)</span>
                                                <span class="text-white" id="proj-ls-umum"></span>
                                            </div>
                                            <div>
                                                <span class="text-gray-400 block">L/S Ratio (Top)</span>
                                                <span class="text-white" id="proj-ls-top"></span>
                                            </div>
                                            <div>
                                                <span class="text-gray-400 block">Order Book Bias</span>
                                                <span class="text-white" id="proj-order-book-bias"></span>
                                            </div>
                                            <div>
                                                <span class="text-gray-400 block">Dominan Bid/Ask</span>
                                                <span class="text-white" id="proj-order-book-dominant"></span>
                                            </div>
                                        </div>
                                        <div class="mt-3 pt-3 border-t border-gray-700 text-sm">
                                            <span class="text-indigo-300 block mb-2">Detail Indikator per Timeframe:</span>
                                            <div id="proj-indicator-details"></div>
                                        </div>
                                         <div class="mt-3 pt-3 border-t border-gray-700 text-sm">
                                            <p><span class="text-green-400">Kesimpulan Indikator:</span> <span id="proj-kesimpulan-indikator">-</span></p>
                                        </div>
                                        <div class="mt-3 pt-3 border-t border-gray-700 text-sm">
                                            <span class="text-red-400 block mb-2">Analisa Tambahan (Volume & Fundamental):</span>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2">
                                                <div>
                                                    <span class="text-blue-300 font-regular">VWAP Status:</span>
                                                    <span id="proj-vwap-status">-</span>
                                                </div>
                                                <div>
                                                    <span class="text-blue-300 font-regular">OBV Trend:</span>
                                                    <span id="proj-obv-trend">-</span>
                                                </div>
                                                <div class="md:col-span-2">
                                                    <span class="text-blue-300 font-regular">Kategori Proyek:</span>
                                                    <span id="proj-kategori">-</span>
                                                </div>
                                                <div class="md:col-span-2">
                                                    <span class="text-blue-300 font-regular">Aktivitas Dev:</span>
                                                    <span id="proj-dev-activity">-</span>
                                                </div>
                                                <div class="md:col-span-2">
                                                    <span class="text-blue-300 font-regular">Tokenomics:</span>
                                                    <span id="proj-tokenomics">-</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-gray-800 p-4 rounded-lg mt-4">
                                    <button class="w-full flex justify-between items-center text-left py-2 toggle-section-btn" data-target="smc-content">
                                        <h4 class="font-regular text-base text-white">Market Structure (SMC)</h4>
                                        <span class="toggle-icon transform transition-transform">üîΩ</span>
                                    </button>
                                    <div id="smc-content" class="overflow-hidden transition-all duration-300" style="max-height: 0;">
                                        <div class="space-y-3 text-sm pt-2 border-t border-gray-700">
                                            <div>
                                                <p class="text-yellow-400 font-semibold mb-1">Narasi Struktur Pasar:</p>
                                                <p id="proj-smc-narrative">-</p>
                                            </div>
                                            <div>
                                                <p class="text-green-400 font-semibold mb-1">POI Bullish Potensial:</p>
                                                <p id="proj-smc-poi-bullish">-</p>
                                            </div>
                                            <div>
                                                <p class="text-red-500 font-semibold mb-1">POI Bearish Potensial:</p>
                                                <p id="proj-smc-poi-bearish">-</p>
                                            </div>
                                            <div class="pt-3 mt-3 border-t border-gray-700">
                                            <p><span class="text-blue-400">Kesimpulan SMC:</span> <span id="proj-kesimpulan-smc">-</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-gray-800 p-4 rounded-lg mt-6">
                                    <button class="w-full flex justify-between items-center text-left py-2 toggle-section-btn" data-target="proyeksi-lengkap-content">
                                        <h4 class="font-regular text-lg text-green-400">Projection</h4>
                                        <span class="toggle-icon transform transition-transform">üîΩ</span>
                                    </button>
                                    <div id="proyeksi-lengkap-content" class="overflow-hidden transition-all duration-300" style="max-height: 0;">
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pt-2 border-t border-gray-700" id="proyeksi-lengkap-output">
                                            </div>
                                    </div>
                                </div>

                                <div class="bg-gray-800 p-4 rounded-lg mt-6">
                                    <button class="w-full flex justify-between items-center text-left py-2 toggle-section-btn" data-target="keputusan-akhir-content">
                                        <h4 class="font-regular text-base text-white">Keputusan Akhir (Pemilik & Calon Pembeli Aset)</h4>
                                        <span class="toggle-icon transform transition-transform">üîΩ</span>
                                    </button>
                                    <div id="keputusan-akhir-content" class="overflow-hidden transition-all duration-300" style="max-height: 0;">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-2 border-t border-gray-700">
                                            <div class="bg-black-800 p-4 rounded-lg">
                                                <h4 class="font-regular text-base text-blue-400 mb-2">HOLDER</h4>
                                                <p class="font-regular text-base" id="proj-saran-pemilik"></p>
                                                <p class="text-sm text-gray-400 mt-1" id="proj-alasan-pemilik"></p>
                                            </div>
                                            <div class="bg-black-800 p-4 rounded-lg">
                                                <h4 class="font-regular text-base text-green-400 mb-2">CALON BUYER</h4>
                                                <p class="text-base" id="proj-saran-non-pemilik"></p>
                                                <p class="text-sm text-gray-400 mt-1" id="proj-alasan-non-pemilik"></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="bg-indigo-900/50 border border-indigo-700 p-4 rounded-lg mt-6">
                                        <h4 class="font-bold text-base text-indigo-300 mb-2">üîé Analisa Khusus: BTCUSDT</h4>
                                        <p class="text-sm text-gray-400 mb-3">Ajukan pertanyaan spesifik tentang siklus makro BTC. AI akan menjawab berdasarkan model historis dan data yang tersedia.</p>
                                        
                                        <div class="flex flex-col sm:flex-row gap-2">
                                            <input type="text" id="btc-special-question" class="kalkulator-input flex-grow" placeholder="Contoh: kapan halving selanjutnya?">
                                            <button id="ask-btc-btn" class="w-full sm:w-auto bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 transition">Tanyakan AI</button>
                                        </div>

                                        <div id="btc-special-loader" class="hidden text-center p-4">
                                            <div class="loader mx-auto"></div>
                                            <p class="text-indigo-200 mt-2 text-sm">AI sedang menganalisa pertanyaan Anda...</p>
                                        </div>
                                        <div id="btc-special-output" class="mt-4 bg-gray-900 p-4 rounded-lg hidden whitespace-pre-wrap text-gray-300">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
            </main>
        </div>
    </div>
<main class="w-full bg-gray-800 rounded-lg p-2 sm:p-4 shadow-md flex flex-col relative">
    <div class="bg-gray-900 p-4 rounded-lg mt-6"> <button id="toggle-tradingview-btn" class="w-full flex justify-between items-center text-left py-2">
            <h4 class="font-regular text-base text-white">üìà TradingView Chart</h4>
            <span id="tradingview-toggle-icon" class="transform transition-transform">üîΩ</span>
        </button>
        
        <div id="tradingview-widget-wrapper" class="overflow-hidden transition-all duration-300" style="max-height: 0;">
            <div class="bg-slate-800 p-6 rounded-xl flex flex-col" style="height: 88vh;">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4 flex-shrink-0">
                    <div class="text-right"></div>
                </div>
                <div class="w-full flex-1 bg-slate-900 rounded-lg">
                    <div class="tradingview-widget-container" style="height:100%;width:100%">
                        <div class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%"></div>
                        <div class="tradingview-widget-copyright"><a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank"><span class="blue-text">Track all markets on TradingView</span></a></div>
                        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js" async>
                        {
                        "allow_symbol_change": true,
                        "calendar": false,
                        "details": false,
                        "hide_side_toolbar": true,
                        "hide_top_toolbar": false,
                        "hide_legend": false,
                        "hide_volume": false,
                        "hotlist": false,
                        "interval": "240",
                        "locale": "en",
                        "save_image": true,
                        "style": "1",
                        "symbol": "BINANCE:BTCUSDT",
                        "theme": "dark",
                        "timezone": "Asia/Jakarta",
                        "backgroundColor": "#0F0F0F",
                        "gridColor": "rgba(242, 242, 242, 0.06)",
                        "watchlist": [],
                        "withdateranges": true,
                        "compareSymbols": [],
                        "studies": [
                            "STD;Bollinger_Bands",
                            "STD;Stochastic_RSI",
                            "STD;Divergence%1Indicator",
                            "STD;EMA",
                            "STD;PSAR"   
                        ],
                        "autosize": true
                        }
                        </script>
                    </div>
                    </div>
            </div>
        </div>
    </div>
</main>
        </div>
    </div>
<script>
// Helper function untuk memperbarui field UI (tetap dijaga untuk utilitas umum jika diperlukan di tempat lain)
function updateAnalysisField(setup, field, value) {
    const desktopEl = document.getElementById(`${setup}-${field}`);
    if (desktopEl) {
        desktopEl.innerHTML = value;
    }
    const mobileEl = document.getElementById(`mobile-${setup}-${field}`);
    if (mobileEl) {
        mobileEl.innerHTML = value;
    }
}

// Helper untuk mendapatkan presisi harga untuk tampilan
function getPrecisionForAsset(price) {
    if (price === 0) return 2; // Tangani kasus 0 untuk menghindari masalah
    if (price > 1000) return 2;
    if (price > 1) return 4;
    if (price > 0.001) return 7;
    return 8;
}

// Fungsi loader
const showLoader = (text, targetLoader = loader, targetLoaderText = loaderText) => { 
    targetLoaderText.textContent = text;
    targetLoader.classList.remove('hidden');
};
const hideLoader = (targetLoader = loader) => targetLoader.classList.add('hidden');

// Fungsi untuk menghitung Exponential Moving Average (EMA)
const calculateEMA = (data, period) => {
    if (!data || data.length < period) {
        return [];
    }
    const k = 2 / (period + 1);
    let emaArray = [];
    let currentEma;

    currentEma = data.slice(0, period).reduce((a, b) => a + b, 0) / period;
    emaArray.push(currentEma);

    for (let i = period; i < data.length; i++) {
        currentEma = (data[i] * k) + (currentEma * (1 - k));
        emaArray.push(currentEma);
    }
    return emaArray;
};

// Fungsi untuk menghitung Bollinger Bands
const calculateBollingerBands = (closes, period = 20, stdDevMultiplier = 2) => {
    if (!closes || closes.length < period) return { upper: 0, middle: 0, lower: 0 };
    const middleBand = calculateSMA(closes.slice(closes.length - period), period)[0];
    if (middleBand === undefined) return { upper: 0, middle: 0, lower: 0 };
    const slice = closes.slice(closes.length - period);
    const stdDev = Math.sqrt(slice.map(p => Math.pow(p - middleBand, 2)).reduce((a, b) => a + b, 0) / period);
    return {
        upper: middleBand + (stdDev * stdDevMultiplier),
        middle: middleBand,
        lower: middleBand - (stdDev * stdDevMultiplier)
    };
};

// Fungsi untuk menghitung Average True Range (ATR)
const calculateATR = (klines, period = 14) => {
    if (!klines || klines.length < period) return 0;
    let trueRanges = [];
    for (let i = 1; i < klines.length; i++) {
        const high = parseFloat(klines[i][2]);
        const low = parseFloat(klines[i][3]);
        const prevClose = parseFloat(klines[i-1][4]);
        const tr1 = high - low;
        const tr2 = Math.abs(high - prevClose);
        const tr3 = Math.abs(low - prevClose);
        trueRanges.push(Math.max(tr1, tr2, tr3));
    }       
    let atr = trueRanges.slice(0, period).reduce((a, b) => a + b, 0) / period;       
    for (let i = period; i < trueRanges.length; i++) {
        atr = (atr * (period - 1) + trueRanges[i]) / period;
    }
    return atr;
};

// Fungsi untuk menghitung On-Balance Volume (OBV)
const calculateOBV = (klines) => {
    if (!klines || klines.length < 2) return [];
    let obv = [0]; 
    for (let i = 1; i < klines.length; i++) {
        const close = parseFloat(klines[i][4]);
        const prevClose = parseFloat(klines[i - 1][4]);
        const volume = parseFloat(klines[i][5]);
        if (close > prevClose) {
            obv.push(obv[i - 1] + volume);
        } else if (close < prevClose) {
            obv.push(obv[i - 1] - volume);
        } else {
            obv.push(obv[i - 1]);
        }
    }
    return obv;
};

// Fungsi untuk menghitung Volume Weighted Average Price (VWAP)
const calculateVWAP = (klines, period = 20) => {
    if (!klines || klines.length < period) return 0;
    const recentKlines = klines.slice(-period);
    let totalTypicalPriceVolume = 0;
    let totalVolume = 0;
    recentKlines.forEach(k => {
        const high = parseFloat(k[2]);
        const low = parseFloat(k[3]);
        const close = parseFloat(k[4]);
        const volume = parseFloat(k[5]);
        const typicalPrice = (high + low + close) / 3;
        totalTypicalPriceVolume += typicalPrice * volume;
        totalVolume += volume;
    });
    return totalVolume > 0 ? totalTypicalPriceVolume / totalVolume : 0;
};

// Fungsi untuk menghitung Simple Moving Average (SMA)
const calculateSMA = (data, period) => {
    if (!data || data.length < period) return [];
    const sma = [];
    for (let i = period - 1; i < data.length; i++) {
        const slice = data.slice(i - period + 1, i + 1);
        const sum = slice.reduce((a, b) => a + b, 0);
        sma.push(sum / period);
    }
    return sma;
};

// Fungsi untuk menghitung Relative Strength Index (RSI)
const calculateRSI = (closes, period = 14) => {
    if (!closes || closes.length <= period) return 'N/A';
    
    let gains = [];
    let losses = [];
    for (let i = 1; i < closes.length; i++) {
        const diff = closes[i] - closes[i-1];
        if (diff >= 0) {
            gains.push(diff);
            losses.push(0);
        } else {
            gains.push(0);
            losses.push(Math.abs(diff));
        }
    }       
    
    let avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
    let avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;

    let rsiValues = [];
    let rs = avgLoss === 0 ? (avgGain / 0.00000001) : (avgGain / avgLoss);
    rsiValues.push(100 - (100 / (1 + rs)));

    for (let i = period; i < gains.length; i++) {
        avgGain = ((avgGain * (period - 1)) + gains[i]) / period;
        avgLoss = ((avgLoss * (period - 1)) + losses[i]) / period;
        
        rs = avgLoss === 0 ? (avgGain / 0.00000001) : (avgGain / avgLoss);
        rsiValues.push(100 - (100 / (1 + rs)));
    }
    return rsiValues.pop(); // Mengembalikan nilai RSI terbaru
};

// Fungsi untuk menghitung True Range (TR) - Diperlukan untuk ADX
const calculateTrueRange = (high, low, prevClose) => {
    const tr1 = high - low;
    const tr2 = Math.abs(high - prevClose);
    const tr3 = Math.abs(low - prevClose);
    return Math.max(tr1, tr2, tr3);
};

// Fungsi untuk menghitung Directional Movement (DM) - Diperlukan untuk ADX
const calculateDirectionalMovement = (high, prevHigh, low, prevLow) => {
    const plusDM = high - prevHigh;
    const minusDM = prevLow - low;

    let truePlusDM = 0;
    let trueMinusDM = 0;

    if (plusDM > minusDM && plusDM > 0) {
        truePlusDM = plusDM;
    }
    if (minusDM > plusDM && minusDM > 0) {
        trueMinusDM = minusDM;
    }
    return { truePlusDM, trueMinusDM };
};

// Fungsi utama untuk menghitung ADX
const calculateADX = (klines, period = 14) => {
    // Periksa jika klines tidak ada atau panjangnya kurang dari periode yang dibutuhkan
    if (!klines || klines.length < period + 1) return { adx: 'N/A', plusDI: 'N/A', minusDI: 'N/A' }; // Butuh setidaknya period + 1 klines untuk 1st TR/DM

    let trs = [];
    let plusDMs = [];
    let minusDMs = [];

    // Hitung TR, +DM, -DM untuk setiap bar
    for (let i = 1; i < klines.length; i++) {
        const high = parseFloat(klines[i][2]);
        const low = parseFloat(klines[i][3]);
        const prevHigh = parseFloat(klines[i-1][2]);
        const prevLow = parseFloat(klines[i-1][3]);
        const prevClose = parseFloat(klines[i-1][4]);

        trs.push(calculateTrueRange(high, low, prevClose));
        const { truePlusDM, trueMinusDM } = calculateDirectionalMovement(high, prevHigh, low, prevLow);
        plusDMs.push(truePlusDM);
        minusDMs.push(trueMinusDM);
    }
    
    if (trs.length < period) return { adx: 'N/A', plusDI: 'N/A', minusDI: 'N/A' }; // Butuh 'period' TRs untuk SMA awal

    // Hitung ATR (smoothed True Range)
    // Inisialisasi smoothing dengan SMA pertama
    let atrValues = [];
    atrValues.push(trs.slice(0, period).reduce((a, b) => a + b, 0) / period);
    for (let i = period; i < trs.length; i++) {
        atrValues.push((atrValues[atrValues.length - 1] * (period - 1) + trs[i]) / period);
    }
    // Dapatkan ATR terakhir yang dihitung
    const lastATR = atrValues[atrValues.length - 1]; 

    // Hitung Smoothed +DM dan -DM
    // Inisialisasi smoothing dengan SMA pertama
    let plusDMSmoothed = [];
    plusDMSmoothed.push(plusDMs.slice(0, period).reduce((a, b) => a + b, 0) / period);
    for (let i = period; i < plusDMs.length; i++) {
        plusDMSmoothed.push((plusDMSmoothed[plusDMSmoothed.length - 1] * (period - 1) + plusDMs[i]) / period);
    }

    let minusDMSmoothed = [];
    minusDMSmoothed.push(minusDMs.slice(0, period).reduce((a, b) => a + b, 0) / period);
    for (let i = period; i < minusDMs.length; i++) {
        minusDMSmoothed.push((minusDMSmoothed[minusDMSmoothed.length - 1] * (period - 1) + minusDMs[i]) / period);
    }
    // Dapatkan smoothed +DM dan -DM terakhir
    const lastPlusDMSmoothed = plusDMSmoothed[plusDMSmoothed.length - 1];
    const lastMinusDMSmoothed = minusDMSmoothed[minusDMSmoothed.length - 1];

    // Hitung +DI dan -DI
    let plusDI = (lastATR === 0) ? 0 : (lastPlusDMSmoothed / lastATR) * 100;
    let minusDI = (lastATR === 0) ? 0 : (lastMinusDMSmoothed / lastATR) * 100;

    // Hitung DX
    let dx = 0;
    if ((plusDI + minusDI) === 0) {
        dx = 0;
    } else {
        dx = Math.abs(plusDI - minusDI) / (plusDI + minusDI) * 100;
    }
    
    // Untuk ADX, kita perlu serangkaian nilai DX yang cukup untuk dihaluskan
    let dxValuesForADX = [];
    // Hitung DX untuk setiap titik data yang cukup setelah inisialisasi awal
    for(let i = period; i < atrValues.length; i++) { // Pastikan Anda memiliki cukup nilai ATR, +DM, -DM
        const currentPlusDI = (plusDMSmoothed[i] / atrValues[i]) * 100;
        const currentMinusDI = (minusDMSmoothed[i] / atrValues[i]) * 100;
        if ((currentPlusDI + currentMinusDI) === 0) {
            dxValuesForADX.push(0);
        } else {
            dxValuesForADX.push(Math.abs(currentPlusDI - currentMinusDI) / (currentPlusDI + currentMinusDI) * 100);
        }
    }

    if (dxValuesForADX.length < period) return { adx: 'N/A', plusDI: 'N/A', minusDI: 'N/A' }; 

    // Hitung ADX (smoothed DX)
    let adxValues = [];
    adxValues.push(dxValuesForADX.slice(0, period).reduce((a, b) => a + b, 0) / period);
    for (let i = period; i < dxValuesForADX.length; i++) {
        adxValues.push((adxValues[adxValues.length - 1] * (period - 1) + dxValuesForADX[i]) / period);
    }
    
    const finalADX = adxValues[adxValues.length - 1];

    return { adx: finalADX, plusDI: plusDI, minusDI: minusDI };
};


// Helper untuk membersihkan dan mengurai respons JSON dari AI
function cleanAndParseJson(rawText) {
    let jsonString = rawText;
    const markdownMatch = rawText.match(/```json\s*([\s\S]*?)\s*```/);
        if (markdownMatch && markdownMatch[1]) {
            jsonString = markdownMatch[1];
        } else {
    const braceMatch = rawText.match(/\{[\s\S]*\}/);
        if (braceMatch && braceMatch[0]) {
            jsonString = braceMatch[0];
        } else {
            throw new Error("Tidak ada blok JSON yang dapat dikenali dalam respons AI.");
        }
        }
        try {
        return JSON.parse(jsonString);
        } catch (e) {
            console.error("Kesalahan penguraian JSON. String bermasalah:", jsonString);
            throw new Error(`Gagal menguraikan JSON dari AI. Kesalahan: ${e.message}`);
        }
}

// Fungsi untuk memanggil Gemini API
async function callGemini(parts, isJsonOutput = true) {
        const apiKey = apiKeyInput.value.trim();
        if (!apiKey) throw new Error("API Key belum dimasukkan.");
        const model = 'gemini-2.5-flash';
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
        const payload = { contents: [{ role: "user", parts }] };
        if (isJsonOutput) {
            payload.generationConfig = {
                "response_mime_type": "application/json",
                "max_output_tokens": 8192
            };
        }
        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!response.ok) {
            const errorBody = await response.json();
            const errorMessage = errorBody?.error?.message || `Permintaan API gagal: ${response.status}`;
            if (response.status === 429) throw new Error("Terlalu banyak permintaan (Batas Tingkat). Coba lagi nanti.");
            if (response.status === 503) throw new Error("Layanan AI sedang sibuk (Error 503). Coba lagi.");
            throw new Error(errorMessage);
        }
        const result = await response.json();
        if (result.candidates && result.candidates[0] && result.candidates[0].content.parts[0]) {
            return result.candidates[0].content.parts[0].text.trim();
        } else {
            if (result.promptFeedback && result.promptFeedback.blockReason) {
                throw new Error(`Permintaan diblokir oleh AI: ${result.promptFeedback.blockReason}`);
            }
            throw new Error("Struktur respons dari AI tidak valid atau kosong.");
        }
}
    
// Fungsi untuk mengambil data dari Binance API
async function fetchBinanceAPIData(endpoint, params = {}, apiType = 'futures') {
    const query = new URLSearchParams(params).toString();
    const baseUrl = apiType === 'spot'
        ? 'https://api.binance.com/api/v3'
        : 'https://fapi.binance.com/fapi/v1';

    const url = `${baseUrl}/${endpoint}?${query}`;
        try {
            const response = await fetch(url);
            if (!response.ok) {
                const errorText = await response.text();
                if (response.status === 403 || response.status === 404) { 
                    if (window.location.protocol === 'file:' || window.location.hostname.includes('github.io')) {
                        throw new Error(`Kesalahan Jaringan: Akses API Binance diblokir oleh kebijakan CORS browser dari origin ini (${window.location.origin}).`);
                    }
                }
                throw new Error(`Permintaan API Binance gagal: ${response.status} - ${errorText}`);
            }
            return response.json();
        } catch (error) {
            console.error(`Kesalahan Jaringan saat fetch ke Binance: ${error.message}`);
            throw new Error(`Kesalahan Jaringan: ${error.message}`); 
        }
}

// Fungsi untuk menampilkan pesan kustom (seperti alerts)
function showCustomMessage(message, type = 'info') {
    const messageBox = document.createElement('div');
    const color = type === 'error' ? 'bg-red-800' : 'bg-blue-800';
    messageBox.className = `fixed top-5 right-5 ${color} text-white p-4 rounded-lg shadow-lg z-50 transition-opacity duration-300`;
    messageBox.textContent = message;
    document.body.appendChild(messageBox);
    setTimeout(() => {
        messageBox.style.opacity = '0';
        setTimeout(() => messageBox.remove(), 300);
    }, 3000);
}

// Variabel global untuk menyimpan ID CoinGecko
let currentCoinGeckoId = null; 

// Fungsi untuk memetakan simbol Binance ke ID CoinGecko
async function getCoinGeckoId(assetSymbol) {
    const assetSymbolOnly = assetSymbol.replace('USDT', '').toLowerCase();
    const majorCoinMapping = { 'btc': 'bitcoin', 'eth': 'ethereum', 'sol': 'solana', 'bnb': 'binancecoin' };
    let coinId = majorCoinMapping[assetSymbolOnly];

    if (!coinId) {
        try {
            const coinListResponse = await fetch('https://api.coingecko.com/api/v3/coins/list');
            if (!coinListResponse.ok) throw new Error('Gagal mengambil daftar koin dari CoinGecko.');
            const coinList = await coinListResponse.json();
            const coin = coinList.find(c => c.symbol === assetSymbolOnly);
            if (coin) coinId = coin.id;
        } catch (e) {
            console.error("Gagal mengambil daftar koin dari CoinGecko:", e);
        }
    }
    return coinId;
}

// Referensi Elemen DOM (dideklarasikan satu kali secara global)
const apiKeyInput = document.getElementById('api-key-input');
const loader = document.getElementById('loader');
const loaderText = document.getElementById('loader-text');

// Elemen Proyeksi Harga
const proyeksiAssetInput = document.getElementById('proyeksi-asset-input');
const generateProyeksiBtn = document.getElementById('generate-proyeksi-btn');
const proyeksiPlaceholder = document.getElementById('proyeksi-placeholder');
const proyeksiLoader = document.getElementById('proyeksi-loader'); 
const proyeksiLoaderText = document.getElementById('proyeksi-loader-text'); 
const proyeksiDetailsOutput = document.getElementById('proyeksi-details-output'); 
const proyeksiLivePriceOutput = document.getElementById('proyeksi-live-price-output'); 
const projVolatilitas = document.getElementById('proj-volatilitas');
const projSentimen = document.getElementById('proj-sentimen');
const projVolume24h = document.getElementById('proj-volume-24h');
const projVolumePct = document.getElementById('proj-volume-pct');
const projOpenInterest = document.getElementById('proj-open-interest');
const projFundingRate = document.getElementById('proj-funding-rate');
const projLsUmum = document.getElementById('proj-ls-umum');
const projLsTop = document.getElementById('proj-ls-top');
const projOrderBookBias = document.getElementById('proj-order-book-bias'); 
const projOrderBookDominant = document.getElementById('proj-order-book-dominant'); 
const projIndicatorDetails = document.getElementById('proj-indicator-details');
const projKesimpulanIndikator = document.getElementById('proj-kesimpulan-indikator');
const projKesimpulanSmc = document.getElementById('proj-kesimpulan-smc');
const proyeksiLengkapOutput = document.getElementById('proyeksi-lengkap-output');
const projSaranPemilik = document.getElementById('proj-saran-pemilik');
const projAlasanPemilik = document.getElementById('proj-alasan-pemilik');
const projSaranNonPemilik = document.getElementById('proj-saran-non-pemilik');
const projAlasanNonPemilik = document.getElementById('proj-alasan-non-pemilik');

// Analisa Khusus BTC
const btcSpecialQuestionInput = document.getElementById('btc-special-question');
const askBtcBtn = document.getElementById('ask-btc-btn');
const btcSpecialLoader = document.getElementById('btc-special-loader');
const btcSpecialOutput = document.getElementById('btc-special-output');


document.addEventListener('DOMContentLoaded', () => {

    const toggleTradingViewBtn = document.getElementById('toggle-tradingview-btn');
    const tradingViewWidgetWrapper = document.getElementById('tradingview-widget-wrapper');
    const tradingViewToggleIcon = document.getElementById('tradingview-toggle-icon');

    // Set kondisi awal: tersembunyi. Icon disesuaikan dengan kondisi tersembunyi.
    tradingViewWidgetWrapper.style.maxHeight = '0px'; 
    tradingViewToggleIcon.style.transform = 'rotate(-90deg)'; // Arahkan panah ke bawah/samping saat tersembunyi

    toggleTradingViewBtn.addEventListener('click', () => {
        const isPanelOpen = tradingViewWidgetWrapper.style.maxHeight !== '0px';
        if (isPanelOpen) {
            tradingViewWidgetWrapper.style.maxHeight = '0';
            tradingViewToggleIcon.style.transform = 'rotate(-90deg)'; // Panah ke bawah/samping
        } else {
            // Untuk membuka, atur maxHeight ke scrollHeight agar transisi terlihat
            tradingViewWidgetWrapper.style.maxHeight = tradingViewWidgetWrapper.scrollHeight + 'px';
            tradingViewToggleIcon.style.transform = 'rotate(0deg)'; // Panah ke atas
        }
    });

    async function analyzeSpecialBTC() {
        const question = btcSpecialQuestionInput.value.trim();
        if (!question) {
            showCustomMessage("Harap masukkan pertanyaan Anda terlebih dahulu.", "error");
            return;
        }

        // Reset UI
        btcSpecialOutput.classList.add('hidden');
        btcSpecialOutput.textContent = '';
        btcSpecialLoader.classList.remove('hidden');
        askBtcBtn.disabled = true;

        try {
            const now = new Date();
            const currentTime = now.toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'long', timeZone: 'Asia/Jakarta' });

            // ENHANCED AI PROMPT FOR BTC MACRO ANALYSIS
            const prompt = `
                Anda adalah seorang analis makro-ekonomi khusus Bitcoin yang sangat berpengalaman. 
                Konteks waktu saat ini adalah ${currentTime}.

                Tugas Anda adalah menjawab pertanyaan pengguna tentang siklus Bitcoin. Gunakan seluruh pengetahuan Anda tentang data historis, **siklus halving, siklus bull/bear pasar kripto, dan model Stock-to-Flow** untuk memberikan jawaban yang mendalam dan berbobot.
                Fokus pada gambaran besar pasar, posisi BTC dalam siklus makronya, dan potensi pergerakan berdasarkan narasi siklus.
                
                Jawab dengan format paragraf yang jelas dan mudah dibaca dalam Bahasa Indonesia.

                Pertanyaan dari pengguna adalah: "${question}"
            `;

            const aiResponseText = await callGemini([{ text: prompt }], false); 
            
            // Gaya dasar untuk teks tebal (ganti **text** dengan <strong class="text-yellow-400">text</strong>)
            const styledResponse = aiResponseText.replace(/\*\*(.*?)\*\*/g, '<strong class="text-yellow-400">$1</strong>');
            btcSpecialOutput.innerHTML = styledResponse;
            btcSpecialOutput.classList.remove('hidden');

        } catch (error) {
            btcSpecialOutput.innerHTML = `<span class="text-red-400">Terjadi kesalahan: ${error.message}</span>`;
            btcSpecialOutput.classList.remove('hidden');
        } finally {
            btcSpecialLoader.classList.add('hidden');
            askBtcBtn.disabled = false;
        }
    }

    async function startPriceProjection() {
        const assetSymbol = proyeksiAssetInput.value.trim().toUpperCase();
        if (!assetSymbol) {
            showCustomMessage("Harap masukkan simbol aset kripto (contoh: BTCUSDT).", "error");
            return;
        }

        showLoader(`Mengambil data pasar untuk ${assetSymbol}...`, proyeksiLoader, proyeksiLoaderText);
        proyeksiDetailsOutput.classList.add('hidden');
        proyeksiPlaceholder.classList.add('hidden');
        
        // Tutup semua bagian yang bisa di-toggle
        document.querySelectorAll('.toggle-section-btn').forEach(button => {
            const targetId = button.dataset.target;
            const contentDiv = document.getElementById(targetId);
            const icon = button.querySelector('.toggle-icon');
            if (contentDiv && icon) {
                contentDiv.style.maxHeight = '0px';
                icon.style.transform = 'rotate(-90deg)';
            }
        });

        let coingeckoCoinData = null; // Menyimpan detail koin CoinGecko (untuk ATH/ATL, kategori, dll.)
        currentCoinGeckoId = await getCoinGeckoId(assetSymbol); // Perbarui ID CoinGecko global

        if (currentCoinGeckoId) {
            try {
                // Ambil data detail CoinGecko untuk ATH/ATL dan info fundamental
                const coinDataResponse = await fetch(`https://api.coingecko.com/api/v3/coins/${currentCoinGeckoId}?localization=false&tickers=false&market_data=true&community_data=false&developer_data=true`);
                if (!coinDataResponse.ok) throw new Error(`Gagal mengambil data detail CoinGecko: ${coinDataResponse.status}`);
                coingeckoCoinData = await coinDataResponse.json();
            } catch (e) {
                console.error("Gagal mengambil data detail CoinGecko:", e);
                // Lanjutkan tanpa data detail CoinGecko jika pengambilan gagal
            }
            
        } 

        try {
            const [
                priceTickerData, tickerData, fundingData, openInterestData, lsRatioUmumData,
                lsRatioTopTraderData, klines15m, klines1h, klines4h, klines1d,
                orderBookData
            ] = await Promise.all([
                fetchBinanceAPIData('ticker/price', { symbol: assetSymbol }, 'spot'),
                fetchBinanceAPIData('ticker/24hr', { symbol: assetSymbol }, 'spot'),
                fetchBinanceAPIData('premiumIndex', { symbol: assetSymbol }),
                fetchBinanceAPIData('openInterest', { symbol: assetSymbol }),
                fetch(`https://fapi.binance.com/futures/data/globalLongShortAccountRatio?symbol=${assetSymbol}&period=5m&limit=1`).then(res => res.json()),
                fetch(`https://fapi.binance.com/futures/data/topLongShortAccountRatio?symbol=${assetSymbol}&period=5m&limit=1`).then(res => res.json()),
                fetchBinanceAPIData('klines', { symbol: assetSymbol, interval: '15m', limit: 100 }, 'spot'),
                fetchBinanceAPIData('klines', { symbol: assetSymbol, interval: '1h', limit: 100 }, 'spot'),
                fetchBinanceAPIData('klines', { symbol: assetSymbol, interval: '4h', limit: 100 }, 'spot'),
                fetchBinanceAPIData('klines', { symbol: assetSymbol, interval: '1d', limit: 200 }, 'spot'), 
                fetchBinanceAPIData('depth', { symbol: assetSymbol, limit: 100 }, 'spot')
            ]);
            
            // Memproses data Order Book
            if (orderBookData && orderBookData.bids && orderBookData.asks) {
                const totalBidQty = orderBookData.bids.reduce((sum, bid) => sum + parseFloat(bid[1]), 0);
                const totalAskQty = orderBookData.asks.reduce((sum, ask) => sum + parseFloat(ask[1]), 0);
                
                let biasText = 'Netral';
                let dominantText = 'Seimbang';

                if (totalBidQty > totalAskQty * 1.2) {
                    biasText = 'Bullish (Permintaan > Penawaran)';
                    dominantText = `Dominan Bid`;
                } else if (totalAskQty > totalBidQty * 1.2) {
                    biasText = 'Bearish (Penawaran > Permintaan)';
                    dominantText = `Dominan Ask`;
                }
                
                document.getElementById('proj-order-book-bias').textContent = biasText;
                document.getElementById('proj-order-book-dominant').textContent = dominantText;
            } else {
                document.getElementById('proj-order-book-bias').textContent = 'Data tidak tersedia';
                document.getElementById('proj-order-book-dominant').textContent = 'Data tidak tersedia';
            }

            if (!priceTickerData || !priceTickerData.price) {
                throw new Error(`Gagal mengambil harga terkini untuk ${assetSymbol}. Pastikan simbol valid.`);
            }

            const hargaSaatAnalisa = parseFloat(priceTickerData.price);
            const precision = getPrecisionForAsset(hargaSaatAnalisa);
            let openInterestValueUSD = 'N/A'; 
            if (openInterestData && openInterestData.openInterest && hargaSaatAnalisa) {
                const openInterestInAsset = parseFloat(openInterestData.openInterest);
                const calculatedOI_USD = openInterestInAsset * hargaSaatAnalisa;
                openInterestValueUSD = calculatedOI_USD.toLocaleString('id-ID', { 
                    maximumFractionDigits: 0 
                });
            }
            proyeksiLivePriceOutput.textContent = `$${hargaSaatAnalisa.toFixed(precision)}`;
            document.getElementById('proyeksi-live-price-container').classList.remove('hidden');
            showLoader(`Menghitung indikator & menganalisa...`, proyeksiLoader, proyeksiLoaderText); // Fixed typo

            // Mengisi Ringkasan Harga Historis (ATH, ATL, Rentang)
            if (coingeckoCoinData && coingeckoCoinData.market_data) {
                document.getElementById('hist-24h-range').textContent = `$${coingeckoCoinData.market_data.low_24h?.usd?.toFixed(precision)} - $${coingeckoCoinData.market_data.high_24h?.usd?.toFixed(precision)}`;
                
                let sevenDayLow = Infinity;
                let sevenDayHigh = -Infinity;
                if (klines1d && klines1d.length >= 7) { // Menggunakan klines 1d untuk rentang 7 hari
                    const last7DaysKlines = klines1d.slice(-7);
                    last7DaysKlines.forEach(k => {
                        sevenDayLow = Math.min(sevenDayLow, parseFloat(k[3])); // k[3] adalah harga rendah
                        sevenDayHigh = Math.max(sevenDayHigh, parseFloat(k[2])); // k[2] adalah harga tinggi
                    });
                    document.getElementById('hist-7d-range').textContent = `$${sevenDayLow.toFixed(precision)} - $${sevenDayHigh.toFixed(precision)}`;
                } else {
                    document.getElementById('hist-7d-range').textContent = 'N/A (Data 7 hari tidak cukup)';
                }

                const athPrice = coingeckoCoinData.market_data.ath?.usd;
                const atlPrice = coingeckoCoinData.market_data.atl?.usd;
                const athDate = coingeckoCoinData.market_data.ath_date?.usd;
                const atlDate = coingeckoCoinData.market_data.atl_date?.usd;

                if (athPrice) {
                    document.getElementById('hist-ath').innerHTML = `$${athPrice.toFixed(precision)} <span class="text-gray-400">(${new Date(athDate).toLocaleDateString('id-ID')})</span>`;
                } else {
                    document.getElementById('hist-ath').textContent = 'N/A';
                }
                if (atlPrice) {
                    document.getElementById('hist-atl').innerHTML = `$${atlPrice.toFixed(precision)} <span class="text-gray-400">(${new Date(atlDate).toLocaleDateString('id-ID')})</span>`;
                } else {
                    document.getElementById('hist-atl').textContent = 'N/A';
                }
                document.getElementById('historical-price-summary').classList.remove('hidden'); // Pastikan terlihat
            } else {
                document.getElementById('historical-price-summary').classList.add('hidden'); // Sembunyikan jika tidak ada data
            }


            let fundamentalData = { kategori: 'N/A', dev_activity: 'N/A', tokenomics: 'N/A' };
            if (coingeckoCoinData) {
                fundamentalData.kategori = coingeckoCoinData.categories?.join(', ') || 'N/A';
                fundamentalData.dev_activity = `Commit 4 minggu: ${coingeckoCoinData.developer_data?.commit_count_4_weeks || 'N/A'}`;
                fundamentalData.tokenomics = `Pasokan Beredar: ${coingeckoCoinData.market_data?.circulating_supply?.toLocaleString() || 'N/A'}`;
            }

            const obvValues = calculateOBV(klines1d);
            const vwap20d = calculateVWAP(klines1d, 20);
            const vwapStatus = hargaSaatAnalisa > vwap20d ? 'Di Atas VWAP' : 'Di Bawah VWAP';
            const obvTrend = obvValues.length > 1 && obvValues[obvValues.length-1] > obvValues[obvValues.length-2] ? 'Naik' : 'Turun';
            
            const timeframes = { '15 Menit': klines15m, '1 Jam': klines1h, '4 Jam': klines4h, '1 Hari': klines1d };
            let indicatorDataForAI = {};

            for (const tfName in timeframes) {
                const klines = timeframes[tfName];
                if (klines && klines.length > 50) { // Pastikan ada cukup data untuk perhitungan indikator
                    const closes = klines.map(k => parseFloat(k[4]));
                    const ema50Values = calculateEMA(closes, 50);
                    const ema50 = ema50Values.length > 0 ? ema50Values.pop() : 0;
                    const bb = calculateBollingerBands(closes, 20, 2);
                    const rsi = parseFloat(calculateRSI(closes)) || 0; 
                    const adxData = calculateADX(klines, 14); // Hitung ADX

                    if (bb && bb.upper !== undefined && ema50 > 0) { // Pastikan BB dan EMA terhitung dengan baik
                        indicatorDataForAI[tfName] = {
                            rsi: rsi.toFixed(2),
                            ema50: ema50.toFixed(precision),
                            bollinger_bands: { upper: bb.upper.toFixed(precision), middle: bb.middle.toFixed(precision), lower: bb.lower.toFixed(precision) },
                            adx: adxData.adx !== 'N/A' ? adxData.adx.toFixed(2) : 'N/A',
                            plusDI: adxData.plusDI !== 'N/A' ? adxData.plusDI.toFixed(2) : 'N/A',
                            minusDI: adxData.minusDI !== 'N/A' ? adxData.minusDI.toFixed(2) : 'N/A'
                        };
                    } else {
                        // Jika ada masalah dengan BB atau EMA, set indikator lain ke N/A juga untuk konsistensi
                        indicatorDataForAI[tfName] = {
                            rsi: rsi.toFixed(2),
                            ema50: 'N/A',
                            bollinger_bands: { upper: 'N/A', middle: 'N/A', lower: 'N/A' },
                            adx: 'N/A',
                            plusDI: 'N/A',
                            minusDI: 'N/A'
                        };
                    }
                } else {
                    // Jika klines tidak cukup, semua indikator untuk timeframe ini N/A
                    indicatorDataForAI[tfName] = {
                        rsi: 'N/A',
                        ema50: 'N/A',
                        bollinger_bands: { upper: 'N/A', middle: 'N/A', lower: 'N/A' },
                        adx: 'N/A',
                        plusDI: 'N/A',
                        minusDI: 'N/A'
                    };
                }
            }
            
            const otherMarketData = {
                hargaSaatIni: hargaSaatAnalisa.toFixed(precision),
                vwapStatus: `${vwapStatus} (${vwap20d.toFixed(precision)})`,
                obvTrend: obvTrend, ...fundamentalData,
                volume24h: tickerData ? parseFloat(tickerData.quoteVolume).toLocaleString('id-ID', { maximumFractionDigits: 0 }) : 'N/A',
                openInterest: openInterestValueUSD,
                lsRatioUmum: lsRatioUmumData?.[0]?.longShortRatio ? parseFloat(lsRatioUmumData[0].longShortRatio).toFixed(2) : 'N/A',
                // FIX: Menggunakan properti yang benar untuk Top Long/Short Ratio
                lsRatioTopTrader: lsRatioTopTraderData?.[0]?.longShortRatio ? parseFloat(lsRatioTopTraderData[0].longShortRatio).toFixed(2) : 'N/A', 
                fundingRate: fundingData ? (parseFloat(fundingData.lastFundingRate) * 100).toFixed(4) + '%' : 'N/A',
            };

            const prompt = `
            Analisa data pasar dan indikator kuantitatif yang disediakan untuk aset kripto ini.
            Seluruh output Anda WAJIB berupa satu objek JSON valid dalam Bahasa Indonesia yang sesuai dengan skema di bawah.
            Lakukan analisa kualitatif yang mendalam berdasarkan data kuantitatif yang diberikan.

            DATA PASAR & FUNDAMENTAL SAAT INI:
            ${JSON.stringify(otherMarketData, null, 2)}

            DATA INDIKATOR AKURAT PER TIMEFRAME:
            ${JSON.stringify(indicatorDataForAI, null, 2)}

            INSTRUKSI UTAMA:
            Berdasarkan SEMUA data di atas, berikan jawaban HANYA dalam format JSON valid di bawah ini.

            {
                "analisa_kondisi_saat_ini": {
                    "volatilitas": "string", "sentimen_keseluruhan": "string",
                    "detail_indikator_per_timeframe": [
                        { 
                            "timeframe": "string", 
                            "rsi_analisa": "string", 
                            "ema50_analisa": "string", 
                            "bollinger_bands_analisa": "string",
                            "adx_analisa": "string (Analisa kekuatan tren berdasarkan ADX)",
                            "plus_di_analisa": "string (Analisa arah tren naik berdasarkan +DI)",
                            "minus_di_analisa": "string (Analisa arah tren turun berdasarkan -DI)"
                        }
                    ], 
                    "kesimpulan_indikator": "string"
                },
                "analisa_smc": {
                    "market_structure_narrative": "string (Jelaskan narasi struktur pasar saat ini. Apakah ada BOS/CHoCH? Di mana kemungkinan area inducement berikutnya?)",
                    "potential_poi_bullish": "string (Sebutkan TIPE zona POI bullish terdekat. Contoh: 'Order block H4 di support sebelumnya' atau 'Fair Value Gap M15 yang belum termitigasi'.)",
                    "potential_poi_bearish": "string (Sebutkan TIPE zona POI bearish terdekat. Contoh: 'Supply zone H1 setelah liquidity grab'.)",
                    "kesimpulan_smc": "string (Simpulkan bias trading jangka pendek berdasarkan narasi SMC.)"
                },
                "proyeksi_lengkap": [
                    { "periode": "Sangat Pendek (24-48 jam)", "target_harga": "string", "alasan": "string (Fokus pada price action dan likuiditas terdekat)" },
                    { "periode": "Jangka Pendek (1-7 hari)", "target_harga": "string", "alasan": "string" },
                    { "periode": "Jangka Menengah (1-4 minggu)", "target_harga": "string", "alasan": "string" },
                    { "periode": "Jangka Panjang (6-12 bulan)", "target_harga": "string", "alasan": "string (Hubungkan dengan narasi makro)" },
                    { "periode": "Siklus Makro (1-3 tahun)", "target_harga": "string", "alasan": "string (Hubungkan dengan siklus halving atau adopsi besar)" }
                ],
                "saran_bagi_non_pemilik": "string (Pilih salah satu: BELI SEKARANG, TUNGGU DI AREA, JANGAN MASUK)", 
                "alasan_saran_non_pemilik": "string (Jelaskan alasan teknikal untuk saran di atas. Jika menyebutkan harga, WAJIB gunakan simbol '$'. JANGAN gunakan format Markdown seperti '**'. Jika TUNGGU, berikan rentang harga ideal.)",
                "saran_bagi_pemilik_aset": "string (Pilih salah satu: TAHAN, JUAL, TAMBAH, KURANGI SEBAGIAN)", 
                "alasan_saran_pemilik": "string (Jelaskan alasan teknikal untuk saran di atas. Jika menyebutkan harga, WAJIB gunakan simbol '$'. JANGAN gunakan format Markdown seperti '**'. Jika TUNGGU, berikan rentang harga ideal.)"
            }`;
            
            const jsonText = await callGemini([{ text: prompt }], true);
            const data = cleanAndParseJson(jsonText);
            
            projVolatilitas.textContent = data.analisa_kondisi_saat_ini.volatilitas || '-';
            projSentimen.textContent = data.analisa_kondisi_saat_ini.sentimen_keseluruhan || '-';
            projVolume24h.textContent = otherMarketData.volume24h + ' USD';
            const priceChangePct = tickerData ? parseFloat(tickerData.priceChangePercent) : 0;
            projVolumePct.textContent = `(${priceChangePct.toFixed(2)}%)`;
            projVolumePct.className = `text-xs ${priceChangePct < 0 ? 'text-red-400' : 'text-green-400'}`;
            projOpenInterest.textContent = otherMarketData.openInterest + ' USD';
            projFundingRate.textContent = otherMarketData.fundingRate;
            projLsUmum.textContent = otherMarketData.lsRatioUmum;
            projLsTop.textContent = otherMarketData.lsRatioTopTrader;
            document.getElementById('proj-vwap-status').textContent = otherMarketData.vwapStatus;
            document.getElementById('proj-obv-trend').textContent = otherMarketData.obvTrend;
            document.getElementById('proj-kategori').textContent = otherMarketData.kategori;
            document.getElementById('proj-dev-activity').textContent = otherMarketData.dev_activity;
            document.getElementById('proj-tokenomics').textContent = otherMarketData.tokenomics;
            
            let indicatorHtml = '';
            (data.analisa_kondisi_saat_ini.detail_indikator_per_timeframe || []).forEach(item => {
                const tfName = item.timeframe;
                const calculatedData = indicatorDataForAI[tfName];
                if (calculatedData) {
                    const rsiVal = calculatedData.rsi || '?'; 
                    const emaVal = calculatedData.ema50 || '?'; 
                    const bbVal = calculatedData.bollinger_bands || {};
                    const adxVal = calculatedData.adx || '?';
                    const plusDIVal = calculatedData.plusDI || '?';
                    const minusDIVal = calculatedData.minusDI || '?';

                    indicatorHtml += `<div class="mb-4"><h5 class="font-bold text-blue-400">${tfName}</h5><div class="text-sm pl-2 space-y-1 mt-1">
                        <p><span class="font-semibold">RSI:</span> ${rsiVal} - ${item.rsi_analisa || 'N/A'}</p>
                        <p><span class="font-semibold">EMA 50:</span> ${emaVal} - ${item.ema50_analisa || 'N/A'}</p>
                        <p><span class="font-semibold">Bollinger Bands:</span> ${item.bollinger_bands_analisa || 'N/A'}<span class="text-xs text-gray-400 ml-1">(U: ${bbVal.upper || '?'}, M: ${bbVal.middle || '?'}, L: ${bbVal.lower || '?'})</span></p>
                        <p><span class="font-semibold">ADX:</span> ${adxVal} - ${item.adx_analisa || 'N/A'}</p>
                        <p><span class="font-semibold">+DI:</span> ${plusDIVal} - ${item.plus_di_analisa || 'N/A'}</p>
                        <p><span class="font-semibold">-DI:</span> ${minusDIVal} - ${item.minus_di_analisa || 'N/A'}</p>
                    </div></div>`;
                }
            });
            projIndicatorDetails.innerHTML = indicatorHtml || '<p class="text-gray-500">Gagal menghitung data indikator.</p>';
            projKesimpulanIndikator.textContent = data.analisa_kondisi_saat_ini.kesimpulan_indikator || '-';

            document.getElementById('proj-smc-narrative').textContent = data.analisa_smc.market_structure_narrative || '-';
            document.getElementById('proj-smc-poi-bullish').textContent = data.analisa_smc.potential_poi_bullish || '-';
            document.getElementById('proj-smc-poi-bearish').textContent = data.analisa_smc.potential_poi_bearish || '-';
            document.getElementById('proj-kesimpulan-smc').textContent = data.analisa_smc.kesimpulan_smc || '-';

            let proyeksiHtml = '';
            (data.proyeksi_lengkap || []).forEach(p => {
                proyeksiHtml += `<div class="bg-gray-800 p-4 rounded-lg flex flex-col justify-between"><div><h5 class="font-regular text-blue-400">${p.periode}</h5><p class="text-lg font-regular text-white">${p.target_harga}</p><p class="text-sm text-gray-300 mt-1">${p.alasan}</p></div><button class="use-projection-btn mt-3" data-price="${(p.target_harga || '0').match(/[\d.]+/)[0]}">Gunakan di Kalkulator</button></div>`;
            });
            proyeksiLengkapOutput.innerHTML = proyeksiHtml || '<p class="text-gray-500">Tidak ada proyeksi harga.</p>';

            const getSaranColor = (saran) => {
                if (saran.includes('JUAL') || saran.includes('KURANGI')) return 'text-red-400';
                if (saran.includes('BELI') || saran.includes('TAMBAH')) return 'text-green-400';
                return 'text-yellow-400';
            };
            projSaranPemilik.textContent = data.saran_bagi_pemilik_aset || '-';
            projSaranPemilik.className = `font-regular text-base ${getSaranColor(data.saran_bagi_pemilik_aset || '')}`;
            projAlasanPemilik.textContent = data.alasan_saran_pemilik || '-';
            projSaranNonPemilik.textContent = data.saran_bagi_non_pemilik || '-';
            projSaranNonPemilik.className = `font-regular text-base ${getSaranColor(data.saran_bagi_non_pemilik || '')}`;
            const alasanText = data.alasan_saran_non_pemilik || '-';
            const priceRegex = /\$[\d,.-]+(?:\s*-\s*\$[\d,.-]+)?/g;
            const styledAlasan = alasanText.replace(priceRegex, (match) => {
                return `<span class="font-bold text-green-400">${match}</span>`;
            });

            projAlasanNonPemilik.innerHTML = styledAlasan;
            proyeksiDetailsOutput.classList.remove('hidden');
            expandFirstProyeksiSection();

            } catch (error) {
                const errorContainer = document.getElementById('proyeksi-error-container');
                errorContainer.textContent = `Gagal menganalisa proyeksi harga: ${error.message}`;
                proyeksiDetailsOutput.innerHTML = `<p class="text-red-400">Gagal menganalisa proyeksi harga: ${error.message}</p>`;
                proyeksiDetailsOutput.classList.remove('hidden');
            } finally {
                hideLoader(proyeksiLoader);
            }
    }

    // --- INISIALISASI EVENT LISTENERS ---
    const toggleApikeyBtn = document.getElementById('toggle-apikey-btn');
    const apikeyContent = document.getElementById('apikey-content');
    const toggleApikeyIcon = document.getElementById('toggle-apikey-icon');

    // Atur panel API Key agar tertutup saat dimuat pertama kali
    apikeyContent.style.maxHeight = '0px';

    toggleApikeyBtn.addEventListener('click', () => {
        const isPanelOpen = apikeyContent.style.maxHeight !== '0px';
        if (isPanelOpen) {
            apikeyContent.style.maxHeight = '0';
            toggleApikeyIcon.style.transform = 'rotate(-90deg)';
        } else {
            apikeyContent.style.maxHeight = apikeyContent.scrollHeight + 'px';
            toggleApikeyIcon.style.transform = 'rotate(0deg)';
        }
    });

    apiKeyInput.addEventListener('input', () => {
        localStorage.setItem('valhallaUltimateApiKey', apiKeyInput.value);
    });
    
    // Logika untuk pergantian tab, dimodifikasi untuk hanya menampilkan tab 'proyeksi'.
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
            button.classList.add('active');
            const tabId = button.getAttribute('data-tab');
            const tabPane = document.getElementById(tabId);
            if (tabPane) {
                tabPane.classList.remove('hidden');
            } else {
                console.error(`Error: Tab pane with ID '${tabId}' not found.`);
                showCustomMessage(`Kesalahan: Tab '${tabId}' tidak ditemukan. Mohon periksa struktur HTML.`, 'error');
            }
        });
    });

    generateProyeksiBtn.addEventListener('click', startPriceProjection);
    askBtcBtn.addEventListener('click', analyzeSpecialBTC);
    
    // Event listener untuk tombol rentang chart historis (DIHAPUS KARENA CHART TELAH DIHAPUS)
    /*
    const chartRangeButtons = document.querySelectorAll('.chart-range-btn');
    chartRangeButtons.forEach(button => {
        button.addEventListener('click', async () => {
            chartRangeButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            const days = button.dataset.days;
            const assetSymbol = proyeksiAssetInput.value.trim().toUpperCase();
            
            if (currentCoinGeckoId) { // Gunakan ID CoinGecko yang tersimpan secara global
                await renderHistoricalChart(currentCoinGeckoId, days, assetSymbol);
            } else {
                 document.getElementById('historical-price-chart').innerHTML = `<p class="text-red-400 text-center">Tidak dapat memuat chart. ID CoinGecko belum ditemukan untuk ${assetSymbol}. Mohon klik 'START' terlebih dahulu.</p>`;
            }
        });
    });
    */


    proyeksiDetailsOutput.addEventListener('click', (e) => {
        // Fungsionalitas tombol ini sekarang hanya untuk tujuan demonstrasi,
        // karena tab kalkulator telah dihapus.
        if (e.target.classList.contains('use-projection-btn')) {
            const price = e.target.dataset.price;
            if (price) {
                showCustomMessage(`Fungsionalitas "Gunakan di Kalkulator" dinonaktifkan karena tab kalkulator telah dihapus. Harga: $${parseFloat(price).toFixed(getPrecisionForAsset(parseFloat(price)))}`, 'info');
            }
        }
    });

    document.querySelectorAll('.toggle-section-btn').forEach(button => {
        button.addEventListener('click', () => {
            const targetId = button.dataset.target;
            const contentDiv = document.getElementById(targetId);
            const icon = button.querySelector('.toggle-icon');

            if (contentDiv && icon) {
                if (contentDiv.style.maxHeight === '0px' || contentDiv.style.maxHeight === '') {
                    contentDiv.style.maxHeight = contentDiv.scrollHeight + 'px';
                    icon.style.transform = 'rotate(0deg)';
                } else {
                    contentDiv.style.maxHeight = '0px';
                    icon.style.transform = 'rotate(-90deg)'; 
                }
            } else {
                console.error(`Error: Toggle target '${targetId}' or its icon not found.`);
            }
        });
    });

    function expandFirstProyeksiSection() {
        const firstToggleBtn = document.querySelector('#proyeksi-details-output .toggle-section-btn');
        if (firstToggleBtn) {
            const targetId = firstToggleBtn.dataset.target;
            const contentDiv = document.getElementById(targetId);
            const icon = firstToggleBtn.querySelector('.toggle-icon');
            
        if (contentDiv && icon) {
            setTimeout(() => {
                contentDiv.style.maxHeight = contentDiv.scrollHeight + 'px';
                icon.style.transform = 'rotate(0deg)';
                }, 100);
            } else {
                console.error(`Error: First toggle button target '${targetId}' or its icon not found.`);
            }
            
        }
    }
    
    // --- PENGATURAN AWAL ---
    const savedApiKey = localStorage.getItem('valhallaUltimateApiKey');
    if (savedApiKey) apiKeyInput.value = savedApiKey;
    
    // Atur tab 'proyeksi' sebagai aktif secara default
    document.querySelector('.tab-button[data-tab="proyeksi"]').click();
});
</script>
</body>
</html>
